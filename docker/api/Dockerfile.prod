# docker/api/Dockerfile.prod
# Production-ready Dockerfile for the TrafficJamz backend

# ─── Base Image ─────────────────────────────────────────────────────────
FROM node:20-alpine

# 📁 Define working directory
WORKDIR /app

# 🧰 Install native build tools required for node modules with C bindings
RUN apk add --no-cache \
  python3 \
  py3-pip \
  make \
  g++ \
  linux-headers \
  curl

# 📦 Copy only package manifest files to leverage Docker layer caching
COPY jamz-server/package*.json ./

# 🔧 Install production-only dependencies to reduce image size
RUN npm install --omit=dev

# 🚚 Copy application code and shared logic after dependencies
COPY jamz-server/src ./src
COPY jamz-server/public ./public
COPY shared ./shared

# 🌱 Set runtime environment variable
ENV NODE_ENV=production

# 🔥 Start the backend server via NPM (can swap for entrypoint if needed)
CMD ["npm", "start"]
