# ============================================================================
# nginx.conf for TrafficJamz Production
#
# Purpose:
#   - Serve the built React frontend (from /usr/share/nginx/html).
#   - Proxy API requests from /api/* to the backend service (trafficjamz-server).
#   - Ensure there is no "api/api" duplication by stripping the /api prefix
#     before forwarding to the backend.
#
# Key Notes:
#   - Frontend is built into dist/ and copied into /usr/share/nginx/html.
#   - All /api/* requests are proxied to the backend container on port 5000.
#   - React Router fallback: any non-API path returns index.html.
#   - Includes basic security headers and gzip.
# ============================================================================

worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # Enable gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript application/xml+rss application/xml image/svg+xml;

    server {
        listen 80;
        server_name _;

        # ------------------------------
        # Serve static frontend files
        # ------------------------------
        root /usr/share/nginx/html;
        index index.html;

        # ------------------------------
        # Proxy API requests
        # ------------------------------
        location /api/ {
            # Forward to backend service (preserve the full original URI)
            # NOTE: leaving out the trailing slash prevents nginx from stripping
            # the matched prefix. This ensures requests like /api/auth/login
            # are forwarded as /api/auth/login (not /auth/login), matching
            # how routes are mounted in the Express app (app.use('/api/auth', ...)).
            proxy_pass http://trafficjamz-server:5000;

            # Preserve headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ------------------------------
        # React Router fallback
        # ------------------------------
        location / {
            try_files $uri /index.html;
        }
    }
}
