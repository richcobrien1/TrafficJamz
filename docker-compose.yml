# //docker-compose.yml


# This is a Docker Compose file for a Node.js application with a backend and frontend service.
# It defines the services, their build configurations, environment variables, ports, and health checks.

services:
  backend:
    build:
      context: .                                # Expanded context to project root
      dockerfile: ./docker/api/Dockerfile.prod
    environment:
      - NODE_ENV=production
      - PORT=5000
      - IS_LOCAL=false
    env_file:
      - ./jamz-server/.env.local  
    ports:
      - "${TRAFFICJAMZ_BACKEND_PORT:-5000}:5000"
    restart: unless-stopped
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/status"]
      interval: 10s
      timeout: 5s
      retries: 3

  frontend:
    build:
      context: .                              # Build context is repo root (was .. which caused wrong path)
      dockerfile: docker/frontend/Dockerfile.prod  # Points to frontendâ€™s production Dockerfile
    environment:
      - NODE_ENV=production
      - IS_LOCAL=false
      - VITE_API_BASE=http://backend:5000/api
    ports:
      - "${TRAFFICJAMZ_FRONTEND_PROD_PORT:-8080}:80"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
