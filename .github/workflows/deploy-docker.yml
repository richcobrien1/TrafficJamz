name: Deploy to DigitalOcean Docker

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy Backend to DigitalOcean
    runs-on: ubuntu-latest
    # Only deploy after successful build (if build-and-push workflow ran)
    steps:
      - name: Deploy to DigitalOcean via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸš€ Deploying TrafficJamz backend..."
            
            # Navigate to project directory
            cd /root/TrafficJamz || { echo "âŒ Project directory not found"; exit 1; }
            
            # Pull latest code
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git pull origin main
            
            # Restart backend container
            echo "ğŸ”„ Restarting backend container..."
            docker restart trafficjamz
            
            # Wait for container to stabilize
            echo "â³ Waiting for container to stabilize..."
            sleep 5
            
            # Check container status
            echo "âœ… Checking container status..."
            docker ps | grep trafficjamz
            
            # Show recent logs
            echo "ğŸ“‹ Recent logs:"
            docker logs --tail=30 trafficjamz
            
            echo "âœ… Deployment complete!"
      
      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ” Verifying backend health..."
            
            # Check if container is running
            if docker ps | grep -q trafficjamz; then
              echo "âœ… Container is running"
            else
              echo "âŒ Container is not running!"
              exit 1
            fi
            
            # Wait for health check
            sleep 3
            
            # Test backend endpoint
            if curl -sSf http://localhost:5050/api/status > /dev/null 2>&1; then
              echo "âœ… Backend health check passed"
            else
              echo "âš ï¸ Backend health check failed (might still be starting)"
            fi
