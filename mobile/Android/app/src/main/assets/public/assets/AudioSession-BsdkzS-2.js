var qn=Object.defineProperty;var Ur=r=>{throw TypeError(r)};var Gn=(r,s,e)=>s in r?qn(r,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[s]=e;var u=(r,s,e)=>Gn(r,typeof s!="symbol"?s+"":s,e),Vr=(r,s,e)=>s.has(r)||Ur("Cannot "+e);var M=(r,s,e)=>(Vr(r,s,"read from private field"),e?e.call(r):s.get(r)),K=(r,s,e)=>s.has(r)?Ur("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(r):s.set(r,e),V=(r,s,e,t)=>(Vr(r,s,"write to private field"),t?t.call(r,e):s.set(r,e),e);import{j as g,h as Hn,a as Wn,u as Kn,r as O,i as Wt,R as Qn}from"./index-C_3tyMlA.js";import{C as qr}from"./Container-BLhiYW-S.js";import{T as ne,P as kt,B as ee}from"./Box-B7n4D01-.js";import{A as Jn,T as Yn,L as Gr,a as Hr,D as Xn}from"./Toolbar-C16-zNA2.js";import{c as hr,I as Gs,B as Pe,C as Kt,L as Zn}from"./List-K2ODHGaJ.js";import{A as eo}from"./ArrowBack-CbxRKbGl.js";import{L as to,M as Qt}from"./Mic-DmEc21pb.js";import{A as Hs}from"./Grow-5OE428Pa.js";import{G as Jt}from"./Grid-CyXsRVxX.js";import{T as so,F as ro,S as Wr}from"./Tooltip-Awt_KCTI.js";import{S as io}from"./Switch-CUqeLwf6.js";import{L as no}from"./ListItemAvatar-mpGPWVKz.js";import{A as oo}from"./Avatar-CTdIBAVi.js";import{G as ao}from"./Group-D4Q33rLV.js";import{D as co,a as lo,b as po,c as uo}from"./DialogTitle-CyEuKmcp.js";const ho=hr(g.jsx("path",{d:"M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28m-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18zM4.27 3 3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.54-.9L19.73 21 21 19.73z"})),Kr=hr(g.jsx("path",{d:"M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02M5 9v6h4l5 5V4L9 9z"})),Qr=hr(g.jsx("path",{d:"M3 9v6h4l5 5V4L7 9zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02M14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77"})),Re=Object.create(null);Re.open="0";Re.close="1";Re.ping="2";Re.pong="3";Re.message="4";Re.upgrade="5";Re.noop="6";const cs=Object.create(null);Object.keys(Re).forEach(r=>{cs[Re[r]]=r});const ir={type:"error",data:"parser error"},Mi=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",Oi=typeof ArrayBuffer=="function",Ai=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r&&r.buffer instanceof ArrayBuffer,fr=({type:r,data:s},e,t)=>Mi&&s instanceof Blob?e?t(s):Jr(s,t):Oi&&(s instanceof ArrayBuffer||Ai(s))?e?t(s):Jr(new Blob([s]),t):t(Re[r]+(s||"")),Jr=(r,s)=>{const e=new FileReader;return e.onload=function(){const t=e.result.split(",")[1];s("b"+(t||""))},e.readAsDataURL(r)};function Yr(r){return r instanceof Uint8Array?r:r instanceof ArrayBuffer?new Uint8Array(r):new Uint8Array(r.buffer,r.byteOffset,r.byteLength)}let Ws;function fo(r,s){if(Mi&&r.data instanceof Blob)return r.data.arrayBuffer().then(Yr).then(s);if(Oi&&(r.data instanceof ArrayBuffer||Ai(r.data)))return s(Yr(r.data));fr(r,!1,e=>{Ws||(Ws=new TextEncoder),s(Ws.encode(e))})}const Xr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",jt=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let r=0;r<Xr.length;r++)jt[Xr.charCodeAt(r)]=r;const mo=r=>{let s=r.length*.75,e=r.length,t,i=0,n,o,a,c;r[r.length-1]==="="&&(s--,r[r.length-2]==="="&&s--);const l=new ArrayBuffer(s),d=new Uint8Array(l);for(t=0;t<e;t+=4)n=jt[r.charCodeAt(t)],o=jt[r.charCodeAt(t+1)],a=jt[r.charCodeAt(t+2)],c=jt[r.charCodeAt(t+3)],d[i++]=n<<2|o>>4,d[i++]=(o&15)<<4|a>>2,d[i++]=(a&3)<<6|c&63;return l},go=typeof ArrayBuffer=="function",mr=(r,s)=>{if(typeof r!="string")return{type:"message",data:Ni(r,s)};const e=r.charAt(0);return e==="b"?{type:"message",data:_o(r.substring(1),s)}:cs[e]?r.length>1?{type:cs[e],data:r.substring(1)}:{type:cs[e]}:ir},_o=(r,s)=>{if(go){const e=mo(r);return Ni(e,s)}else return{base64:!0,data:r}},Ni=(r,s)=>{switch(s){case"blob":return r instanceof Blob?r:new Blob([r]);case"arraybuffer":default:return r instanceof ArrayBuffer?r:r.buffer}},ji="",vo=(r,s)=>{const e=r.length,t=new Array(e);let i=0;r.forEach((n,o)=>{fr(n,!1,a=>{t[o]=a,++i===e&&s(t.join(ji))})})},yo=(r,s)=>{const e=r.split(ji),t=[];for(let i=0;i<e.length;i++){const n=mr(e[i],s);if(t.push(n),n.type==="error")break}return t};function wo(){return new TransformStream({transform(r,s){fo(r,e=>{const t=e.length;let i;if(t<126)i=new Uint8Array(1),new DataView(i.buffer).setUint8(0,t);else if(t<65536){i=new Uint8Array(3);const n=new DataView(i.buffer);n.setUint8(0,126),n.setUint16(1,t)}else{i=new Uint8Array(9);const n=new DataView(i.buffer);n.setUint8(0,127),n.setBigUint64(1,BigInt(t))}r.data&&typeof r.data!="string"&&(i[0]|=128),s.enqueue(i),s.enqueue(e)})}})}let Ks;function Yt(r){return r.reduce((s,e)=>s+e.length,0)}function Xt(r,s){if(r[0].length===s)return r.shift();const e=new Uint8Array(s);let t=0;for(let i=0;i<s;i++)e[i]=r[0][t++],t===r[0].length&&(r.shift(),t=0);return r.length&&t<r[0].length&&(r[0]=r[0].slice(t)),e}function bo(r,s){Ks||(Ks=new TextDecoder);const e=[];let t=0,i=-1,n=!1;return new TransformStream({transform(o,a){for(e.push(o);;){if(t===0){if(Yt(e)<1)break;const c=Xt(e,1);n=(c[0]&128)===128,i=c[0]&127,i<126?t=3:i===126?t=1:t=2}else if(t===1){if(Yt(e)<2)break;const c=Xt(e,2);i=new DataView(c.buffer,c.byteOffset,c.length).getUint16(0),t=3}else if(t===2){if(Yt(e)<8)break;const c=Xt(e,8),l=new DataView(c.buffer,c.byteOffset,c.length),d=l.getUint32(0);if(d>Math.pow(2,21)-1){a.enqueue(ir);break}i=d*Math.pow(2,32)+l.getUint32(4),t=3}else{if(Yt(e)<i)break;const c=Xt(e,i);a.enqueue(mr(n?c:Ks.decode(c),s)),t=0}if(i===0||i>r){a.enqueue(ir);break}}}})}const Fi=4;function H(r){if(r)return So(r)}function So(r){for(var s in H.prototype)r[s]=H.prototype[s];return r}H.prototype.on=H.prototype.addEventListener=function(r,s){return this._callbacks=this._callbacks||{},(this._callbacks["$"+r]=this._callbacks["$"+r]||[]).push(s),this};H.prototype.once=function(r,s){function e(){this.off(r,e),s.apply(this,arguments)}return e.fn=s,this.on(r,e),this};H.prototype.off=H.prototype.removeListener=H.prototype.removeAllListeners=H.prototype.removeEventListener=function(r,s){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var e=this._callbacks["$"+r];if(!e)return this;if(arguments.length==1)return delete this._callbacks["$"+r],this;for(var t,i=0;i<e.length;i++)if(t=e[i],t===s||t.fn===s){e.splice(i,1);break}return e.length===0&&delete this._callbacks["$"+r],this};H.prototype.emit=function(r){this._callbacks=this._callbacks||{};for(var s=new Array(arguments.length-1),e=this._callbacks["$"+r],t=1;t<arguments.length;t++)s[t-1]=arguments[t];if(e){e=e.slice(0);for(var t=0,i=e.length;t<i;++t)e[t].apply(this,s)}return this};H.prototype.emitReserved=H.prototype.emit;H.prototype.listeners=function(r){return this._callbacks=this._callbacks||{},this._callbacks["$"+r]||[]};H.prototype.hasListeners=function(r){return!!this.listeners(r).length};const fs=typeof Promise=="function"&&typeof Promise.resolve=="function"?s=>Promise.resolve().then(s):(s,e)=>e(s,0),de=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),Co="arraybuffer";function $i(r,...s){return s.reduce((e,t)=>(r.hasOwnProperty(t)&&(e[t]=r[t]),e),{})}const Ro=de.setTimeout,Eo=de.clearTimeout;function ms(r,s){s.useNativeTimers?(r.setTimeoutFn=Ro.bind(de),r.clearTimeoutFn=Eo.bind(de)):(r.setTimeoutFn=de.setTimeout.bind(de),r.clearTimeoutFn=de.clearTimeout.bind(de))}const To=1.33;function ko(r){return typeof r=="string"?xo(r):Math.ceil((r.byteLength||r.size)*To)}function xo(r){let s=0,e=0;for(let t=0,i=r.length;t<i;t++)s=r.charCodeAt(t),s<128?e+=1:s<2048?e+=2:s<55296||s>=57344?e+=3:(t++,e+=4);return e}function Bi(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function Do(r){let s="";for(let e in r)r.hasOwnProperty(e)&&(s.length&&(s+="&"),s+=encodeURIComponent(e)+"="+encodeURIComponent(r[e]));return s}function Po(r){let s={},e=r.split("&");for(let t=0,i=e.length;t<i;t++){let n=e[t].split("=");s[decodeURIComponent(n[0])]=decodeURIComponent(n[1])}return s}class Lo extends Error{constructor(s,e,t){super(s),this.description=e,this.context=t,this.type="TransportError"}}let gr=class extends H{constructor(s){super(),this.writable=!1,ms(this,s),this.opts=s,this.query=s.query,this.socket=s.socket,this.supportsBinary=!s.forceBase64}onError(s,e,t){return super.emitReserved("error",new Lo(s,e,t)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(s){this.readyState==="open"&&this.write(s)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(s){const e=mr(s,this.socket.binaryType);this.onPacket(e)}onPacket(s){super.emitReserved("packet",s)}onClose(s){this.readyState="closed",super.emitReserved("close",s)}pause(s){}createUri(s,e={}){return s+"://"+this._hostname()+this._port()+this.opts.path+this._query(e)}_hostname(){const s=this.opts.hostname;return s.indexOf(":")===-1?s:"["+s+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(s){const e=Do(s);return e.length?"?"+e:""}};class Io extends gr{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(s){this.readyState="pausing";const e=()=>{this.readyState="paused",s()};if(this._polling||!this.writable){let t=0;this._polling&&(t++,this.once("pollComplete",function(){--t||e()})),this.writable||(t++,this.once("drain",function(){--t||e()}))}else e()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(s){const e=t=>{if(this.readyState==="opening"&&t.type==="open"&&this.onOpen(),t.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(t)};yo(s,this.socket.binaryType).forEach(e),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const s=()=>{this.write([{type:"close"}])};this.readyState==="open"?s():this.once("open",s)}write(s){this.writable=!1,vo(s,e=>{this.doWrite(e,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const s=this.opts.secure?"https":"http",e=this.query||{};return this.opts.timestampRequests!==!1&&(e[this.opts.timestampParam]=Bi()),!this.supportsBinary&&!e.sid&&(e.b64=1),this.createUri(s,e)}}let zi=!1;try{zi=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const Mo=zi;function Oo(){}class Ao extends Io{constructor(s){if(super(s),typeof location<"u"){const e=location.protocol==="https:";let t=location.port;t||(t=e?"443":"80"),this.xd=typeof location<"u"&&s.hostname!==location.hostname||t!==s.port}}doWrite(s,e){const t=this.request({method:"POST",data:s});t.on("success",e),t.on("error",(i,n)=>{this.onError("xhr post error",i,n)})}doPoll(){const s=this.request();s.on("data",this.onData.bind(this)),s.on("error",(e,t)=>{this.onError("xhr poll error",e,t)}),this.pollXhr=s}}class Ce extends H{constructor(s,e,t){super(),this.createRequest=s,ms(this,t),this._opts=t,this._method=t.method||"GET",this._uri=e,this._data=t.data!==void 0?t.data:null,this._create()}_create(){var s;const e=$i(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this._opts.xd;const t=this._xhr=this.createRequest(e);try{t.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0);for(let i in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(i)&&t.setRequestHeader(i,this._opts.extraHeaders[i])}}catch{}if(this._method==="POST")try{t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{t.setRequestHeader("Accept","*/*")}catch{}(s=this._opts.cookieJar)===null||s===void 0||s.addCookies(t),"withCredentials"in t&&(t.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(t.timeout=this._opts.requestTimeout),t.onreadystatechange=()=>{var i;t.readyState===3&&((i=this._opts.cookieJar)===null||i===void 0||i.parseCookies(t.getResponseHeader("set-cookie"))),t.readyState===4&&(t.status===200||t.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof t.status=="number"?t.status:0)},0))},t.send(this._data)}catch(i){this.setTimeoutFn(()=>{this._onError(i)},0);return}typeof document<"u"&&(this._index=Ce.requestsCount++,Ce.requests[this._index]=this)}_onError(s){this.emitReserved("error",s,this._xhr),this._cleanup(!0)}_cleanup(s){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=Oo,s)try{this._xhr.abort()}catch{}typeof document<"u"&&delete Ce.requests[this._index],this._xhr=null}}_onLoad(){const s=this._xhr.responseText;s!==null&&(this.emitReserved("data",s),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}Ce.requestsCount=0;Ce.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Zr);else if(typeof addEventListener=="function"){const r="onpagehide"in de?"pagehide":"unload";addEventListener(r,Zr,!1)}}function Zr(){for(let r in Ce.requests)Ce.requests.hasOwnProperty(r)&&Ce.requests[r].abort()}const No=function(){const r=Ui({xdomain:!1});return r&&r.responseType!==null}();class jo extends Ao{constructor(s){super(s);const e=s&&s.forceBase64;this.supportsBinary=No&&!e}request(s={}){return Object.assign(s,{xd:this.xd},this.opts),new Ce(Ui,this.uri(),s)}}function Ui(r){const s=r.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!s||Mo))return new XMLHttpRequest}catch{}if(!s)try{return new de[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const Vi=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class Fo extends gr{get name(){return"websocket"}doOpen(){const s=this.uri(),e=this.opts.protocols,t=Vi?{}:$i(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(t.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(s,e,t)}catch(i){return this.emitReserved("error",i)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=s=>this.onClose({description:"websocket connection closed",context:s}),this.ws.onmessage=s=>this.onData(s.data),this.ws.onerror=s=>this.onError("websocket error",s)}write(s){this.writable=!1;for(let e=0;e<s.length;e++){const t=s[e],i=e===s.length-1;fr(t,this.supportsBinary,n=>{try{this.doWrite(t,n)}catch{}i&&fs(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const s=this.opts.secure?"wss":"ws",e=this.query||{};return this.opts.timestampRequests&&(e[this.opts.timestampParam]=Bi()),this.supportsBinary||(e.b64=1),this.createUri(s,e)}}const Qs=de.WebSocket||de.MozWebSocket;class $o extends Fo{createSocket(s,e,t){return Vi?new Qs(s,e,t):e?new Qs(s,e):new Qs(s)}doWrite(s,e){this.ws.send(e)}}class Bo extends gr{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(s){return this.emitReserved("error",s)}this._transport.closed.then(()=>{this.onClose()}).catch(s=>{this.onError("webtransport error",s)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(s=>{const e=bo(Number.MAX_SAFE_INTEGER,this.socket.binaryType),t=s.readable.pipeThrough(e).getReader(),i=wo();i.readable.pipeTo(s.writable),this._writer=i.writable.getWriter();const n=()=>{t.read().then(({done:a,value:c})=>{a||(this.onPacket(c),n())}).catch(a=>{})};n();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this._writer.write(o).then(()=>this.onOpen())})})}write(s){this.writable=!1;for(let e=0;e<s.length;e++){const t=s[e],i=e===s.length-1;this._writer.write(t).then(()=>{i&&fs(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var s;(s=this._transport)===null||s===void 0||s.close()}}const zo={websocket:$o,webtransport:Bo,polling:jo},Uo=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Vo=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function nr(r){if(r.length>8e3)throw"URI too long";const s=r,e=r.indexOf("["),t=r.indexOf("]");e!=-1&&t!=-1&&(r=r.substring(0,e)+r.substring(e,t).replace(/:/g,";")+r.substring(t,r.length));let i=Uo.exec(r||""),n={},o=14;for(;o--;)n[Vo[o]]=i[o]||"";return e!=-1&&t!=-1&&(n.source=s,n.host=n.host.substring(1,n.host.length-1).replace(/;/g,":"),n.authority=n.authority.replace("[","").replace("]","").replace(/;/g,":"),n.ipv6uri=!0),n.pathNames=qo(n,n.path),n.queryKey=Go(n,n.query),n}function qo(r,s){const e=/\/{2,9}/g,t=s.replace(e,"/").split("/");return(s.slice(0,1)=="/"||s.length===0)&&t.splice(0,1),s.slice(-1)=="/"&&t.splice(t.length-1,1),t}function Go(r,s){const e={};return s.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(t,i,n){i&&(e[i]=n)}),e}const or=typeof addEventListener=="function"&&typeof removeEventListener=="function",ds=[];or&&addEventListener("offline",()=>{ds.forEach(r=>r())},!1);class ze extends H{constructor(s,e){if(super(),this.binaryType=Co,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,s&&typeof s=="object"&&(e=s,s=null),s){const t=nr(s);e.hostname=t.host,e.secure=t.protocol==="https"||t.protocol==="wss",e.port=t.port,t.query&&(e.query=t.query)}else e.host&&(e.hostname=nr(e.host).host);ms(this,e),this.secure=e.secure!=null?e.secure:typeof location<"u"&&location.protocol==="https:",e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.hostname=e.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=e.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},e.transports.forEach(t=>{const i=t.prototype.name;this.transports.push(i),this._transportsByName[i]=t}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},e),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Po(this.opts.query)),or&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},ds.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(s){const e=Object.assign({},this.opts.query);e.EIO=Fi,e.transport=s,this.id&&(e.sid=this.id);const t=Object.assign({},this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[s]);return new this._transportsByName[s](t)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const s=this.opts.rememberUpgrade&&ze.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const e=this.createTransport(s);e.open(),this.setTransport(e)}setTransport(s){this.transport&&this.transport.removeAllListeners(),this.transport=s,s.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",e=>this._onClose("transport close",e))}onOpen(){this.readyState="open",ze.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(s){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",s),this.emitReserved("heartbeat"),s.type){case"open":this.onHandshake(JSON.parse(s.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const e=new Error("server error");e.code=s.data,this._onError(e);break;case"message":this.emitReserved("data",s.data),this.emitReserved("message",s.data);break}}onHandshake(s){this.emitReserved("handshake",s),this.id=s.sid,this.transport.query.sid=s.sid,this._pingInterval=s.pingInterval,this._pingTimeout=s.pingTimeout,this._maxPayload=s.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const s=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+s,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},s),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const s=this._getWritablePackets();this.transport.send(s),this._prevBufferLen=s.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let t=0;t<this.writeBuffer.length;t++){const i=this.writeBuffer[t].data;if(i&&(e+=ko(i)),t>0&&e>this._maxPayload)return this.writeBuffer.slice(0,t);e+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const s=Date.now()>this._pingTimeoutTime;return s&&(this._pingTimeoutTime=0,fs(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),s}write(s,e,t){return this._sendPacket("message",s,e,t),this}send(s,e,t){return this._sendPacket("message",s,e,t),this}_sendPacket(s,e,t,i){if(typeof e=="function"&&(i=e,e=void 0),typeof t=="function"&&(i=t,t=null),this.readyState==="closing"||this.readyState==="closed")return;t=t||{},t.compress=t.compress!==!1;const n={type:s,data:e,options:t};this.emitReserved("packetCreate",n),this.writeBuffer.push(n),i&&this.once("flush",i),this.flush()}close(){const s=()=>{this._onClose("forced close"),this.transport.close()},e=()=>{this.off("upgrade",e),this.off("upgradeError",e),s()},t=()=>{this.once("upgrade",e),this.once("upgradeError",e)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?t():s()}):this.upgrading?t():s()),this}_onError(s){if(ze.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",s),this._onClose("transport error",s)}_onClose(s,e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),or&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const t=ds.indexOf(this._offlineEventListener);t!==-1&&ds.splice(t,1)}this.readyState="closed",this.id=null,this.emitReserved("close",s,e),this.writeBuffer=[],this._prevBufferLen=0}}}ze.protocol=Fi;class Ho extends ze{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let s=0;s<this._upgrades.length;s++)this._probe(this._upgrades[s])}_probe(s){let e=this.createTransport(s),t=!1;ze.priorWebsocketSuccess=!1;const i=()=>{t||(e.send([{type:"ping",data:"probe"}]),e.once("packet",p=>{if(!t)if(p.type==="pong"&&p.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;ze.priorWebsocketSuccess=e.name==="websocket",this.transport.pause(()=>{t||this.readyState!=="closed"&&(d(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())})}else{const h=new Error("probe error");h.transport=e.name,this.emitReserved("upgradeError",h)}}))};function n(){t||(t=!0,d(),e.close(),e=null)}const o=p=>{const h=new Error("probe error: "+p);h.transport=e.name,n(),this.emitReserved("upgradeError",h)};function a(){o("transport closed")}function c(){o("socket closed")}function l(p){e&&p.name!==e.name&&n()}const d=()=>{e.removeListener("open",i),e.removeListener("error",o),e.removeListener("close",a),this.off("close",c),this.off("upgrading",l)};e.once("open",i),e.once("error",o),e.once("close",a),this.once("close",c),this.once("upgrading",l),this._upgrades.indexOf("webtransport")!==-1&&s!=="webtransport"?this.setTimeoutFn(()=>{t||e.open()},200):e.open()}onHandshake(s){this._upgrades=this._filterUpgrades(s.upgrades),super.onHandshake(s)}_filterUpgrades(s){const e=[];for(let t=0;t<s.length;t++)~this.transports.indexOf(s[t])&&e.push(s[t]);return e}}let Wo=class extends Ho{constructor(s,e={}){const t=typeof s=="object"?s:e;(!t.transports||t.transports&&typeof t.transports[0]=="string")&&(t.transports=(t.transports||["polling","websocket","webtransport"]).map(i=>zo[i]).filter(i=>!!i)),super(s,t)}};function Ko(r,s="",e){let t=r;e=e||typeof location<"u"&&location,r==null&&(r=e.protocol+"//"+e.host),typeof r=="string"&&(r.charAt(0)==="/"&&(r.charAt(1)==="/"?r=e.protocol+r:r=e.host+r),/^(https?|wss?):\/\//.test(r)||(typeof e<"u"?r=e.protocol+"//"+r:r="https://"+r),t=nr(r)),t.port||(/^(http|ws)$/.test(t.protocol)?t.port="80":/^(http|ws)s$/.test(t.protocol)&&(t.port="443")),t.path=t.path||"/";const n=t.host.indexOf(":")!==-1?"["+t.host+"]":t.host;return t.id=t.protocol+"://"+n+":"+t.port+s,t.href=t.protocol+"://"+n+(e&&e.port===t.port?"":":"+t.port),t}const Qo=typeof ArrayBuffer=="function",Jo=r=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(r):r.buffer instanceof ArrayBuffer,qi=Object.prototype.toString,Yo=typeof Blob=="function"||typeof Blob<"u"&&qi.call(Blob)==="[object BlobConstructor]",Xo=typeof File=="function"||typeof File<"u"&&qi.call(File)==="[object FileConstructor]";function _r(r){return Qo&&(r instanceof ArrayBuffer||Jo(r))||Yo&&r instanceof Blob||Xo&&r instanceof File}function ls(r,s){if(!r||typeof r!="object")return!1;if(Array.isArray(r)){for(let e=0,t=r.length;e<t;e++)if(ls(r[e]))return!0;return!1}if(_r(r))return!0;if(r.toJSON&&typeof r.toJSON=="function"&&arguments.length===1)return ls(r.toJSON(),!0);for(const e in r)if(Object.prototype.hasOwnProperty.call(r,e)&&ls(r[e]))return!0;return!1}function Zo(r){const s=[],e=r.data,t=r;return t.data=ar(e,s),t.attachments=s.length,{packet:t,buffers:s}}function ar(r,s){if(!r)return r;if(_r(r)){const e={_placeholder:!0,num:s.length};return s.push(r),e}else if(Array.isArray(r)){const e=new Array(r.length);for(let t=0;t<r.length;t++)e[t]=ar(r[t],s);return e}else if(typeof r=="object"&&!(r instanceof Date)){const e={};for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=ar(r[t],s));return e}return r}function ea(r,s){return r.data=cr(r.data,s),delete r.attachments,r}function cr(r,s){if(!r)return r;if(r&&r._placeholder===!0){if(typeof r.num=="number"&&r.num>=0&&r.num<s.length)return s[r.num];throw new Error("illegal attachments")}else if(Array.isArray(r))for(let e=0;e<r.length;e++)r[e]=cr(r[e],s);else if(typeof r=="object")for(const e in r)Object.prototype.hasOwnProperty.call(r,e)&&(r[e]=cr(r[e],s));return r}const ta=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],sa=5;var N;(function(r){r[r.CONNECT=0]="CONNECT",r[r.DISCONNECT=1]="DISCONNECT",r[r.EVENT=2]="EVENT",r[r.ACK=3]="ACK",r[r.CONNECT_ERROR=4]="CONNECT_ERROR",r[r.BINARY_EVENT=5]="BINARY_EVENT",r[r.BINARY_ACK=6]="BINARY_ACK"})(N||(N={}));class ra{constructor(s){this.replacer=s}encode(s){return(s.type===N.EVENT||s.type===N.ACK)&&ls(s)?this.encodeAsBinary({type:s.type===N.EVENT?N.BINARY_EVENT:N.BINARY_ACK,nsp:s.nsp,data:s.data,id:s.id}):[this.encodeAsString(s)]}encodeAsString(s){let e=""+s.type;return(s.type===N.BINARY_EVENT||s.type===N.BINARY_ACK)&&(e+=s.attachments+"-"),s.nsp&&s.nsp!=="/"&&(e+=s.nsp+","),s.id!=null&&(e+=s.id),s.data!=null&&(e+=JSON.stringify(s.data,this.replacer)),e}encodeAsBinary(s){const e=Zo(s),t=this.encodeAsString(e.packet),i=e.buffers;return i.unshift(t),i}}function ei(r){return Object.prototype.toString.call(r)==="[object Object]"}class vr extends H{constructor(s){super(),this.reviver=s}add(s){let e;if(typeof s=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");e=this.decodeString(s);const t=e.type===N.BINARY_EVENT;t||e.type===N.BINARY_ACK?(e.type=t?N.EVENT:N.ACK,this.reconstructor=new ia(e),e.attachments===0&&super.emitReserved("decoded",e)):super.emitReserved("decoded",e)}else if(_r(s)||s.base64)if(this.reconstructor)e=this.reconstructor.takeBinaryData(s),e&&(this.reconstructor=null,super.emitReserved("decoded",e));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+s)}decodeString(s){let e=0;const t={type:Number(s.charAt(0))};if(N[t.type]===void 0)throw new Error("unknown packet type "+t.type);if(t.type===N.BINARY_EVENT||t.type===N.BINARY_ACK){const n=e+1;for(;s.charAt(++e)!=="-"&&e!=s.length;);const o=s.substring(n,e);if(o!=Number(o)||s.charAt(e)!=="-")throw new Error("Illegal attachments");t.attachments=Number(o)}if(s.charAt(e+1)==="/"){const n=e+1;for(;++e&&!(s.charAt(e)===","||e===s.length););t.nsp=s.substring(n,e)}else t.nsp="/";const i=s.charAt(e+1);if(i!==""&&Number(i)==i){const n=e+1;for(;++e;){const o=s.charAt(e);if(o==null||Number(o)!=o){--e;break}if(e===s.length)break}t.id=Number(s.substring(n,e+1))}if(s.charAt(++e)){const n=this.tryParse(s.substr(e));if(vr.isPayloadValid(t.type,n))t.data=n;else throw new Error("invalid payload")}return t}tryParse(s){try{return JSON.parse(s,this.reviver)}catch{return!1}}static isPayloadValid(s,e){switch(s){case N.CONNECT:return ei(e);case N.DISCONNECT:return e===void 0;case N.CONNECT_ERROR:return typeof e=="string"||ei(e);case N.EVENT:case N.BINARY_EVENT:return Array.isArray(e)&&(typeof e[0]=="number"||typeof e[0]=="string"&&ta.indexOf(e[0])===-1);case N.ACK:case N.BINARY_ACK:return Array.isArray(e)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class ia{constructor(s){this.packet=s,this.buffers=[],this.reconPack=s}takeBinaryData(s){if(this.buffers.push(s),this.buffers.length===this.reconPack.attachments){const e=ea(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const na=Object.freeze(Object.defineProperty({__proto__:null,Decoder:vr,Encoder:ra,get PacketType(){return N},protocol:sa},Symbol.toStringTag,{value:"Module"}));function he(r,s,e){return r.on(s,e),function(){r.off(s,e)}}const oa=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Gi extends H{constructor(s,e,t){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=s,this.nsp=e,t&&t.auth&&(this.auth=t.auth),this._opts=Object.assign({},t),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const s=this.io;this.subs=[he(s,"open",this.onopen.bind(this)),he(s,"packet",this.onpacket.bind(this)),he(s,"error",this.onerror.bind(this)),he(s,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...s){return s.unshift("message"),this.emit.apply(this,s),this}emit(s,...e){var t,i,n;if(oa.hasOwnProperty(s))throw new Error('"'+s.toString()+'" is a reserved event name');if(e.unshift(s),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(e),this;const o={type:N.EVENT,data:e};if(o.options={},o.options.compress=this.flags.compress!==!1,typeof e[e.length-1]=="function"){const d=this.ids++,p=e.pop();this._registerAckCallback(d,p),o.id=d}const a=(i=(t=this.io.engine)===null||t===void 0?void 0:t.transport)===null||i===void 0?void 0:i.writable,c=this.connected&&!(!((n=this.io.engine)===null||n===void 0)&&n._hasPingExpired());return this.flags.volatile&&!a||(c?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}_registerAckCallback(s,e){var t;const i=(t=this.flags.timeout)!==null&&t!==void 0?t:this._opts.ackTimeout;if(i===void 0){this.acks[s]=e;return}const n=this.io.setTimeoutFn(()=>{delete this.acks[s];for(let a=0;a<this.sendBuffer.length;a++)this.sendBuffer[a].id===s&&this.sendBuffer.splice(a,1);e.call(this,new Error("operation has timed out"))},i),o=(...a)=>{this.io.clearTimeoutFn(n),e.apply(this,a)};o.withError=!0,this.acks[s]=o}emitWithAck(s,...e){return new Promise((t,i)=>{const n=(o,a)=>o?i(o):t(a);n.withError=!0,e.push(n),this.emit(s,...e)})}_addToQueue(s){let e;typeof s[s.length-1]=="function"&&(e=s.pop());const t={id:this._queueSeq++,tryCount:0,pending:!1,args:s,flags:Object.assign({fromQueue:!0},this.flags)};s.push((i,...n)=>t!==this._queue[0]?void 0:(i!==null?t.tryCount>this._opts.retries&&(this._queue.shift(),e&&e(i)):(this._queue.shift(),e&&e(null,...n)),t.pending=!1,this._drainQueue())),this._queue.push(t),this._drainQueue()}_drainQueue(s=!1){if(!this.connected||this._queue.length===0)return;const e=this._queue[0];e.pending&&!s||(e.pending=!0,e.tryCount++,this.flags=e.flags,this.emit.apply(this,e.args))}packet(s){s.nsp=this.nsp,this.io._packet(s)}onopen(){typeof this.auth=="function"?this.auth(s=>{this._sendConnectPacket(s)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(s){this.packet({type:N.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},s):s})}onerror(s){this.connected||this.emitReserved("connect_error",s)}onclose(s,e){this.connected=!1,delete this.id,this.emitReserved("disconnect",s,e),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(s=>{if(!this.sendBuffer.some(t=>String(t.id)===s)){const t=this.acks[s];delete this.acks[s],t.withError&&t.call(this,new Error("socket has been disconnected"))}})}onpacket(s){if(s.nsp===this.nsp)switch(s.type){case N.CONNECT:s.data&&s.data.sid?this.onconnect(s.data.sid,s.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case N.EVENT:case N.BINARY_EVENT:this.onevent(s);break;case N.ACK:case N.BINARY_ACK:this.onack(s);break;case N.DISCONNECT:this.ondisconnect();break;case N.CONNECT_ERROR:this.destroy();const t=new Error(s.data.message);t.data=s.data.data,this.emitReserved("connect_error",t);break}}onevent(s){const e=s.data||[];s.id!=null&&e.push(this.ack(s.id)),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(s){if(this._anyListeners&&this._anyListeners.length){const e=this._anyListeners.slice();for(const t of e)t.apply(this,s)}super.emit.apply(this,s),this._pid&&s.length&&typeof s[s.length-1]=="string"&&(this._lastOffset=s[s.length-1])}ack(s){const e=this;let t=!1;return function(...i){t||(t=!0,e.packet({type:N.ACK,id:s,data:i}))}}onack(s){const e=this.acks[s.id];typeof e=="function"&&(delete this.acks[s.id],e.withError&&s.data.unshift(null),e.apply(this,s.data))}onconnect(s,e){this.id=s,this.recovered=e&&this._pid===e,this._pid=e,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(s=>this.emitEvent(s)),this.receiveBuffer=[],this.sendBuffer.forEach(s=>{this.notifyOutgoingListeners(s),this.packet(s)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(s=>s()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:N.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(s){return this.flags.compress=s,this}get volatile(){return this.flags.volatile=!0,this}timeout(s){return this.flags.timeout=s,this}onAny(s){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(s),this}prependAny(s){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(s),this}offAny(s){if(!this._anyListeners)return this;if(s){const e=this._anyListeners;for(let t=0;t<e.length;t++)if(s===e[t])return e.splice(t,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(s){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(s),this}prependAnyOutgoing(s){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(s),this}offAnyOutgoing(s){if(!this._anyOutgoingListeners)return this;if(s){const e=this._anyOutgoingListeners;for(let t=0;t<e.length;t++)if(s===e[t])return e.splice(t,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(s){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const e=this._anyOutgoingListeners.slice();for(const t of e)t.apply(this,s.data)}}}function Rt(r){r=r||{},this.ms=r.min||100,this.max=r.max||1e4,this.factor=r.factor||2,this.jitter=r.jitter>0&&r.jitter<=1?r.jitter:0,this.attempts=0}Rt.prototype.duration=function(){var r=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var s=Math.random(),e=Math.floor(s*this.jitter*r);r=Math.floor(s*10)&1?r+e:r-e}return Math.min(r,this.max)|0};Rt.prototype.reset=function(){this.attempts=0};Rt.prototype.setMin=function(r){this.ms=r};Rt.prototype.setMax=function(r){this.max=r};Rt.prototype.setJitter=function(r){this.jitter=r};class dr extends H{constructor(s,e){var t;super(),this.nsps={},this.subs=[],s&&typeof s=="object"&&(e=s,s=void 0),e=e||{},e.path=e.path||"/socket.io",this.opts=e,ms(this,e),this.reconnection(e.reconnection!==!1),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor((t=e.randomizationFactor)!==null&&t!==void 0?t:.5),this.backoff=new Rt({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(e.timeout==null?2e4:e.timeout),this._readyState="closed",this.uri=s;const i=e.parser||na;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=e.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(s){return arguments.length?(this._reconnection=!!s,s||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(s){return s===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=s,this)}reconnectionDelay(s){var e;return s===void 0?this._reconnectionDelay:(this._reconnectionDelay=s,(e=this.backoff)===null||e===void 0||e.setMin(s),this)}randomizationFactor(s){var e;return s===void 0?this._randomizationFactor:(this._randomizationFactor=s,(e=this.backoff)===null||e===void 0||e.setJitter(s),this)}reconnectionDelayMax(s){var e;return s===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=s,(e=this.backoff)===null||e===void 0||e.setMax(s),this)}timeout(s){return arguments.length?(this._timeout=s,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(s){if(~this._readyState.indexOf("open"))return this;this.engine=new Wo(this.uri,this.opts);const e=this.engine,t=this;this._readyState="opening",this.skipReconnect=!1;const i=he(e,"open",function(){t.onopen(),s&&s()}),n=a=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",a),s?s(a):this.maybeReconnectOnOpen()},o=he(e,"error",n);if(this._timeout!==!1){const a=this._timeout,c=this.setTimeoutFn(()=>{i(),n(new Error("timeout")),e.close()},a);this.opts.autoUnref&&c.unref(),this.subs.push(()=>{this.clearTimeoutFn(c)})}return this.subs.push(i),this.subs.push(o),this}connect(s){return this.open(s)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const s=this.engine;this.subs.push(he(s,"ping",this.onping.bind(this)),he(s,"data",this.ondata.bind(this)),he(s,"error",this.onerror.bind(this)),he(s,"close",this.onclose.bind(this)),he(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(s){try{this.decoder.add(s)}catch(e){this.onclose("parse error",e)}}ondecoded(s){fs(()=>{this.emitReserved("packet",s)},this.setTimeoutFn)}onerror(s){this.emitReserved("error",s)}socket(s,e){let t=this.nsps[s];return t?this._autoConnect&&!t.active&&t.connect():(t=new Gi(this,s,e),this.nsps[s]=t),t}_destroy(s){const e=Object.keys(this.nsps);for(const t of e)if(this.nsps[t].active)return;this._close()}_packet(s){const e=this.encoder.encode(s);for(let t=0;t<e.length;t++)this.engine.write(e[t],s.options)}cleanup(){this.subs.forEach(s=>s()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(s,e){var t;this.cleanup(),(t=this.engine)===null||t===void 0||t.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",s,e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const s=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const e=this.backoff.duration();this._reconnecting=!0;const t=this.setTimeoutFn(()=>{s.skipReconnect||(this.emitReserved("reconnect_attempt",s.backoff.attempts),!s.skipReconnect&&s.open(i=>{i?(s._reconnecting=!1,s.reconnect(),this.emitReserved("reconnect_error",i)):s.onreconnect()}))},e);this.opts.autoUnref&&t.unref(),this.subs.push(()=>{this.clearTimeoutFn(t)})}}onreconnect(){const s=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",s)}}const xt={};function ps(r,s){typeof r=="object"&&(s=r,r=void 0),s=s||{};const e=Ko(r,s.path||"/socket.io"),t=e.source,i=e.id,n=e.path,o=xt[i]&&n in xt[i].nsps,a=s.forceNew||s["force new connection"]||s.multiplex===!1||o;let c;return a?c=new dr(t,s):(xt[i]||(xt[i]=new dr(t,s)),c=xt[i]),e.query&&!s.query&&(s.query=e.queryKey),c.socket(e.path,s)}Object.assign(ps,{Manager:dr,Socket:Gi,io:ps,connect:ps});var aa={},lr={exports:{}},Js,ti;function ca(){if(ti)return Js;ti=1;var r=1e3,s=r*60,e=s*60,t=e*24,i=t*7,n=t*365.25;Js=function(d,p){p=p||{};var h=typeof d;if(h==="string"&&d.length>0)return o(d);if(h==="number"&&isFinite(d))return p.long?c(d):a(d);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(d))};function o(d){if(d=String(d),!(d.length>100)){var p=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(d);if(p){var h=parseFloat(p[1]),m=(p[2]||"ms").toLowerCase();switch(m){case"years":case"year":case"yrs":case"yr":case"y":return h*n;case"weeks":case"week":case"w":return h*i;case"days":case"day":case"d":return h*t;case"hours":case"hour":case"hrs":case"hr":case"h":return h*e;case"minutes":case"minute":case"mins":case"min":case"m":return h*s;case"seconds":case"second":case"secs":case"sec":case"s":return h*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return h;default:return}}}}function a(d){var p=Math.abs(d);return p>=t?Math.round(d/t)+"d":p>=e?Math.round(d/e)+"h":p>=s?Math.round(d/s)+"m":p>=r?Math.round(d/r)+"s":d+"ms"}function c(d){var p=Math.abs(d);return p>=t?l(d,p,t,"day"):p>=e?l(d,p,e,"hour"):p>=s?l(d,p,s,"minute"):p>=r?l(d,p,r,"second"):d+" ms"}function l(d,p,h,m){var C=p>=h*1.5;return Math.round(d/h)+" "+m+(C?"s":"")}return Js}function da(r){e.debug=e,e.default=e,e.coerce=c,e.disable=o,e.enable=i,e.enabled=a,e.humanize=ca(),e.destroy=l,Object.keys(r).forEach(d=>{e[d]=r[d]}),e.names=[],e.skips=[],e.formatters={};function s(d){let p=0;for(let h=0;h<d.length;h++)p=(p<<5)-p+d.charCodeAt(h),p|=0;return e.colors[Math.abs(p)%e.colors.length]}e.selectColor=s;function e(d){let p,h=null,m,C;function _(...S){if(!_.enabled)return;const b=_,L=Number(new Date),A=L-(p||L);b.diff=A,b.prev=p,b.curr=L,p=L,S[0]=e.coerce(S[0]),typeof S[0]!="string"&&S.unshift("%O");let F=0;S[0]=S[0].replace(/%([a-zA-Z%])/g,(ke,xe)=>{if(ke==="%%")return"%";F++;const le=e.formatters[xe];if(typeof le=="function"){const ce=S[F];ke=le.call(b,ce),S.splice(F,1),F--}return ke}),e.formatArgs.call(b,S),(b.log||e.log).apply(b,S)}return _.namespace=d,_.useColors=e.useColors(),_.color=e.selectColor(d),_.extend=t,_.destroy=e.destroy,Object.defineProperty(_,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(m!==e.namespaces&&(m=e.namespaces,C=e.enabled(d)),C),set:S=>{h=S}}),typeof e.init=="function"&&e.init(_),_}function t(d,p){const h=e(this.namespace+(typeof p>"u"?":":p)+d);return h.log=this.log,h}function i(d){e.save(d),e.namespaces=d,e.names=[],e.skips=[];const p=(typeof d=="string"?d:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const h of p)h[0]==="-"?e.skips.push(h.slice(1)):e.names.push(h)}function n(d,p){let h=0,m=0,C=-1,_=0;for(;h<d.length;)if(m<p.length&&(p[m]===d[h]||p[m]==="*"))p[m]==="*"?(C=m,_=h,m++):(h++,m++);else if(C!==-1)m=C+1,_++,h=_;else return!1;for(;m<p.length&&p[m]==="*";)m++;return m===p.length}function o(){const d=[...e.names,...e.skips.map(p=>"-"+p)].join(",");return e.enable(""),d}function a(d){for(const p of e.skips)if(n(d,p))return!1;for(const p of e.names)if(n(d,p))return!0;return!1}function c(d){return d instanceof Error?d.stack||d.message:d}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.enable(e.load()),e}var la=da;(function(r,s){var e={};s.formatArgs=i,s.save=n,s.load=o,s.useColors=t,s.storage=a(),s.destroy=(()=>{let l=!1;return()=>{l||(l=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),s.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function t(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let l;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(l=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(l[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(l){if(l[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+l[0]+(this.useColors?"%c ":" ")+"+"+r.exports.humanize(this.diff),!this.useColors)return;const d="color: "+this.color;l.splice(1,0,d,"color: inherit");let p=0,h=0;l[0].replace(/%[a-zA-Z%]/g,m=>{m!=="%%"&&(p++,m==="%c"&&(h=p))}),l.splice(h,0,d)}s.log=console.debug||console.log||(()=>{});function n(l){try{l?s.storage.setItem("debug",l):s.storage.removeItem("debug")}catch{}}function o(){let l;try{l=s.storage.getItem("debug")||s.storage.getItem("DEBUG")}catch{}return!l&&typeof process<"u"&&"env"in process&&(l=e.DEBUG),l}function a(){try{return localStorage}catch{}}r.exports=la(s);const{formatters:c}=r.exports;c.j=function(l){try{return JSON.stringify(l)}catch(d){return"[UnexpectedJSONParseError]: "+d.message}}})(lr,lr.exports);var gs=lr.exports,Hi={};Object.defineProperty(Hi,"__esModule",{value:!0});var Et={},Y={};Object.defineProperty(Y,"__esModule",{value:!0});Y.Logger=void 0;const lt=gs,pt="mediasoup-client";let pa=class{constructor(s){u(this,"_debug");u(this,"_warn");u(this,"_error");s?(this._debug=(0,lt.default)(`${pt}:${s}`),this._warn=(0,lt.default)(`${pt}:WARN:${s}`),this._error=(0,lt.default)(`${pt}:ERROR:${s}`)):(this._debug=(0,lt.default)(pt),this._warn=(0,lt.default)(`${pt}:WARN`),this._error=(0,lt.default)(`${pt}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};Y.Logger=pa;var se={},yr={exports:{}},yt=typeof Reflect=="object"?Reflect:null,si=yt&&typeof yt.apply=="function"?yt.apply:function(s,e,t){return Function.prototype.apply.call(s,e,t)},us;yt&&typeof yt.ownKeys=="function"?us=yt.ownKeys:Object.getOwnPropertySymbols?us=function(s){return Object.getOwnPropertyNames(s).concat(Object.getOwnPropertySymbols(s))}:us=function(s){return Object.getOwnPropertyNames(s)};function ua(r){console&&console.warn&&console.warn(r)}var Wi=Number.isNaN||function(s){return s!==s};function B(){B.init.call(this)}yr.exports=B;yr.exports.once=ga;B.EventEmitter=B;B.prototype._events=void 0;B.prototype._eventsCount=0;B.prototype._maxListeners=void 0;var ri=10;function _s(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(B,"defaultMaxListeners",{enumerable:!0,get:function(){return ri},set:function(r){if(typeof r!="number"||r<0||Wi(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");ri=r}});B.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};B.prototype.setMaxListeners=function(s){if(typeof s!="number"||s<0||Wi(s))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+s+".");return this._maxListeners=s,this};function Ki(r){return r._maxListeners===void 0?B.defaultMaxListeners:r._maxListeners}B.prototype.getMaxListeners=function(){return Ki(this)};B.prototype.emit=function(s){for(var e=[],t=1;t<arguments.length;t++)e.push(arguments[t]);var i=s==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var o;if(e.length>0&&(o=e[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=n[s];if(c===void 0)return!1;if(typeof c=="function")si(c,this,e);else for(var l=c.length,d=Zi(c,l),t=0;t<l;++t)si(d[t],this,e);return!0};function Qi(r,s,e,t){var i,n,o;if(_s(e),n=r._events,n===void 0?(n=r._events=Object.create(null),r._eventsCount=0):(n.newListener!==void 0&&(r.emit("newListener",s,e.listener?e.listener:e),n=r._events),o=n[s]),o===void 0)o=n[s]=e,++r._eventsCount;else if(typeof o=="function"?o=n[s]=t?[e,o]:[o,e]:t?o.unshift(e):o.push(e),i=Ki(r),i>0&&o.length>i&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(s)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=r,a.type=s,a.count=o.length,ua(a)}return r}B.prototype.addListener=function(s,e){return Qi(this,s,e,!1)};B.prototype.on=B.prototype.addListener;B.prototype.prependListener=function(s,e){return Qi(this,s,e,!0)};function ha(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Ji(r,s,e){var t={fired:!1,wrapFn:void 0,target:r,type:s,listener:e},i=ha.bind(t);return i.listener=e,t.wrapFn=i,i}B.prototype.once=function(s,e){return _s(e),this.on(s,Ji(this,s,e)),this};B.prototype.prependOnceListener=function(s,e){return _s(e),this.prependListener(s,Ji(this,s,e)),this};B.prototype.removeListener=function(s,e){var t,i,n,o,a;if(_s(e),i=this._events,i===void 0)return this;if(t=i[s],t===void 0)return this;if(t===e||t.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete i[s],i.removeListener&&this.emit("removeListener",s,t.listener||e));else if(typeof t!="function"){for(n=-1,o=t.length-1;o>=0;o--)if(t[o]===e||t[o].listener===e){a=t[o].listener,n=o;break}if(n<0)return this;n===0?t.shift():fa(t,n),t.length===1&&(i[s]=t[0]),i.removeListener!==void 0&&this.emit("removeListener",s,a||e)}return this};B.prototype.off=B.prototype.removeListener;B.prototype.removeAllListeners=function(s){var e,t,i;if(t=this._events,t===void 0)return this;if(t.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):t[s]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete t[s]),this;if(arguments.length===0){var n=Object.keys(t),o;for(i=0;i<n.length;++i)o=n[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=t[s],typeof e=="function")this.removeListener(s,e);else if(e!==void 0)for(i=e.length-1;i>=0;i--)this.removeListener(s,e[i]);return this};function Yi(r,s,e){var t=r._events;if(t===void 0)return[];var i=t[s];return i===void 0?[]:typeof i=="function"?e?[i.listener||i]:[i]:e?ma(i):Zi(i,i.length)}B.prototype.listeners=function(s){return Yi(this,s,!0)};B.prototype.rawListeners=function(s){return Yi(this,s,!1)};B.listenerCount=function(r,s){return typeof r.listenerCount=="function"?r.listenerCount(s):Xi.call(r,s)};B.prototype.listenerCount=Xi;function Xi(r){var s=this._events;if(s!==void 0){var e=s[r];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}B.prototype.eventNames=function(){return this._eventsCount>0?us(this._events):[]};function Zi(r,s){for(var e=new Array(s),t=0;t<s;++t)e[t]=r[t];return e}function fa(r,s){for(;s+1<r.length;s++)r[s]=r[s+1];r.pop()}function ma(r){for(var s=new Array(r.length),e=0;e<s.length;++e)s[e]=r[e].listener||r[e];return s}function ga(r,s){return new Promise(function(e,t){function i(o){r.removeListener(s,n),t(o)}function n(){typeof r.removeListener=="function"&&r.removeListener("error",i),e([].slice.call(arguments))}en(r,s,n,{once:!0}),s!=="error"&&_a(r,i,{once:!0})})}function _a(r,s,e){typeof r.on=="function"&&en(r,"error",s,e)}function en(r,s,e,t){if(typeof r.on=="function")t.once?r.once(s,e):r.on(s,e);else if(typeof r.addEventListener=="function")r.addEventListener(s,function i(n){t.once&&r.removeEventListener(s,i),e(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}var va=yr.exports;Object.defineProperty(se,"__esModule",{value:!0});se.EnhancedEventEmitter=void 0;const ya=va,wa=Y,ba=new wa.Logger("EnhancedEventEmitter");class Sa extends ya.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}close(){super.removeAllListeners()}emit(s,...e){return super.emit(s,...e)}safeEmit(s,...e){try{return super.emit(s,...e)}catch(t){ba.error("safeEmit() | event listener threw an error [eventName:%s]:%o",s,t);try{super.emit("listenererror",s,t)}catch{}return!!super.listenerCount(s)}}on(s,e){return super.on(s,e),this}off(s,e){return super.off(s,e),this}addListener(s,e){return super.on(s,e),this}prependListener(s,e){return super.prependListener(s,e),this}once(s,e){return super.once(s,e),this}prependOnceListener(s,e){return super.prependOnceListener(s,e),this}removeListener(s,e){return super.off(s,e),this}removeAllListeners(s){return super.removeAllListeners(s),this}listenerCount(s){return super.listenerCount(s)}listeners(s){return super.listeners(s)}rawListeners(s){return super.rawListeners(s)}}se.EnhancedEventEmitter=Sa;var te={};Object.defineProperty(te,"__esModule",{value:!0});te.InvalidStateError=te.UnsupportedError=void 0;class wr extends Error{constructor(s){super(s),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,wr):this.stack=new Error(s).stack}}te.UnsupportedError=wr;class br extends Error{constructor(s){super(s),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,br):this.stack=new Error(s).stack}}te.InvalidStateError=br;var Ee={};Object.defineProperty(Ee,"__esModule",{value:!0});Ee.clone=Ca;Ee.generateRandomNumber=Ra;Ee.deepFreeze=tn;function Ca(r){if(r!==void 0)return Number.isNaN(r)?NaN:typeof structuredClone=="function"?structuredClone(r):JSON.parse(JSON.stringify(r))}function Ra(){return Math.round(Math.random()*1e7)}function tn(r){const s=Reflect.ownKeys(r);for(const e of s){const t=r[e];(t&&typeof t=="object"||typeof t=="function")&&tn(t)}return Object.freeze(r)}var q={},J={},vs={};Object.defineProperty(vs,"__esModule",{value:!0});vs.Logger=void 0;const ut=gs,ht="h264-profile-level-id";let Ea=class{constructor(s){u(this,"_debug");u(this,"_warn");u(this,"_error");s?(this._debug=(0,ut.default)(`${ht}:${s}`),this._warn=(0,ut.default)(`${ht}:WARN:${s}`),this._error=(0,ut.default)(`${ht}:ERROR:${s}`)):(this._debug=(0,ut.default)(ht),this._warn=(0,ut.default)(`${ht}:WARN`),this._error=(0,ut.default)(`${ht}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};vs.Logger=Ea;Object.defineProperty(J,"__esModule",{value:!0});J.ProfileLevelId=J.Level=J.Profile=void 0;J.parseProfileLevelId=sn;J.profileLevelIdToString=rn;J.profileToString=Da;J.levelToString=Pa;J.parseSdpProfileLevelId=nt;J.isSameProfile=La;J.isSameProfileAndLevel=Ia;J.generateProfileLevelIdStringForAnswer=Ma;J.supportedLevel=Oa;const Ta=vs,fe=new Ta.Logger;var U;(function(r){r[r.ConstrainedBaseline=1]="ConstrainedBaseline",r[r.Baseline=2]="Baseline",r[r.Main=3]="Main",r[r.ConstrainedHigh=4]="ConstrainedHigh",r[r.High=5]="High",r[r.PredictiveHigh444=6]="PredictiveHigh444"})(U||(J.Profile=U={}));var R;(function(r){r[r.L1_b=0]="L1_b",r[r.L1=10]="L1",r[r.L1_1=11]="L1_1",r[r.L1_2=12]="L1_2",r[r.L1_3=13]="L1_3",r[r.L2=20]="L2",r[r.L2_1=21]="L2_1",r[r.L2_2=22]="L2_2",r[r.L3=30]="L3",r[r.L3_1=31]="L3_1",r[r.L3_2=32]="L3_2",r[r.L4=40]="L4",r[r.L4_1=41]="L4_1",r[r.L4_2=42]="L4_2",r[r.L5=50]="L5",r[r.L5_1=51]="L5_1",r[r.L5_2=52]="L5_2"})(R||(J.Level=R={}));class ys{constructor(s,e){u(this,"profile");u(this,"level");this.profile=s,this.level=e}}J.ProfileLevelId=ys;const ka=new ys(U.ConstrainedBaseline,R.L3_1);class Le{constructor(s){u(this,"mask");u(this,"masked_value");this.mask=~ni("x",s),this.masked_value=ni("1",s)}isMatch(s){return this.masked_value===(s&this.mask)}}class Ie{constructor(s,e,t){u(this,"profile_idc");u(this,"profile_iop");u(this,"profile");this.profile_idc=s,this.profile_iop=e,this.profile=t}}const xa=[new Ie(66,new Le("x1xx0000"),U.ConstrainedBaseline),new Ie(77,new Le("1xxx0000"),U.ConstrainedBaseline),new Ie(88,new Le("11xx0000"),U.ConstrainedBaseline),new Ie(66,new Le("x0xx0000"),U.Baseline),new Ie(88,new Le("10xx0000"),U.Baseline),new Ie(77,new Le("0x0x0000"),U.Main),new Ie(100,new Le("00000000"),U.High),new Ie(100,new Le("00001100"),U.ConstrainedHigh),new Ie(244,new Le("00000000"),U.PredictiveHigh444)],ii=[{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:R.L1},{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:R.L1_b},{max_macroblocks_per_second:3e3,max_macroblock_frame_size:396,level:R.L1_1},{max_macroblocks_per_second:6e3,max_macroblock_frame_size:396,level:R.L1_2},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:R.L1_3},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:R.L2},{max_macroblocks_per_second:19800,max_macroblock_frame_size:792,level:R.L2_1},{max_macroblocks_per_second:20250,max_macroblock_frame_size:1620,level:R.L2_2},{max_macroblocks_per_second:40500,max_macroblock_frame_size:1620,level:R.L3},{max_macroblocks_per_second:108e3,max_macroblock_frame_size:3600,level:R.L3_1},{max_macroblocks_per_second:216e3,max_macroblock_frame_size:5120,level:R.L3_2},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:R.L4},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:R.L4_1},{max_macroblocks_per_second:522240,max_macroblock_frame_size:8704,level:R.L4_2},{max_macroblocks_per_second:589824,max_macroblock_frame_size:22080,level:R.L5},{max_macroblocks_per_second:983040,max_macroblock_frame_size:36864,level:R.L5_1},{max_macroblocks_per_second:2073600,max_macroblock_frame_size:36864,level:R.L5_2}];function sn(r){if(typeof r!="string"||r.length!==6)return;const e=parseInt(r,16);if(e===0)return;const t=e&255,i=e>>8&255,n=e>>16&255;let o;switch(t){case R.L1_1:{o=i&16?R.L1_b:R.L1_1;break}case R.L1:case R.L1_2:case R.L1_3:case R.L2:case R.L2_1:case R.L2_2:case R.L3:case R.L3_1:case R.L3_2:case R.L4:case R.L4_1:case R.L4_2:case R.L5:case R.L5_1:case R.L5_2:{o=t;break}default:{fe.warn(`parseProfileLevelId() | unrecognized level_idc [str:${r}, level_idc:${t}]`);return}}for(const a of xa)if(n===a.profile_idc&&a.profile_iop.isMatch(i))return fe.debug(`parseProfileLevelId() | result [str:${r}, profile:${a.profile}, level:${o}]`),new ys(a.profile,o);fe.warn(`parseProfileLevelId() | unrecognized profile_idc/profile_iop combination [str:${r}, profile_idc:${n}, profile_iop:${i}]`)}function rn(r){if(r.level==R.L1_b)switch(r.profile){case U.ConstrainedBaseline:return"42f00b";case U.Baseline:return"42100b";case U.Main:return"4d100b";default:{fe.warn(`profileLevelIdToString() | Level 1_b not is allowed for profile ${r.profile}`);return}}let s;switch(r.profile){case U.ConstrainedBaseline:{s="42e0";break}case U.Baseline:{s="4200";break}case U.Main:{s="4d00";break}case U.ConstrainedHigh:{s="640c";break}case U.High:{s="6400";break}case U.PredictiveHigh444:{s="f400";break}default:{fe.warn(`profileLevelIdToString() | unrecognized profile ${r.profile}`);return}}let e=r.level.toString(16);return e.length===1&&(e=`0${e}`),`${s}${e}`}function Da(r){switch(r){case U.ConstrainedBaseline:return"ConstrainedBaseline";case U.Baseline:return"Baseline";case U.Main:return"Main";case U.ConstrainedHigh:return"ConstrainedHigh";case U.High:return"High";case U.PredictiveHigh444:return"PredictiveHigh444";default:{fe.warn(`profileToString() | unrecognized profile ${r}`);return}}}function Pa(r){switch(r){case R.L1_b:return"1b";case R.L1:return"1";case R.L1_1:return"1.1";case R.L1_2:return"1.2";case R.L1_3:return"1.3";case R.L2:return"2";case R.L2_1:return"2.1";case R.L2_2:return"2.2";case R.L3:return"3";case R.L3_1:return"3.1";case R.L3_2:return"3.2";case R.L4:return"4";case R.L4_1:return"4.1";case R.L4_2:return"4.2";case R.L5:return"5";case R.L5_1:return"5.1";case R.L5_2:return"5.2";default:{fe.warn(`levelToString() | unrecognized level ${r}`);return}}}function nt(r={}){const s=r["profile-level-id"];return s?sn(s):ka}function La(r={},s={}){const e=nt(r),t=nt(s);return!!(e&&t&&e.profile===t.profile)}function Ia(r={},s={}){const e=nt(r),t=nt(s);return!!(e&&t&&e.profile===t.profile&&e.level==t.level)}function Ma(r={},s={}){if(!r["profile-level-id"]&&!s["profile-level-id"]){fe.warn("generateProfileLevelIdStringForAnswer() | profile-level-id missing in local and remote params");return}const e=nt(r),t=nt(s);if(!e)throw new TypeError("invalid local_profile_level_id");if(!t)throw new TypeError("invalid remote_profile_level_id");if(e.profile!==t.profile)throw new TypeError("H264 Profile mismatch");const i=oi(r)&&oi(s),n=e.level,o=t.level,a=Na(n,o),c=i?n:a;return fe.debug(`generateProfileLevelIdStringForAnswer() | result [profile:${e.profile}, level:${c}]`),rn(new ys(e.profile,c))}function Oa(r,s){for(let t=ii.length-1;t>=0;--t){const i=ii[t];if(i.max_macroblock_frame_size*256<=r&&i.max_macroblocks_per_second<=s*i.max_macroblock_frame_size)return fe.debug(`supportedLevel() | result [max_frame_pixel_count:${r}, max_fps:${s}, level:${i.level}]`),i.level}fe.warn(`supportedLevel() | no level supported [max_frame_pixel_count:${r}, max_fps:${s}]`)}function ni(r,s){return+(s[0]===r)<<7|+(s[1]===r)<<6|+(s[2]===r)<<5|+(s[3]===r)<<4|+(s[4]===r)<<3|+(s[5]===r)<<2|+(s[6]===r)<<1|+(s[7]===r)<<0}function Aa(r,s){return r===R.L1_b?s!==R.L1&&s!==R.L1_b:s===R.L1_b?r!==R.L1:r<s}function Na(r,s){return Aa(r,s)?r:s}function oi(r={}){const s=r["level-asymmetry-allowed"];return s===!0||s===1||s==="1"}Object.defineProperty(q,"__esModule",{value:!0});q.validateAndNormalizeRtpCapabilities=za;q.validateAndNormalizeRtpParameters=Sr;q.validateAndNormalizeSctpStreamParameters=Ua;q.validateSctpCapabilities=Va;q.getExtendedRtpCapabilities=qa;q.getRecvRtpCapabilities=Ga;q.getSendingRtpParameters=Ha;q.getSendingRemoteRtpParameters=Wa;q.reduceCodecs=Ka;q.generateProbatorRtpParameters=Qa;q.canSend=Ja;q.canReceive=Ya;const ai=J,ja=Ee,Fa="probator",$a=1234,Ba=127;function za(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(r.codecs&&!Array.isArray(r.codecs))throw new TypeError("caps.codecs is not an array");r.codecs||(r.codecs=[]);for(const s of r.codecs)Xa(s);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(const s of r.headerExtensions)Za(s)}function Sr(r){if(typeof r!="object")throw new TypeError("params is not an object");if(r.mid&&typeof r.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(r.codecs))throw new TypeError("missing params.codecs");for(const s of r.codecs)ec(s);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("params.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(const s of r.headerExtensions)tc(s);if(r.encodings&&!Array.isArray(r.encodings))throw new TypeError("params.encodings is not an array");r.encodings||(r.encodings=[]);for(const s of r.encodings)sc(s);if(r.rtcp&&typeof r.rtcp!="object")throw new TypeError("params.rtcp is not an object");r.rtcp||(r.rtcp={}),rc(r.rtcp)}function Ua(r){if(typeof r!="object")throw new TypeError("params is not an object");if(typeof r.streamId!="number")throw new TypeError("missing params.streamId");let s=!1;if(typeof r.ordered=="boolean"?s=!0:r.ordered=!0,r.maxPacketLifeTime&&typeof r.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(r.maxRetransmits&&typeof r.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(r.maxPacketLifeTime&&r.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(s&&r.ordered&&(r.maxPacketLifeTime||r.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!s&&(r.maxPacketLifeTime||r.maxRetransmits)&&(r.ordered=!1),r.label&&typeof r.label!="string")throw new TypeError("invalid params.label");if(r.protocol&&typeof r.protocol!="string")throw new TypeError("invalid params.protocol")}function Va(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(!r.numStreams||typeof r.numStreams!="object")throw new TypeError("missing caps.numStreams");ic(r.numStreams)}function qa(r,s,e){const t={codecs:[],headerExtensions:[]};if(e)for(const i of r.codecs??[]){if(vt(i))continue;const n=(s.codecs??[]).find(a=>pr(a,i,{strict:!0,modify:!0}));if(!n)continue;const o={kind:i.kind,mimeType:i.mimeType,clockRate:i.clockRate,channels:i.channels,localPayloadType:i.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:n.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:i.parameters??{},remoteParameters:n.parameters??{},rtcpFeedback:ci(i,n)};t.codecs.push(o)}else for(const i of s.codecs??[]){if(vt(i))continue;const n=(r.codecs??[]).find(a=>pr(a,i,{strict:!0,modify:!0}));if(!n)continue;const o={kind:n.kind,mimeType:n.mimeType,clockRate:n.clockRate,channels:n.channels,localPayloadType:n.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:i.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:n.parameters??{},remoteParameters:i.parameters??{},rtcpFeedback:ci(n,i)};t.codecs.push(o)}for(const i of t.codecs){const n=r.codecs.find(a=>{var c;return vt(a)&&((c=a.parameters)==null?void 0:c.apt)===i.localPayloadType}),o=s.codecs.find(a=>{var c;return vt(a)&&((c=a.parameters)==null?void 0:c.apt)===i.remotePayloadType});n&&o&&(i.localRtxPayloadType=n.preferredPayloadType,i.remoteRtxPayloadType=o.preferredPayloadType)}for(const i of s.headerExtensions){const n=r.headerExtensions.find(a=>nc(a,i));if(!n)continue;const o={kind:i.kind,uri:i.uri,sendId:n.preferredId,recvId:i.preferredId,encrypt:n.preferredEncrypt??!1,direction:"sendrecv"};switch(i.direction){case"sendrecv":{o.direction="sendrecv";break}case"recvonly":{o.direction="sendonly";break}case"sendonly":{o.direction="recvonly";break}case"inactive":{o.direction="inactive";break}}t.headerExtensions.push(o)}return t}function Ga(r){const s={codecs:[],headerExtensions:[]};for(const e of r.codecs){const t={kind:e.kind,mimeType:e.mimeType,preferredPayloadType:e.remotePayloadType,clockRate:e.clockRate,channels:e.channels,parameters:e.localParameters,rtcpFeedback:e.rtcpFeedback};if(s.codecs.push(t),!e.remoteRtxPayloadType)continue;const i={kind:e.kind,mimeType:`${e.kind}/rtx`,preferredPayloadType:e.remoteRtxPayloadType,clockRate:e.clockRate,parameters:{apt:e.remotePayloadType},rtcpFeedback:[]};s.codecs.push(i)}for(const e of r.headerExtensions){if(e.direction!=="sendrecv"&&e.direction!=="recvonly")continue;const t={kind:e.kind,uri:e.uri,preferredId:e.recvId,preferredEncrypt:e.encrypt??!1,direction:e.direction};s.headerExtensions.push(t)}return s}function Ha(r,s){const e={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const t of s.codecs){if(t.kind!==r)continue;const i={mimeType:t.mimeType,payloadType:t.localPayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.localParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(i),t.localRtxPayloadType){const n={mimeType:`${t.kind}/rtx`,payloadType:t.localRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.localPayloadType},rtcpFeedback:[]};e.codecs.push(n)}}for(const t of s.headerExtensions){if(t.kind&&t.kind!==r||t.direction!=="sendrecv"&&t.direction!=="sendonly")continue;const i={uri:t.uri,id:t.sendId,encrypt:t.encrypt,parameters:{}};e.headerExtensions.push(i)}return e}function Wa(r,s){const e={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const t of s.codecs){if(t.kind!==r)continue;const i={mimeType:t.mimeType,payloadType:t.localPayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.remoteParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(i),t.localRtxPayloadType){const n={mimeType:`${t.kind}/rtx`,payloadType:t.localRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.localPayloadType},rtcpFeedback:[]};e.codecs.push(n)}}for(const t of s.headerExtensions){if(t.kind&&t.kind!==r||t.direction!=="sendrecv"&&t.direction!=="sendonly")continue;const i={uri:t.uri,id:t.sendId,encrypt:t.encrypt,parameters:{}};e.headerExtensions.push(i)}if(e.headerExtensions.some(t=>t.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(const t of e.codecs)t.rtcpFeedback=(t.rtcpFeedback??[]).filter(i=>i.type!=="goog-remb");else if(e.headerExtensions.some(t=>t.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(const t of e.codecs)t.rtcpFeedback=(t.rtcpFeedback??[]).filter(i=>i.type!=="transport-cc");else for(const t of e.codecs)t.rtcpFeedback=(t.rtcpFeedback??[]).filter(i=>i.type!=="transport-cc"&&i.type!=="goog-remb");return e}function Ka(r,s){const e=[];if(!s)e.push(r[0]),vt(r[1])&&e.push(r[1]);else{for(let t=0;t<r.length;++t)if(pr(r[t],s,{strict:!0})){e.push(r[t]),vt(r[t+1])&&e.push(r[t+1]);break}if(e.length===0)throw new TypeError("no matching codec found")}return e}function Qa(r){r=ja.clone(r),Sr(r);const s={mid:Fa,codecs:[],headerExtensions:[],encodings:[{ssrc:$a}],rtcp:{cname:"probator"}};return s.codecs.push(r.codecs[0]),s.codecs[0].payloadType=Ba,s.headerExtensions=r.headerExtensions,s}function Ja(r,s){return(s.codecs??[]).some(e=>e.kind===r)}function Ya(r,s){if(Sr(r),r.codecs.length===0)return!1;const e=r.codecs[0];return(s.codecs??[]).some(t=>t.preferredPayloadType===e.payloadType)}function Xa(r){const s=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");const e=s.exec(r.mimeType);if(!e)throw new TypeError("invalid codec.mimeType");if(r.kind=e[1].toLowerCase(),typeof r.preferredPayloadType!="number")throw new TypeError("missing codec.preferredPayloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");r.kind==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(const t of Object.keys(r.parameters)){let i=r.parameters[t];if(i===void 0&&(r.parameters[t]="",i=""),typeof i!="string"&&typeof i!="number")throw new TypeError(`invalid codec parameter [key:${t}s, value:${i}]`);if(t==="apt"&&typeof i!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(const t of r.rtcpFeedback)nn(t)}function nn(r){if(typeof r!="object")throw new TypeError("fb is not an object");if(!r.type||typeof r.type!="string")throw new TypeError("missing fb.type");(!r.parameter||typeof r.parameter!="string")&&(r.parameter="")}function Za(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(r.kind!=="audio"&&r.kind!=="video")throw new TypeError("invalid ext.kind");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.preferredId!="number")throw new TypeError("missing ext.preferredId");if(r.preferredEncrypt&&typeof r.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(r.preferredEncrypt||(r.preferredEncrypt=!1),r.direction&&typeof r.direction!="string")throw new TypeError("invalid ext.direction");r.direction||(r.direction="sendrecv")}function ec(r){const s=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");const e=s.exec(r.mimeType);if(!e)throw new TypeError("invalid codec.mimeType");if(typeof r.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");e[1].toLowerCase()==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(const i of Object.keys(r.parameters)){let n=r.parameters[i];if(n===void 0&&(r.parameters[i]="",n=""),typeof n!="string"&&typeof n!="number")throw new TypeError(`invalid codec parameter [key:${i}s, value:${n}]`);if(i==="apt"&&typeof n!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(const i of r.rtcpFeedback)nn(i)}function tc(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.id!="number")throw new TypeError("missing ext.id");if(r.encrypt&&typeof r.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");r.encrypt||(r.encrypt=!1),(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(const s of Object.keys(r.parameters)){let e=r.parameters[s];if(e===void 0&&(r.parameters[s]="",e=""),typeof e!="string"&&typeof e!="number")throw new TypeError("invalid header extension parameter")}}function sc(r){if(typeof r!="object")throw new TypeError("encoding is not an object");if(r.ssrc&&typeof r.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(r.rid&&typeof r.rid!="string")throw new TypeError("invalid encoding.rid");if(r.rtx&&typeof r.rtx!="object")throw new TypeError("invalid encoding.rtx");if(r.rtx&&typeof r.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!r.dtx||typeof r.dtx!="boolean")&&(r.dtx=!1),r.scalabilityMode&&typeof r.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}function rc(r){if(typeof r!="object")throw new TypeError("rtcp is not an object");if(r.cname&&typeof r.cname!="string")throw new TypeError("invalid rtcp.cname");(!r.reducedSize||typeof r.reducedSize!="boolean")&&(r.reducedSize=!0)}function ic(r){if(typeof r!="object")throw new TypeError("numStreams is not an object");if(typeof r.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof r.MIS!="number")throw new TypeError("missing numStreams.MIS")}function vt(r){return r?/.+\/rtx$/i.test(r.mimeType):!1}function pr(r,s,{strict:e=!1,modify:t=!1}={}){const i=r.mimeType.toLowerCase(),n=s.mimeType.toLowerCase();if(i!==n||r.clockRate!==s.clockRate||r.channels!==s.channels)return!1;switch(i){case"video/h264":{if(e){const o=r.parameters["packetization-mode"]??0,a=s.parameters["packetization-mode"]??0;if(o!==a||!ai.isSameProfile(r.parameters,s.parameters))return!1;let c;try{c=ai.generateProfileLevelIdStringForAnswer(r.parameters,s.parameters)}catch{return!1}t&&(c?(r.parameters["profile-level-id"]=c,s.parameters["profile-level-id"]=c):(delete r.parameters["profile-level-id"],delete s.parameters["profile-level-id"]))}break}case"video/vp9":{if(e){const o=r.parameters["profile-id"]??0,a=s.parameters["profile-id"]??0;if(o!==a)return!1}break}}return!0}function nc(r,s){return!(r.kind&&s.kind&&r.kind!==s.kind||r.uri!==s.uri)}function ci(r,s){const e=[];for(const t of r.rtcpFeedback??[]){const i=(s.rtcpFeedback??[]).find(n=>n.type===t.type&&(n.parameter===t.parameter||!n.parameter&&!t.parameter));i&&e.push(i)}return e}var ws={},on={},bs={},Ss={};Object.defineProperty(Ss,"__esModule",{value:!0});Ss.Logger=void 0;const ft=gs,mt="awaitqueue";class oc{constructor(s){u(this,"_debug");u(this,"_warn");u(this,"_error");s?(this._debug=ft(`${mt}:${s}`),this._warn=ft(`${mt}:WARN:${s}`),this._error=ft(`${mt}:ERROR:${s}`)):(this._debug=ft(mt),this._warn=ft(`${mt}:WARN`),this._error=ft(`${mt}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}}Ss.Logger=oc;var ot={};Object.defineProperty(ot,"__esModule",{value:!0});ot.AwaitQueueRemovedTaskError=ot.AwaitQueueStoppedError=void 0;class Cr extends Error{constructor(s){super(s??"queue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Cr)}}ot.AwaitQueueStoppedError=Cr;class Rr extends Error{constructor(s){super(s??"queue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Rr)}}ot.AwaitQueueRemovedTaskError=Rr;Object.defineProperty(bs,"__esModule",{value:!0});bs.AwaitQueue=void 0;const ac=Ss,Ys=ot,Me=new ac.Logger("AwaitQueue");class cc{constructor(){u(this,"pendingTasks",new Map);u(this,"nextTaskId",0);Me.debug("constructor()")}get size(){return this.pendingTasks.size}async push(s,e,t){if(e=e??s.name,Me.debug(`push() [name:${e}, options:%o]`,t),typeof s!="function")throw new TypeError("given task is not a function");if(e)try{Object.defineProperty(s,"name",{value:e})}catch{}return new Promise((i,n)=>{if(e&&(t!=null&&t.removeOngoingTasksWithSameName))for(const a of this.pendingTasks.values())a.name===e&&a.reject(new Ys.AwaitQueueRemovedTaskError,{canExecuteNextTask:!1});const o={id:this.nextTaskId++,task:s,name:e,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:a=>{if(o.completed)return;o.completed=!0,this.pendingTasks.delete(o.id),Me.debug(`resolving task [name:${o.name}]`),i(a);const[c]=this.pendingTasks.values();c&&!c.executedAt&&this.execute(c)},reject:(a,{canExecuteNextTask:c})=>{if(!o.completed&&(o.completed=!0,this.pendingTasks.delete(o.id),Me.debug(`rejecting task [name:${o.name}]: %s`,String(a)),n(a),c)){const[l]=this.pendingTasks.values();l&&!l.executedAt&&this.execute(l)}}};this.pendingTasks.set(o.id,o),this.pendingTasks.size===1&&this.execute(o)})}stop(){Me.debug("stop()");for(const s of this.pendingTasks.values())Me.debug(`stop() | stopping task [name:${s.name}]`),s.reject(new Ys.AwaitQueueStoppedError,{canExecuteNextTask:!1})}remove(s){Me.debug(`remove() [taskIdx:${s}]`);const e=Array.from(this.pendingTasks.values())[s];if(!e){Me.debug(`stop() | no task with given idx [taskIdx:${s}]`);return}e.reject(new Ys.AwaitQueueRemovedTaskError,{canExecuteNextTask:!0})}dump(){const s=Date.now();let e=0;return Array.from(this.pendingTasks.values()).map(t=>({idx:e++,task:t.task,name:t.name,enqueuedTime:t.executedAt?t.executedAt-t.enqueuedAt:s-t.enqueuedAt,executionTime:t.executedAt?s-t.executedAt:0}))}async execute(s){if(Me.debug(`execute() [name:${s.name}]`),s.executedAt)throw new Error("task already being executed");s.executedAt=Date.now();try{const e=await s.task();s.resolve(e)}catch(e){s.reject(e,{canExecuteNextTask:!0})}}}bs.AwaitQueue=cc;(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.AwaitQueueRemovedTaskError=r.AwaitQueueStoppedError=r.AwaitQueue=void 0;var s=bs;Object.defineProperty(r,"AwaitQueue",{enumerable:!0,get:function(){return s.AwaitQueue}});var e=ot;Object.defineProperty(r,"AwaitQueueStoppedError",{enumerable:!0,get:function(){return e.AwaitQueueStoppedError}}),Object.defineProperty(r,"AwaitQueueRemovedTaskError",{enumerable:!0,get:function(){return e.AwaitQueueRemovedTaskError}})})(on);var Cs={};Object.defineProperty(Cs,"__esModule",{value:!0});Cs.Producer=void 0;const dc=Y,di=se,gt=te,ge=new dc.Logger("Producer");class lc extends di.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:i,track:n,rtpParameters:o,stopTracks:a,disableTrackOnPause:c,zeroRtpOnPause:l,appData:d}){super();u(this,"_id");u(this,"_localId");u(this,"_closed",!1);u(this,"_rtpSender");u(this,"_track");u(this,"_kind");u(this,"_rtpParameters");u(this,"_paused");u(this,"_maxSpatialLayer");u(this,"_stopTracks");u(this,"_disableTrackOnPause");u(this,"_zeroRtpOnPause");u(this,"_appData");u(this,"_observer",new di.EnhancedEventEmitter);ge.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=i,this._track=n,this._kind=n.kind,this._rtpParameters=o,this._paused=c?!n.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=a,this._disableTrackOnPause=c,this._zeroRtpOnPause=l,this._appData=d??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(ge.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(ge.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new gt.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(ge.debug("pause()"),this._closed){ge.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@pause",e,t)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(ge.debug("resume()"),this._closed){ge.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@resume",e,t)}).catch(()=>{}),this._observer.safeEmit("resume")}async replaceTrack({track:e}){if(ge.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch{}throw new gt.InvalidStateError("closed")}else if(e&&e.readyState==="ended")throw new gt.InvalidStateError("track ended");if(e===this._track){ge.debug("replaceTrack() | same track, ignored");return}await new Promise((t,i)=>{this.safeEmit("@replacetrack",e,t,i)}),this.destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this.handleTrack()}async setMaxSpatialLayer(e){if(this._closed)throw new gt.InvalidStateError("closed");if(this._kind!=="video")throw new gt.UnsupportedError("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await new Promise((t,i)=>{this.safeEmit("@setmaxspatiallayer",e,t,i)}).catch(()=>{}),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new gt.InvalidStateError("closed");if(typeof e!="object")throw new TypeError("invalid params");await new Promise((t,i)=>{this.safeEmit("@setrtpencodingparameters",e,t,i)})}onTrackEnded(){ge.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track&&this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this.onTrackEnded),this._stopTracks&&this._track.stop()}catch{}}}Cs.Producer=lc;var Rs={};Object.defineProperty(Rs,"__esModule",{value:!0});Rs.Consumer=void 0;const pc=Y,li=se,uc=te,_e=new pc.Logger("Consumer");class hc extends li.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:i,rtpReceiver:n,track:o,rtpParameters:a,appData:c}){super();u(this,"_id");u(this,"_localId");u(this,"_producerId");u(this,"_closed",!1);u(this,"_rtpReceiver");u(this,"_track");u(this,"_rtpParameters");u(this,"_paused");u(this,"_appData");u(this,"_observer",new li.EnhancedEventEmitter);_e.debug("constructor()"),this._id=e,this._localId=t,this._producerId=i,this._rtpReceiver=n,this._track=o,this._rtpParameters=a,this._paused=!o.enabled,this._appData=c??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(_e.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(_e.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new uc.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(_e.debug("pause()"),this._closed){_e.error("pause() | Consumer closed");return}if(this._paused){_e.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(_e.debug("resume()"),this._closed){_e.error("resume() | Consumer closed");return}if(!this._paused){_e.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}onTrackEnded(){_e.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){try{this._track.removeEventListener("ended",this.onTrackEnded),this._track.stop()}catch{}}}Rs.Consumer=hc;var Es={};Object.defineProperty(Es,"__esModule",{value:!0});Es.DataProducer=void 0;const fc=Y,pi=se,mc=te,Oe=new fc.Logger("DataProducer");class gc extends pi.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:i,appData:n}){super();u(this,"_id");u(this,"_dataChannel");u(this,"_closed",!1);u(this,"_sctpStreamParameters");u(this,"_appData");u(this,"_observer",new pi.EnhancedEventEmitter);Oe.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=i,this._appData=n??{},this.handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(Oe.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(Oe.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(Oe.debug("send()"),this._closed)throw new mc.InvalidStateError("closed");this._dataChannel.send(e)}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(Oe.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{var i,n;if(this._closed)return;const t=e.error??new Error("unknown DataChannel error");((i=e.error)==null?void 0:i.errorDetail)==="sctp-failure"?Oe.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",(n=e.error)==null?void 0:n.sctpCauseCode,e.error.message):Oe.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(Oe.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||Oe.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}}Es.DataProducer=gc;var Ts={};Object.defineProperty(Ts,"__esModule",{value:!0});Ts.DataConsumer=void 0;const _c=Y,ui=se,Ke=new _c.Logger("DataConsumer");class vc extends ui.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:i,sctpStreamParameters:n,appData:o}){super();u(this,"_id");u(this,"_dataProducerId");u(this,"_dataChannel");u(this,"_closed",!1);u(this,"_sctpStreamParameters");u(this,"_appData");u(this,"_observer",new ui.EnhancedEventEmitter);Ke.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=i,this._sctpStreamParameters=n,this._appData=o??{},this.handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(Ke.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"),super.close(),this._observer.close())}transportClosed(){this._closed||(Ke.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(Ke.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{var i,n;if(this._closed)return;const t=e.error??new Error("unknown DataChannel error");((i=e.error)==null?void 0:i.errorDetail)==="sctp-failure"?Ke.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",(n=e.error)==null?void 0:n.sctpCauseCode,e.error.message):Ke.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(Ke.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",e=>{this._closed||this.safeEmit("message",e.data)})}}Ts.DataConsumer=vc;Object.defineProperty(ws,"__esModule",{value:!0});ws.Transport=void 0;const yc=on,wc=Y,hi=se,W=te,Xs=Ee,Dt=q,bc=Cs,Sc=Rs,Cc=Es,Rc=Ts,G=new wc.Logger("Transport");class Ec{constructor(s){u(this,"consumerOptions");u(this,"promise");u(this,"resolve");u(this,"reject");this.consumerOptions=s,this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Tc extends hi.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:i,iceCandidates:n,dtlsParameters:o,sctpParameters:a,iceServers:c,iceTransportPolicy:l,additionalSettings:d,appData:p,handlerFactory:h,getSendExtendedRtpCapabilities:m,recvRtpCapabilities:C,canProduceByKind:_}){super();u(this,"_id");u(this,"_closed",!1);u(this,"_direction");u(this,"_getSendExtendedRtpCapabilities");u(this,"_recvRtpCapabilities");u(this,"_canProduceByKind");u(this,"_maxSctpMessageSize");u(this,"_handler");u(this,"_iceGatheringState","new");u(this,"_connectionState","new");u(this,"_appData");u(this,"_producers",new Map);u(this,"_consumers",new Map);u(this,"_dataProducers",new Map);u(this,"_dataConsumers",new Map);u(this,"_probatorConsumerCreated",!1);u(this,"_awaitQueue",new yc.AwaitQueue);u(this,"_pendingConsumerTasks",[]);u(this,"_consumerCreationInProgress",!1);u(this,"_pendingPauseConsumers",new Map);u(this,"_consumerPauseInProgress",!1);u(this,"_pendingResumeConsumers",new Map);u(this,"_consumerResumeInProgress",!1);u(this,"_pendingCloseConsumers",new Map);u(this,"_consumerCloseInProgress",!1);u(this,"_observer",new hi.EnhancedEventEmitter);G.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._getSendExtendedRtpCapabilities=m,this._recvRtpCapabilities=C,this._canProduceByKind=_,this._maxSctpMessageSize=a?a.maxMessageSize:null;const S=Xs.clone(d)??{};delete S.iceServers,delete S.iceTransportPolicy,delete S.bundlePolicy,delete S.rtcpMuxPolicy,this._handler=h.factory({direction:e,iceParameters:i,iceCandidates:n,dtlsParameters:o,sctpParameters:a,iceServers:c,iceTransportPolicy:l,additionalSettings:S,getSendExtendedRtpCapabilities:this._getSendExtendedRtpCapabilities}),this._appData=p??{},this.handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get iceGatheringState(){return this._iceGatheringState}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){if(!this._closed){G.debug("close()"),this._closed=!0,this._awaitQueue.stop(),this._handler.close(),this._connectionState="closed";for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear();for(const e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(const e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close"),super.close(),this._observer.close()}}async getStats(){if(this._closed)throw new W.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(G.debug("restartIce()"),this._closed)throw new W.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>await this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(G.debug("updateIceServers()"),this._closed)throw new W.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(e),"transport.updateIceServers()")}async produce({track:e,encodings:t,codecOptions:i,codec:n,stopTracks:o=!0,disableTrackOnPause:a=!0,zeroRtpOnPause:c=!1,onRtpSender:l,appData:d={}}={}){if(G.debug("produce() [track:%o]",e),this._closed)throw new W.InvalidStateError("closed");if(e){if(this._direction!=="send")throw new W.UnsupportedError("not a sending Transport");if(this._canProduceByKind[e.kind]){if(e.readyState==="ended")throw new W.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(d&&typeof d!="object")throw new TypeError("if given, appData must be an object")}else throw new W.UnsupportedError(`cannot produce ${e.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(async()=>{let p;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&t.length===0?p=void 0:t&&(p=t.map(_=>{const S={active:!0};return _.active===!1&&(S.active=!1),typeof _.dtx=="boolean"&&(S.dtx=_.dtx),typeof _.scalabilityMode=="string"&&(S.scalabilityMode=_.scalabilityMode),typeof _.scaleResolutionDownBy=="number"&&(S.scaleResolutionDownBy=_.scaleResolutionDownBy),typeof _.maxBitrate=="number"&&(S.maxBitrate=_.maxBitrate),typeof _.maxFramerate=="number"&&(S.maxFramerate=_.maxFramerate),typeof _.adaptivePtime=="boolean"&&(S.adaptivePtime=_.adaptivePtime),typeof _.priority=="string"&&(S.priority=_.priority),typeof _.networkPriority=="string"&&(S.networkPriority=_.networkPriority),S}));const{localId:h,rtpParameters:m,rtpSender:C}=await this._handler.send({track:e,encodings:p,codecOptions:i,codec:n,onRtpSender:l});try{Dt.validateAndNormalizeRtpParameters(m);const{id:_}=await new Promise((b,L)=>{this.safeEmit("produce",{kind:e.kind,rtpParameters:m,appData:d},b,L)}),S=new bc.Producer({id:_,localId:h,rtpSender:C,track:e,rtpParameters:m,stopTracks:o,disableTrackOnPause:a,zeroRtpOnPause:c,appData:d});return this._producers.set(S.id,S),this.handleProducer(S),this._observer.safeEmit("newproducer",S),S}catch(_){throw this._handler.stopSending(h).catch(()=>{}),_}},"transport.produce()").catch(p=>{if(o)try{e.stop()}catch{}throw p})}async consume({id:e,producerId:t,kind:i,rtpParameters:n,streamId:o,onRtpReceiver:a,appData:c={}}){if(G.debug("consume()"),this._closed)throw new W.InvalidStateError("closed");if(this._direction!=="recv")throw new W.UnsupportedError("not a receiving Transport");if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing producerId");if(i!=="audio"&&i!=="video")throw new TypeError(`invalid kind '${i}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(c&&typeof c!="object")throw new TypeError("if given, appData must be an object");const l=Xs.clone(n);if(!Dt.canReceive(l,this._recvRtpCapabilities))throw new W.UnsupportedError("cannot consume this Producer");const p=new Ec({id:e,producerId:t,kind:i,rtpParameters:l,streamId:o,onRtpReceiver:a,appData:c});return this._pendingConsumerTasks.push(p),queueMicrotask(()=>{this._closed||this._consumerCreationInProgress===!1&&this.createPendingConsumers()}),p.promise}async produceData({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:i,label:n="",protocol:o="",appData:a={}}={}){if(G.debug("produceData()"),this._closed)throw new W.InvalidStateError("closed");if(this._direction!=="send")throw new W.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new W.UnsupportedError("SCTP not enabled by remote Transport");return(t||i)&&(e=!1),this._awaitQueue.push(async()=>{const{dataChannel:c,sctpStreamParameters:l}=await this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:o});Dt.validateAndNormalizeSctpStreamParameters(l);const{id:d}=await new Promise((h,m)=>{this.safeEmit("producedata",{sctpStreamParameters:l,label:n,protocol:o,appData:a},h,m)}),p=new Cc.DataProducer({id:d,dataChannel:c,sctpStreamParameters:l,appData:a});return this._dataProducers.set(p.id,p),this.handleDataProducer(p),this._observer.safeEmit("newdataproducer",p),p},"transport.produceData()")}async consumeData({id:e,dataProducerId:t,sctpStreamParameters:i,label:n="",protocol:o="",appData:a={}}){if(G.debug("consumeData()"),this._closed)throw new W.InvalidStateError("closed");if(this._direction!=="recv")throw new W.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new W.UnsupportedError("SCTP not enabled by remote Transport");const c=Xs.clone(i);return Dt.validateAndNormalizeSctpStreamParameters(c),this._awaitQueue.push(async()=>{const{dataChannel:l}=await this._handler.receiveDataChannel({sctpStreamParameters:c,label:n,protocol:o}),d=new Rc.DataConsumer({id:e,dataProducerId:t,dataChannel:l,sctpStreamParameters:c,appData:a});return this._dataConsumers.set(d.id,d),this.handleDataConsumer(d),this._observer.safeEmit("newdataconsumer",d),d},"transport.consumeData()")}createPendingConsumers(){this._consumerCreationInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingConsumerTasks.length===0){G.debug("createPendingConsumers() | there is no Consumer to be created");return}const e=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let t;const i=[];for(const n of e){const{id:o,kind:a,rtpParameters:c,streamId:l,onRtpReceiver:d}=n.consumerOptions;i.push({trackId:o,kind:a,rtpParameters:c,streamId:l,onRtpReceiver:d})}try{const n=await this._handler.receive(i);for(let o=0;o<n.length;++o){const a=e[o],c=n[o],{id:l,producerId:d,kind:p,rtpParameters:h,appData:m}=a.consumerOptions,{localId:C,rtpReceiver:_,track:S}=c,b=new Sc.Consumer({id:l,localId:C,producerId:d,rtpReceiver:_,track:S,rtpParameters:h,appData:m});this._consumers.set(b.id,b),this.handleConsumer(b),!this._probatorConsumerCreated&&!t&&p==="video"&&(t=b),this._observer.safeEmit("newconsumer",b),a.resolve(b)}}catch(n){for(const o of e)o.reject(n)}if(t)try{const n=Dt.generateProbatorRtpParameters(t.rtpParameters);await this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:n}]),G.debug("createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(n){G.error("createPendingConsumers() | failed to create Consumer for RTP probation:%o",n)}},"transport.createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this.createPendingConsumers()}).catch(()=>{})}pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingPauseConsumers.size===0){G.debug("pausePendingConsumers() | there is no Consumer to be paused");return}const e=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{const t=e.map(i=>i.localId);await this._handler.pauseReceiving(t)}catch(t){G.error("pausePendingConsumers() | failed to pause Consumers:",t)}},"transport.pausePendingConsumers()").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this.pausePendingConsumers()}).catch(()=>{})}resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingResumeConsumers.size===0){G.debug("resumePendingConsumers() | there is no Consumer to be resumed");return}const e=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{const t=e.map(i=>i.localId);await this._handler.resumeReceiving(t)}catch(t){G.error("resumePendingConsumers() | failed to resume Consumers:",t)}},"transport.resumePendingConsumers()").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this.resumePendingConsumers()}).catch(()=>{})}closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingCloseConsumers.size===0){G.debug("closePendingConsumers() | there is no Consumer to be closed");return}const e=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{await this._handler.stopReceiving(e.map(t=>t.localId))}catch(t){G.error("closePendingConsumers() | failed to close Consumers:",t)}},"transport.closePendingConsumers()").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this.closePendingConsumers()}).catch(()=>{})}handleHandler(){const e=this._handler;e.on("@connect",({dtlsParameters:t},i,n)=>{if(this._closed){n(new W.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:t},i,n)}),e.on("@icegatheringstatechange",t=>{t!==this._iceGatheringState&&(G.debug("ICE gathering state changed to %s",t),this._iceGatheringState=t,this._closed||this.safeEmit("icegatheringstatechange",t))}),e.on("@icecandidateerror",t=>{G.warn(`ICE candidate error [url:${t.url}, localAddress:${t.address}, localPort:${t.port}]: ${t.errorCode} "${t.errorText}"`),this.safeEmit("icecandidateerror",t)}),e.on("@connectionstatechange",t=>{t!==this._connectionState&&(G.debug("connection state changed to %s",t),this._connectionState=t,this._closed||this.safeEmit("connectionstatechange",t))})}handleProducer(e){e.on("@close",()=>{this._producers.delete(e.id),!this._closed&&this._awaitQueue.push(async()=>await this._handler.stopSending(e.localId),"producer @close event").catch(t=>G.warn("producer.close() failed:%o",t))}),e.on("@pause",(t,i)=>{this._awaitQueue.push(async()=>await this._handler.pauseSending(e.localId),"producer @pause event").then(t).catch(i)}),e.on("@resume",(t,i)=>{this._awaitQueue.push(async()=>await this._handler.resumeSending(e.localId),"producer @resume event").then(t).catch(i)}),e.on("@replacetrack",(t,i,n)=>{this._awaitQueue.push(async()=>await this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(i).catch(n)}),e.on("@setmaxspatiallayer",(t,i,n)=>{this._awaitQueue.push(async()=>await this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(i).catch(n)}),e.on("@setrtpencodingparameters",(t,i,n)=>{this._awaitQueue.push(async()=>await this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(i).catch(n)}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new W.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(i)})}handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.delete(e.id),!this._closed&&(this._pendingCloseConsumers.set(e.id,e),this._consumerCloseInProgress===!1&&this.closePendingConsumers())}),e.on("@pause",()=>{this._pendingResumeConsumers.has(e.id)&&this._pendingResumeConsumers.delete(e.id),this._pendingPauseConsumers.set(e.id,e),queueMicrotask(()=>{this._closed||this._consumerPauseInProgress===!1&&this.pausePendingConsumers()})}),e.on("@resume",()=>{this._pendingPauseConsumers.has(e.id)&&this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.set(e.id,e),queueMicrotask(()=>{this._closed||this._consumerResumeInProgress===!1&&this.resumePendingConsumers()})}),e.on("@getstats",(t,i)=>{if(this._closed)return i(new W.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(i)})}handleDataProducer(e){e.on("@close",()=>{this._dataProducers.delete(e.id)})}handleDataConsumer(e){e.on("@close",()=>{this._dataConsumers.delete(e.id)})}}ws.Transport=Tc;var ks={},X={},an={},cn={exports:{}},fi=cn.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(r){var s="candidate:%s %d %s %d %s %d typ %s";return s+=r.raddr!=null?" raddr %s rport %d":"%v%v",s+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(s+=" generation %d"),s+=r["network-id"]!=null?" network-id %d":"%v",s+=r["network-cost"]!=null?" network-cost %d":"%v",s}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(r){var s="ssrc:%d";return r.attribute!=null&&(s+=" %s",r.value!=null&&(s+=":%s")),s}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(r){return r.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(r){var s="mediaclk:";return s+=r.id!=null?"id=%s %s":"%v%s",s+=r.mediaClockValue!=null?"=%s":"",s+=r.rateNumerator!=null?" rate=%s":"",s+=r.rateDenominator!=null?"/%s":"",s}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(fi).forEach(function(r){var s=fi[r];s.forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})});var Er=cn.exports;(function(r){var s=function(a){return String(Number(a))===a?Number(a):a},e=function(a,c,l,d){if(d&&!l)c[d]=s(a[1]);else for(var p=0;p<l.length;p+=1)a[p+1]!=null&&(c[l[p]]=s(a[p+1]))},t=function(a,c,l){var d=a.name&&a.names;a.push&&!c[a.push]?c[a.push]=[]:d&&!c[a.name]&&(c[a.name]={});var p=a.push?{}:d?c[a.name]:c;e(l.match(a.reg),p,a.names,a.name),a.push&&c[a.push].push(p)},i=Er,n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);r.parse=function(a){var c={},l=[],d=c;return a.split(/(\r\n|\r|\n)/).filter(n).forEach(function(p){var h=p[0],m=p.slice(2);h==="m"&&(l.push({rtp:[],fmtp:[]}),d=l[l.length-1]);for(var C=0;C<(i[h]||[]).length;C+=1){var _=i[h][C];if(_.reg.test(m))return t(_,d,m)}}),c.media=l,c};var o=function(a,c){var l=c.split(/=(.+)/,2);return l.length===2?a[l[0]]=s(l[1]):l.length===1&&c.length>1&&(a[l[0]]=void 0),a};r.parseParams=function(a){return a.split(/;\s?/).reduce(o,{})},r.parseFmtpConfig=r.parseParams,r.parsePayloads=function(a){return a.toString().split(" ").map(Number)},r.parseRemoteCandidates=function(a){for(var c=[],l=a.split(" ").map(s),d=0;d<l.length;d+=3)c.push({component:l[d],ip:l[d+1],port:l[d+2]});return c},r.parseImageAttributes=function(a){return a.split(" ").map(function(c){return c.substring(1,c.length-1).split(",").reduce(o,{})})},r.parseSimulcastStreamList=function(a){return a.split(";").map(function(c){return c.split(",").map(function(l){var d,p=!1;return l[0]!=="~"?d=s(l):(d=s(l.substring(1,l.length)),p=!0),{scid:d,paused:p}})})}})(an);var Zs=Er,kc=/%[sdv%]/g,xc=function(r){var s=1,e=arguments,t=e.length;return r.replace(kc,function(i){if(s>=t)return i;var n=e[s];switch(s+=1,i){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}})},Pt=function(r,s,e){var t=s.format instanceof Function?s.format(s.push?e:e[s.name]):s.format,i=[r+"="+t];if(s.names)for(var n=0;n<s.names.length;n+=1){var o=s.names[n];s.name?i.push(e[s.name][o]):i.push(e[s.names[n]])}else i.push(e[s.name]);return xc.apply(null,i)},Dc=["v","o","s","i","u","e","p","c","b","t","r","z","a"],Pc=["i","c","b","a"],Lc=function(r,s){s=s||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(n){n.payloads==null&&(n.payloads="")});var e=s.outerOrder||Dc,t=s.innerOrder||Pc,i=[];return e.forEach(function(n){Zs[n].forEach(function(o){o.name in r&&r[o.name]!=null?i.push(Pt(n,o,r)):o.push in r&&r[o.push]!=null&&r[o.push].forEach(function(a){i.push(Pt(n,o,a))})})}),r.media.forEach(function(n){i.push(Pt("m",Zs.m[0],n)),t.forEach(function(o){Zs[o].forEach(function(a){a.name in n&&n[a.name]!=null?i.push(Pt(o,a,n)):a.push in n&&n[a.push]!=null&&n[a.push].forEach(function(c){i.push(Pt(o,a,c))})})})}),i.join(`\r
`)+`\r
`},at=an,Ic=Lc,Mc=Er;X.grammar=Mc;X.write=Ic;X.parse=at.parse;X.parseParams=at.parseParams;X.parseFmtpConfig=at.parseFmtpConfig;X.parsePayloads=at.parsePayloads;X.parseRemoteCandidates=at.parseRemoteCandidates;X.parseImageAttributes=at.parseImageAttributes;X.parseSimulcastStreamList=at.parseSimulcastStreamList;var Ve={};Object.defineProperty(Ve,"__esModule",{value:!0});Ve.parse=Ac;const Oc=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function Ac(r){const s=Oc.exec(r??"");return s?{spatialLayers:Number(s[1]),temporalLayers:Number(s[2])}:{spatialLayers:1,temporalLayers:1}}var Te={};Object.defineProperty(Te,"__esModule",{value:!0});Te.extractRtpCapabilities=Nc;Te.extractDtlsParameters=jc;Te.getCname=Fc;Te.applyCodecParameters=$c;const dn=X;function Nc({sdpObject:r}){const s=new Map,e=new Map;for(const i of r.media){const n=i.type;switch(n){case"audio":case"video":break;default:continue}for(const o of i.rtp){const a={kind:n,mimeType:`${n}/${o.codec}`,preferredPayloadType:o.payload,clockRate:o.rate,channels:o.encoding,parameters:{},rtcpFeedback:[]};s.set(a.preferredPayloadType,a)}for(const o of i.fmtp??[]){const a=dn.parseParams(o.config),c=s.get(o.payload);c&&(a!=null&&a.hasOwnProperty("profile-level-id")&&(a["profile-level-id"]=String(a["profile-level-id"])),c.parameters=a)}for(const o of i.rtcpFb??[]){const a={type:o.type,parameter:o.subtype};if(a.parameter||delete a.parameter,o.payload!=="*"){const c=s.get(Number(o.payload));if(!c)continue;c.rtcpFeedback.push(a)}else for(const c of s.values())c.kind===n&&!/.+\/rtx$/i.test(c.mimeType)&&c.rtcpFeedback.push(a)}for(const o of i.ext??[]){if(o["encrypt-uri"])continue;const a={kind:n,uri:o.uri,preferredId:o.value};e.set(a.preferredId,a)}}return{codecs:Array.from(s.values()),headerExtensions:Array.from(e.values())}}function jc({sdpObject:r}){let s=r.setup,e=r.fingerprint;if(!s||!e){const n=(r.media??[]).find(o=>o.port!==0);n&&(s=s??n.setup,e=e??n.fingerprint)}if(s){if(!e)throw new Error("no a=fingerprint found at SDP session or media level")}else throw new Error("no a=setup found at SDP session or media level");let t;switch(s){case"active":{t="client";break}case"passive":{t="server";break}case"actpass":{t="auto";break}}return{role:t,fingerprints:[{algorithm:e.type,value:e.hash}]}}function Fc({offerMediaObject:r}){const s=(r.ssrcs??[]).find(e=>e.attribute==="cname");return s?s.value:""}function $c({offerRtpParameters:r,answerMediaObject:s}){var e;for(const t of r.codecs){const i=t.mimeType.toLowerCase();if(i!=="audio/opus"||!(s.rtp??[]).find(c=>c.payload===t.payloadType))continue;s.fmtp=s.fmtp??[];let o=s.fmtp.find(c=>c.payload===t.payloadType);o||(o={payload:t.payloadType,config:""},s.fmtp.push(o));const a=dn.parseParams(o.config);switch(i){case"audio/opus":{const c=(e=t.parameters)==null?void 0:e["sprop-stereo"];c!==void 0&&(a.stereo=Number(c)?1:0);break}}o.config="";for(const c of Object.keys(a))o.config&&(o.config+=";"),o.config+=`${c}=${a[c]}`}}var qe={};Object.defineProperty(qe,"__esModule",{value:!0});qe.getRtpEncodings=Bc;qe.addLegacySimulcast=zc;function Bc({offerMediaObject:r}){const s=new Set;for(const i of r.ssrcs??[]){const n=i.id;n&&s.add(n)}if(s.size===0)throw new Error("no a=ssrc lines found");const e=new Map;for(const i of r.ssrcGroups??[]){if(i.semantics!=="FID")continue;const n=i.ssrcs.split(/\s+/),o=Number(n[0]),a=Number(n[1]);s.has(o)&&(s.delete(o),s.delete(a),e.set(o,a))}for(const i of s)e.set(i,void 0);const t=[];for(const[i,n]of e){const o={ssrc:i};n&&(o.rtx={ssrc:n}),t.push(o)}return t}function zc({offerMediaObject:r,numStreams:s}){if(s<=1)throw new TypeError("numStreams must be greater than 1");const e=(r.ssrcs??[]).find(p=>p.attribute==="msid");if(!e)throw new Error("a=ssrc line with msid information not found");const[t,i]=e.value.split(" "),n=Number(e.id);let o;(r.ssrcGroups??[]).some(p=>{if(p.semantics!=="FID")return!1;const h=p.ssrcs.split(/\s+/);return Number(h[0])===n?(o=Number(h[1]),!0):!1});const a=(r.ssrcs??[]).find(p=>p.attribute==="cname");if(!a)throw new Error("a=ssrc line with cname information not found");const c=a.value,l=[],d=[];for(let p=0;p<s;++p)l.push(n+p),o&&d.push(o+p);r.ssrcGroups=[],r.ssrcs=[],r.ssrcGroups.push({semantics:"SIM",ssrcs:l.join(" ")});for(const p of l)r.ssrcs.push({id:p,attribute:"cname",value:c}),r.ssrcs.push({id:p,attribute:"msid",value:`${t} ${i}`});for(let p=0;p<d.length;++p){const h=l[p],m=d[p];r.ssrcs.push({id:m,attribute:"cname",value:c}),r.ssrcs.push({id:m,attribute:"msid",value:`${t} ${i}`}),r.ssrcGroups.push({semantics:"FID",ssrcs:`${h} ${m}`})}}var Tt={};Object.defineProperty(Tt,"__esModule",{value:!0});Tt.addNackSupportForOpus=Uc;function Uc(r){var s;for(const e of r.codecs??[])(e.mimeType.toLowerCase()==="audio/opus"||e.mimeType.toLowerCase()==="audio/multiopus")&&!((s=e.rtcpFeedback)!=null&&s.some(t=>t.type==="nack"&&!t.parameter))&&(e.rtcpFeedback||(e.rtcpFeedback=[]),e.rtcpFeedback.push({type:"nack"}))}var Ge={},Ue={};Object.defineProperty(Ue,"__esModule",{value:!0});Ue.OfferMediaSection=Ue.AnswerMediaSection=Ue.MediaSection=void 0;const Vc=X,mi=Ee;class Tr{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t}){u(this,"_mediaObject");if(this._mediaObject={type:"",port:0,protocol:"",payloads:"",rtp:[],fmtp:[]},s&&this.setIceParameters(s),e){this._mediaObject.candidates=[];for(const i of e){const n={foundation:i.foundation,component:1,ip:i.address??i.ip,port:i.port,priority:i.priority,transport:i.protocol,type:i.type};i.tcpType&&(n.tcptype=i.tcpType),this._mediaObject.candidates.push(n)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}t&&this.setDtlsRole(t.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(s){this._mediaObject.iceUfrag=s.usernameFragment,this._mediaObject.icePwd=s.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}}Ue.MediaSection=Tr;class qc extends Tr{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t,sctpParameters:i,plainRtpParameters:n,offerMediaObject:o,offerRtpParameters:a,answerRtpParameters:c,codecOptions:l}){switch(super({iceParameters:s,iceCandidates:e,dtlsParameters:t}),this._mediaObject.mid=String(o.mid),this._mediaObject.type=o.type,this._mediaObject.protocol=o.protocol,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),o.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const d of c.codecs){const p={payload:d.payloadType,codec:ln(d),rate:d.clockRate};d.channels>1&&(p.encoding=d.channels),this._mediaObject.rtp.push(p);const h=mi.clone(d.parameters)??{};let m=mi.clone(d.rtcpFeedback)??[];if(l){const{opusStereo:_,opusFec:S,opusDtx:b,opusMaxPlaybackRate:L,opusMaxAverageBitrate:A,opusPtime:F,opusNack:re,videoGoogleStartBitrate:ke,videoGoogleMaxBitrate:xe,videoGoogleMinBitrate:le}=l,ce=a.codecs.find(De=>De.payloadType===d.payloadType);switch(d.mimeType.toLowerCase()){case"audio/opus":case"audio/multiopus":{_!==void 0&&(ce.parameters["sprop-stereo"]=_?1:0,h.stereo=_?1:0),S!==void 0&&(ce.parameters.useinbandfec=S?1:0,h.useinbandfec=S?1:0),b!==void 0&&(ce.parameters.usedtx=b?1:0,h.usedtx=b?1:0),L!==void 0&&(h.maxplaybackrate=L),A!==void 0&&(h.maxaveragebitrate=A),F!==void 0&&(ce.parameters.ptime=F,h.ptime=F),re||(ce.rtcpFeedback=ce.rtcpFeedback.filter(De=>De.type!=="nack"||De.parameter),m=m.filter(De=>De.type!=="nack"||De.parameter));break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":case"video/av1":{ke!==void 0&&(h["x-google-start-bitrate"]=ke),xe!==void 0&&(h["x-google-max-bitrate"]=xe),le!==void 0&&(h["x-google-min-bitrate"]=le);break}}}const C={payload:d.payloadType,config:""};for(const _ of Object.keys(h))C.config&&(C.config+=";"),C.config+=`${_}=${h[_]}`;C.config&&this._mediaObject.fmtp.push(C);for(const _ of m)this._mediaObject.rtcpFb.push({payload:d.payloadType,type:_.type,subtype:_.parameter})}this._mediaObject.payloads=c.codecs.map(d=>d.payloadType).join(" "),this._mediaObject.ext=[];for(const d of c.headerExtensions)(o.ext??[]).some(h=>h.uri===d.uri)&&this._mediaObject.ext.push({uri:d.uri,value:d.id});if(o.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),o.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:o.simulcast.list1},this._mediaObject.rids=[];for(const d of o.rids??[])d.direction==="send"&&this._mediaObject.rids.push({id:d.id,direction:"recv"})}else if(o.simulcast_03){this._mediaObject.simulcast_03={value:o.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const d of o.rids??[])d.direction==="send"&&this._mediaObject.rids.push({id:d.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";break}case"application":{typeof o.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize):o.sctpmap&&(this._mediaObject.payloads=String(i.port),this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize});break}}}setDtlsRole(s){switch(s){case"client":{this._mediaObject.setup="active";break}case"server":{this._mediaObject.setup="passive";break}case"auto":{this._mediaObject.setup="actpass";break}}}resume(){this._mediaObject.direction="recvonly"}muxSimulcastStreams(s){var n,o;if(!((n=this._mediaObject.simulcast)!=null&&n.list1))return;const e={};for(const a of s)a.rid&&(e[a.rid]=a);const t=this._mediaObject.simulcast.list1,i=Vc.parseSimulcastStreamList(t);for(const a of i)for(const c of a)c.paused=!((o=e[c.scid])!=null&&o.active);this._mediaObject.simulcast.list1=i.map(a=>a.map(c=>`${c.paused?"~":""}${c.scid}`).join(",")).join(";")}}Ue.AnswerMediaSection=qc;class Gc extends Tr{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t,sctpParameters:i,plainRtpParameters:n,mid:o,kind:a,offerRtpParameters:c,streamId:l,trackId:d}){var p;switch(super({iceParameters:s,iceCandidates:e,dtlsParameters:t}),this._mediaObject.mid=String(o),this._mediaObject.type=a,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},i?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),this._mediaObject.extmapAllowMixed="extmap-allow-mixed",a){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._mediaObject.msid=`${l??"-"} ${d}`;for(const _ of c.codecs){const S={payload:_.payloadType,codec:ln(_),rate:_.clockRate};_.channels>1&&(S.encoding=_.channels),this._mediaObject.rtp.push(S);const b={payload:_.payloadType,config:""};for(const L of Object.keys(_.parameters??{}))b.config&&(b.config+=";"),b.config+=`${L}=${_.parameters[L]}`;b.config&&this._mediaObject.fmtp.push(b);for(const L of _.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:_.payloadType,type:L.type,subtype:L.parameter})}this._mediaObject.payloads=c.codecs.map(_=>_.payloadType).join(" "),this._mediaObject.ext=[];for(const _ of c.headerExtensions)this._mediaObject.ext.push({uri:_.uri,value:_.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const h=c.encodings[0],m=h.ssrc,C=(p=h.rtx)==null?void 0:p.ssrc;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],m&&c.rtcp.cname&&this._mediaObject.ssrcs.push({id:m,attribute:"cname",value:c.rtcp.cname}),C&&(c.rtcp.cname&&this._mediaObject.ssrcs.push({id:C,attribute:"cname",value:c.rtcp.cname}),m&&this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${m} ${C}`}));break}case"application":{this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize;break}}}setDtlsRole(s){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}}Ue.OfferMediaSection=Gc;function ln(r){const e=new RegExp("^(audio|video)/(.+)","i").exec(r.mimeType);if(!e)throw new TypeError("invalid codec.mimeType");return e[2]}Object.defineProperty(Ge,"__esModule",{value:!0});Ge.RemoteSdp=void 0;const Hc=X,Wc=Y,Zt=Ue,Kc=["av1","h264"],es=new Wc.Logger("RemoteSdp");class Qc{constructor({iceParameters:s,iceCandidates:e,dtlsParameters:t,sctpParameters:i,plainRtpParameters:n}){u(this,"_iceParameters");u(this,"_iceCandidates");u(this,"_dtlsParameters");u(this,"_sctpParameters");u(this,"_plainRtpParameters");u(this,"_mediaSections",[]);u(this,"_midToIndex",new Map);u(this,"_firstMid");u(this,"_sdpObject");if(this._iceParameters=s,this._iceCandidates=e,this._dtlsParameters=t,this._sctpParameters=i,this._plainRtpParameters=n,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:"10000",sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},this._sdpObject.iceOptions="ice2",s!=null&&s.iceLite&&(this._sdpObject.icelite="ice-lite"),t){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const o=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:t.fingerprints[o-1].algorithm,hash:t.fingerprints[o-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}n&&(this._sdpObject.origin.address=n.ip,this._sdpObject.origin.ipVer=n.ipVersion)}updateIceParameters(s){es.debug("updateIceParameters() [iceParameters:%o]",s),this._iceParameters=s,this._sdpObject.icelite=s.iceLite?"ice-lite":void 0;for(const e of this._mediaSections)e.setIceParameters(s)}updateDtlsRole(s){es.debug("updateDtlsRole() [role:%s]",s),this._dtlsParameters.role=s;for(const e of this._mediaSections)e.setDtlsRole(s)}setSessionExtmapAllowMixed(){es.debug("setSessionExtmapAllowMixed()"),this._sdpObject.extmapAllowMixed="extmap-allow-mixed"}getNextMediaSectionIdx(){for(let s=0;s<this._mediaSections.length;++s){const e=this._mediaSections[s];if(e.closed)return{idx:s,reuseMid:e.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:s,reuseMid:e,offerRtpParameters:t,answerRtpParameters:i,codecOptions:n}){var l;const o=new Zt.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:s,offerRtpParameters:t,answerRtpParameters:i,codecOptions:n}),a=o.getObject();a.rtp.find(d=>Kc.includes(d.codec.toLowerCase()))||(a.ext=(l=a.ext)==null?void 0:l.filter(d=>d.uri!=="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension")),e?this._replaceMediaSection(o,e):this._midToIndex.has(o.mid)?this._replaceMediaSection(o):this._addMediaSection(o)}receive({mid:s,kind:e,offerRtpParameters:t,streamId:i,trackId:n}){this.setSessionExtmapAllowMixed();const o=new Zt.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,mid:s,kind:e,offerRtpParameters:t,streamId:i,trackId:n}),a=this._mediaSections.find(c=>c.closed);a?this._replaceMediaSection(o,a.mid):this._addMediaSection(o)}pauseMediaSection(s){this._findMediaSection(s).pause()}resumeSendingMediaSection(s){this._findMediaSection(s).resume()}resumeReceivingMediaSection(s){this._findMediaSection(s).resume()}disableMediaSection(s){this._findMediaSection(s).disable()}closeMediaSection(s){const e=this._findMediaSection(s);return s===this._firstMid?(es.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",s),this.disableMediaSection(s),!1):(e.close(),this._regenerateBundleMids(),!0)}muxMediaSectionSimulcast(s,e){const t=this._findMediaSection(s);t.muxSimulcastStreams(e),this._replaceMediaSection(t)}sendSctpAssociation({offerMediaObject:s}){const e=new Zt.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:s});this._addMediaSection(e)}receiveSctpAssociation(){const s=new Zt.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application"});this._addMediaSection(s)}getSdp(){return this._sdpObject.origin.sessionVersion++,Hc.write(this._sdpObject)}_addMediaSection(s){this._firstMid||(this._firstMid=s.mid),this._mediaSections.push(s),this._midToIndex.set(s.mid,this._mediaSections.length-1),this._sdpObject.media.push(s.getObject()),this._regenerateBundleMids()}_replaceMediaSection(s,e){if(typeof e=="string"){const t=this._midToIndex.get(e);if(t===void 0)throw new Error(`no media section found for reuseMid '${e}'`);const i=this._mediaSections[t];this._mediaSections[t]=s,this._midToIndex.delete(i.mid),this._midToIndex.set(s.mid,t),this._sdpObject.media[t]=s.getObject(),this._regenerateBundleMids()}else{const t=this._midToIndex.get(s.mid);if(t===void 0)throw new Error(`no media section found with mid '${s.mid}'`);this._mediaSections[t]=s,this._sdpObject.media[t]=s.getObject()}}_findMediaSection(s){const e=this._midToIndex.get(s);if(e===void 0)throw new Error(`no media section found with mid '${s}'`);return this._mediaSections[e]}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(s=>!s.closed).map(s=>s.mid).join(" "))}}Ge.RemoteSdp=Qc;Object.defineProperty(ks,"__esModule",{value:!0});ks.Chrome111=void 0;const Fe=X,Jc=se,Yc=Y,Lt=q,Xc=te,Zc=Ve,ts=Te,gi=qe,ed=Tt,td=Ge,P=new Yc.Logger("Chrome111"),_i="Chrome111",vi={OS:1024,MIS:1024};class Ft extends Jc.EnhancedEventEmitter{constructor({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o,iceServers:a,iceTransportPolicy:c,additionalSettings:l,getSendExtendedRtpCapabilities:d}){super();u(this,"_closed",!1);u(this,"_direction");u(this,"_remoteSdp");u(this,"_getSendExtendedRtpCapabilities");u(this,"_forcedLocalDtlsRole");u(this,"_pc");u(this,"_mapMidTransceiver",new Map);u(this,"_sendStream",new MediaStream);u(this,"_hasDataChannelMediaSection",!1);u(this,"_nextSendSctpStreamId",0);u(this,"_transportReady",!1);u(this,"onIceGatheringStateChange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)});u(this,"onIceCandidateError",e=>{this.emit("@icecandidateerror",e)});u(this,"onConnectionStateChange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)});u(this,"onIceConnectionStateChange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}});P.debug("constructor()"),this._direction=e,this._remoteSdp=new td.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o}),this._getSendExtendedRtpCapabilities=d,n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:c??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...l}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(P.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}static createFactory(){return{name:_i,factory:e=>new Ft(e),getNativeRtpCapabilities:async()=>{P.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video",{sendEncodings:[{scalabilityMode:"L3T3"}]});const t=await e.createOffer();try{e.close()}catch{}e=void 0;const i=Fe.parse(t.sdp);return Ft.getLocalRtpCapabilities(i)}catch(t){try{e==null||e.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(P.debug("getNativeSctpCapabilities()"),{numStreams:vi})}}static getLocalRtpCapabilities(e){const t=ts.extractRtpCapabilities({sdpObject:e});return Lt.validateAndNormalizeRtpCapabilities(t),ed.addNackSupportForOpus(t),t}get name(){return _i}close(){if(P.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),P.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),P.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});P.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();P.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n,onRtpSender:o}){if(this.assertNotClosed(),this.assertSendDirection(),P.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1){let L=1;for(const A of t){const F=A.scalabilityMode?(0,Zc.parse)(A.scalabilityMode).temporalLayers:3;F>L&&(L=F)}t.forEach((A,F)=>{A.rid=`r${F}`,A.scalabilityMode=`L1T${L}`})}const a=this._remoteSdp.getNextMediaSectionIdx(),c=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});o&&o(c.sender);const l=await this._pc.createOffer();let d=Fe.parse(l.sdp);d.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const p=Ft.getLocalRtpCapabilities(d),h=this._getSendExtendedRtpCapabilities(p),m=Lt.getSendingRtpParameters(e.kind,h);m.codecs=Lt.reduceCodecs(m.codecs,n);const C=Lt.getSendingRemoteRtpParameters(e.kind,h);C.codecs=Lt.reduceCodecs(C.codecs,n),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:d}),P.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);const _=c.mid;m.mid=_,d=Fe.parse(this._pc.localDescription.sdp);const S=d.media[a.idx];if(m.rtcp.cname=ts.getCname({offerMediaObject:S}),!t)m.encodings=gi.getRtpEncodings({offerMediaObject:S});else if(t.length===1){const L=gi.getRtpEncodings({offerMediaObject:S});Object.assign(L[0],t[0]),m.encodings=L}else m.encodings=t;this._remoteSdp.send({offerMediaObject:S,reuseMid:a.reuseMid,offerRtpParameters:m,answerRtpParameters:C,codecOptions:i});const b={type:"answer",sdp:this._remoteSdp.getSdp()};return P.debug("send() | calling pc.setRemoteDescription() [answer:%o]",b),await this._pc.setRemoteDescription(b),this._mapMidTransceiver.set(_,c),{localId:_,rtpParameters:m,rtpSender:c.sender}}async stopSending(e){if(this.assertSendDirection(),P.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const n=await this._pc.createOffer();P.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),P.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=await this._pc.createOffer();P.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),P.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const i=await this._pc.createOffer();P.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?P.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):P.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),P.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((c,l)=>{l<=t?c.active=!0:c.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const o=await this._pc.createOffer();P.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const a={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),P.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((c,l)=>{n.encodings[l]={...c,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const o=await this._pc.createOffer();P.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const a={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:o}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:o};P.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%vi.MIS,!this._hasDataChannelMediaSection){const d=await this._pc.createOffer(),p=Fe.parse(d.sdp),h=p.media.find(C=>C.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:p}),P.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const m={type:"answer",sdp:this._remoteSdp.getSdp()};P.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}const l={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:l}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],i=new Map;for(const c of e){const{trackId:l,kind:d,rtpParameters:p,streamId:h}=c;P.debug("receive() [trackId:%s, kind:%s]",l,d);const m=p.mid??String(this._mapMidTransceiver.size);i.set(l,m),this._remoteSdp.receive({mid:m,kind:d,offerRtpParameters:p,streamId:h??p.rtcp.cname,trackId:l})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(const c of e){const{trackId:l,onRtpReceiver:d}=c;if(d){const p=i.get(l),h=this._pc.getTransceivers().find(m=>m.mid===p);if(!h)throw new Error("transceiver not found");d(h.receiver)}}let o=await this._pc.createAnswer();const a=Fe.parse(o.sdp);for(const c of e){const{trackId:l,rtpParameters:d}=c,p=i.get(l),h=a.media.find(m=>String(m.mid)===p);ts.applyCodecParameters({offerRtpParameters:d,answerMediaObject:h})}o={type:"answer",sdp:Fe.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),P.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);for(const c of e){const{trackId:l}=c,d=i.get(l),p=this._pc.getTransceivers().find(h=>h.mid===d);if(p)this._mapMidTransceiver.set(d,p),t.push({localId:d,track:p.receiver.track,rtpReceiver:p.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const n of e){P.debug("stopReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(o.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();P.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){P.debug("pauseReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");o.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();P.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){P.debug("resumeReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");o.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();P.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:n,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,l={negotiated:!0,id:n,ordered:o,maxPacketLifeTime:a,maxRetransmits:c,protocol:i};P.debug("receiveDataChannel() [options:%o]",l);const d=this._pc.createDataChannel(t,l);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const p={type:"offer",sdp:this._remoteSdp.getSdp()};P.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),await this._pc.setRemoteDescription(p);const h=await this._pc.createAnswer();if(!this._transportReady){const m=Fe.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:m})}P.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Fe.parse(this._pc.localDescription.sdp));const i=ts.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,o)=>{this.safeEmit("@connect",{dtlsParameters:i},n,o)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Xc.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}ks.Chrome111=Ft;var xs={};Object.defineProperty(xs,"__esModule",{value:!0});xs.Chrome74=void 0;const ve=X,sd=Y,rd=se,It=q,id=te,nd=Ve,ss=Te,er=qe,od=Tt,ad=Ge,x=new sd.Logger("Chrome74"),yi="Chrome74",wi={OS:1024,MIS:1024};class $t extends rd.EnhancedEventEmitter{constructor({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o,iceServers:a,iceTransportPolicy:c,additionalSettings:l,getSendExtendedRtpCapabilities:d}){super();u(this,"_closed",!1);u(this,"_direction");u(this,"_remoteSdp");u(this,"_getSendExtendedRtpCapabilities");u(this,"_forcedLocalDtlsRole");u(this,"_pc");u(this,"_mapMidTransceiver",new Map);u(this,"_sendStream",new MediaStream);u(this,"_hasDataChannelMediaSection",!1);u(this,"_nextSendSctpStreamId",0);u(this,"_transportReady",!1);u(this,"onIceGatheringStateChange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)});u(this,"onIceCandidateError",e=>{this.emit("@icecandidateerror",e)});u(this,"onConnectionStateChange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)});u(this,"onIceConnectionStateChange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}});x.debug("constructor()"),this._direction=e,this._remoteSdp=new ad.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o}),this._getSendExtendedRtpCapabilities=d,n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:c??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...l}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(x.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}static createFactory(){return{name:yi,factory:e=>new $t(e),getNativeRtpCapabilities:async()=>{x.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}e=void 0;const i=ve.parse(t.sdp);return $t.getLocalRtpCapabilities(i)}catch(t){try{e==null||e.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(x.debug("getNativeSctpCapabilities()"),{numStreams:wi})}}static getLocalRtpCapabilities(e){const t=ss.extractRtpCapabilities({sdpObject:e});return It.validateAndNormalizeRtpCapabilities(t),od.addNackSupportForOpus(t),t}get name(){return yi}close(){if(x.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),x.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),x.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});x.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();x.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n}){this.assertNotClosed(),this.assertSendDirection(),x.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((A,F)=>{A.rid=`r${F}`});const o=this._remoteSdp.getNextMediaSectionIdx(),a=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});let c=await this._pc.createOffer(),l=ve.parse(c.sdp);l.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const d=$t.getLocalRtpCapabilities(l),p=this._getSendExtendedRtpCapabilities(d),h=It.getSendingRtpParameters(e.kind,p);h.codecs=It.reduceCodecs(h.codecs,n);const m=It.getSendingRemoteRtpParameters(e.kind,p);m.codecs=It.reduceCodecs(m.codecs,n),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l});let C=!1;const _=(0,nd.parse)((t??[{}])[0].scalabilityMode);let S;t&&t.length===1&&_.spatialLayers>1&&h.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(x.debug("send() | enabling legacy simulcast for VP9 SVC"),C=!0,l=ve.parse(c.sdp),S=l.media[o.idx],er.addLegacySimulcast({offerMediaObject:S,numStreams:_.spatialLayers}),c={type:"offer",sdp:ve.write(l)}),x.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);const b=a.mid;if(h.mid=b,l=ve.parse(this._pc.localDescription.sdp),S=l.media[o.idx],h.rtcp.cname=ss.getCname({offerMediaObject:S}),!t)h.encodings=er.getRtpEncodings({offerMediaObject:S});else if(t.length===1){let A=er.getRtpEncodings({offerMediaObject:S});Object.assign(A[0],t[0]),C&&(A=[A[0]]),h.encodings=A}else h.encodings=t;if(h.encodings.length>1&&(h.codecs[0].mimeType.toLowerCase()==="video/vp8"||h.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const A of h.encodings)A.scalabilityMode?A.scalabilityMode=`L1T${_.temporalLayers}`:A.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:S,reuseMid:o.reuseMid,offerRtpParameters:h,answerRtpParameters:m,codecOptions:i});const L={type:"answer",sdp:this._remoteSdp.getSdp()};return x.debug("send() | calling pc.setRemoteDescription() [answer:%o]",L),await this._pc.setRemoteDescription(L),this._mapMidTransceiver.set(b,a),{localId:b,rtpParameters:h,rtpSender:a.sender}}async stopSending(e){if(this.assertSendDirection(),x.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const n=await this._pc.createOffer();x.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),x.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=await this._pc.createOffer();x.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),x.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const i=await this._pc.createOffer();x.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?x.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):x.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),x.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((c,l)=>{l<=t?c.active=!0:c.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const o=await this._pc.createOffer();x.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const a={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),x.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((c,l)=>{n.encodings[l]={...c,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const o=await this._pc.createOffer();x.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const a={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:o}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:o};x.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%wi.MIS,!this._hasDataChannelMediaSection){const d=await this._pc.createOffer(),p=ve.parse(d.sdp),h=p.media.find(C=>C.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:p}),x.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const m={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}const l={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:l}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],i=new Map;for(const c of e){const{trackId:l,kind:d,rtpParameters:p,streamId:h}=c;x.debug("receive() [trackId:%s, kind:%s]",l,d);const m=p.mid??String(this._mapMidTransceiver.size);i.set(l,m),this._remoteSdp.receive({mid:m,kind:d,offerRtpParameters:p,streamId:h??p.rtcp.cname,trackId:l})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let o=await this._pc.createAnswer();const a=ve.parse(o.sdp);for(const c of e){const{trackId:l,rtpParameters:d}=c,p=i.get(l),h=a.media.find(m=>String(m.mid)===p);ss.applyCodecParameters({offerRtpParameters:d,answerMediaObject:h})}o={type:"answer",sdp:ve.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),x.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);for(const c of e){const{trackId:l}=c,d=i.get(l),p=this._pc.getTransceivers().find(h=>h.mid===d);if(p)this._mapMidTransceiver.set(d,p),t.push({localId:d,track:p.receiver.track,rtpReceiver:p.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const n of e){x.debug("stopReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(o.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();x.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){x.debug("pauseReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");o.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();x.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){x.debug("resumeReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");o.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();x.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:n,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,l={negotiated:!0,id:n,ordered:o,maxPacketLifeTime:a,maxRetransmits:c,protocol:i};x.debug("receiveDataChannel() [options:%o]",l);const d=this._pc.createDataChannel(t,l);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const p={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),await this._pc.setRemoteDescription(p);const h=await this._pc.createAnswer();if(!this._transportReady){const m=ve.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:m})}x.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ve.parse(this._pc.localDescription.sdp));const i=ss.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,o)=>{this.safeEmit("@connect",{dtlsParameters:i},n,o)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new id.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}xs.Chrome74=$t;var Ds={};Object.defineProperty(Ds,"__esModule",{value:!0});Ds.Firefox120=void 0;const $e=X,cd=se,dd=Y,bi=te,Mt=q,ld=Ve,rs=Te,Si=qe,pd=Ge,I=new dd.Logger("Firefox120"),Ci="Firefox120",Ri={OS:16,MIS:2048};class Bt extends cd.EnhancedEventEmitter{constructor({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o,iceServers:a,iceTransportPolicy:c,additionalSettings:l,getSendExtendedRtpCapabilities:d}){super();u(this,"_closed",!1);u(this,"_direction");u(this,"_remoteSdp");u(this,"_getSendExtendedRtpCapabilities");u(this,"_pc");u(this,"_mapMidTransceiver",new Map);u(this,"_sendStream",new MediaStream);u(this,"_hasDataChannelMediaSection",!1);u(this,"_nextSendSctpStreamId",0);u(this,"_transportReady",!1);u(this,"onIceGatheringStateChange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)});u(this,"onIceCandidateError",e=>{this.emit("@icecandidateerror",e)});u(this,"onConnectionStateChange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)});u(this,"onIceConnectionStateChange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}});I.debug("constructor()"),this._direction=e,this._remoteSdp=new pd.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o}),this._getSendExtendedRtpCapabilities=d,this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:c??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...l}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(I.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}static createFactory(){return{name:Ci,factory:e=>new Bt(e),getNativeRtpCapabilities:async()=>{I.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});const t=document.createElement("canvas");t.getContext("2d");const n=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"}),e.addTransceiver(n,{direction:"sendrecv",sendEncodings:[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}]});const o=await e.createOffer();try{t.remove()}catch{}try{n.stop()}catch{}try{e.close()}catch{}e=void 0;const a=$e.parse(o.sdp);return Bt.getLocalRtpCapabilities(a)}catch(o){try{t.remove()}catch{}try{n.stop()}catch{}try{e==null||e.close()}catch{}throw e=void 0,o}},getNativeSctpCapabilities:async()=>(I.debug("getNativeSctpCapabilities()"),{numStreams:Ri})}}static getLocalRtpCapabilities(e){const t=rs.extractRtpCapabilities({sdpObject:e});return Mt.validateAndNormalizeRtpCapabilities(t),t}get name(){return Ci}close(){if(I.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){throw this.assertNotClosed(),new bi.UnsupportedError("not supported")}async restartIce(e){if(this.assertNotClosed(),I.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});I.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();I.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n,onRtpSender:o}){this.assertNotClosed(),this.assertSendDirection(),I.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((L,A)=>{L.rid=`r${A}`});const a=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});o&&o(a.sender);const c=await this._pc.createOffer();let l=$e.parse(c.sdp);l.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const d=Bt.getLocalRtpCapabilities(l),p=this._getSendExtendedRtpCapabilities(d),h=Mt.getSendingRtpParameters(e.kind,p);h.codecs=Mt.reduceCodecs(h.codecs,n);const m=Mt.getSendingRemoteRtpParameters(e.kind,p);m.codecs=Mt.reduceCodecs(m.codecs,n),this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:l});const C=(0,ld.parse)((t??[{}])[0].scalabilityMode);I.debug("send() | calling pc.setLocalDescription() [offer:%o]",c),await this._pc.setLocalDescription(c);const _=a.mid;h.mid=_,l=$e.parse(this._pc.localDescription.sdp);const S=l.media[l.media.length-1];if(h.rtcp.cname=rs.getCname({offerMediaObject:S}),!t)h.encodings=Si.getRtpEncodings({offerMediaObject:S});else if(t.length===1){const L=Si.getRtpEncodings({offerMediaObject:S});Object.assign(L[0],t[0]),h.encodings=L}else h.encodings=t;if(h.encodings.length>1&&(h.codecs[0].mimeType.toLowerCase()==="video/vp8"||h.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const L of h.encodings)L.scalabilityMode?L.scalabilityMode=`L1T${C.temporalLayers}`:L.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:S,offerRtpParameters:h,answerRtpParameters:m,codecOptions:i});const b={type:"answer",sdp:this._remoteSdp.getSdp()};return I.debug("send() | calling pc.setRemoteDescription() [answer:%o]",b),await this._pc.setRemoteDescription(b),this._mapMidTransceiver.set(_,a),{localId:_,rtpParameters:h,rtpSender:a.sender}}async stopSending(e){if(this.assertSendDirection(),I.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const i=await this._pc.createOffer();I.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),I.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=await this._pc.createOffer();I.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),I.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const i=await this._pc.createOffer();I.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?I.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):I.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),I.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated transceiver not found");const n=i.sender.getParameters();n.encodings.forEach((c,l)=>{l<=t?c.active=!0:c.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const o=await this._pc.createOffer();I.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const a={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),I.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((c,l)=>{n.encodings[l]={...c,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const o=await this._pc.createOffer();I.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const a={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:o}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:o};I.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ri.MIS,!this._hasDataChannelMediaSection){const d=await this._pc.createOffer(),p=$e.parse(d.sdp),h=p.media.find(C=>C.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:p}),I.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const m={type:"answer",sdp:this._remoteSdp.getSdp()};I.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}const l={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:l}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],i=new Map;for(const c of e){const{trackId:l,kind:d,rtpParameters:p,streamId:h}=c;I.debug("receive() [trackId:%s, kind:%s]",l,d);const m=p.mid??String(this._mapMidTransceiver.size);i.set(l,m),this._remoteSdp.receive({mid:m,kind:d,offerRtpParameters:p,streamId:h??p.rtcp.cname,trackId:l})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(const c of e){const{trackId:l,onRtpReceiver:d}=c;if(d){const p=i.get(l),h=this._pc.getTransceivers().find(m=>m.mid===p);if(!h)throw new Error("transceiver not found");d(h.receiver)}}let o=await this._pc.createAnswer();const a=$e.parse(o.sdp);for(const c of e){const{trackId:l,rtpParameters:d}=c,p=i.get(l),h=a.media.find(m=>String(m.mid)===p);rs.applyCodecParameters({offerRtpParameters:d,answerMediaObject:h}),o={type:"answer",sdp:$e.write(a)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:a}),I.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);for(const c of e){const{trackId:l}=c,d=i.get(l),p=this._pc.getTransceivers().find(h=>h.mid===d);if(!p)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(d,p),t.push({localId:d,track:p.receiver.track,rtpReceiver:p.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const n of e){I.debug("stopReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(o.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();I.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){I.debug("pauseReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");o.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();I.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){I.debug("resumeReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");o.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();I.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:n,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,l={negotiated:!0,id:n,ordered:o,maxPacketLifeTime:a,maxRetransmits:c,protocol:i};I.debug("receiveDataChannel() [options:%o]",l);const d=this._pc.createDataChannel(t,l);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const p={type:"offer",sdp:this._remoteSdp.getSdp()};I.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),await this._pc.setRemoteDescription(p);const h=await this._pc.createAnswer();if(!this._transportReady){const m=$e.parse(h.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:m})}I.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=$e.parse(this._pc.localDescription.sdp));const i=rs.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,o)=>{this.safeEmit("@connect",{dtlsParameters:i},n,o)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new bi.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Ds.Firefox120=Bt;var Ps={};Object.defineProperty(Ps,"__esModule",{value:!0});Ps.Safari12=void 0;const ye=X,ud=se,hd=Y,Ot=q,fd=te,md=Ve,gd=Ge,is=Te,Ei=qe,_d=Tt,D=new hd.Logger("Safari12"),Ti="Safari12",ki={OS:1024,MIS:1024};class zt extends ud.EnhancedEventEmitter{constructor({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o,iceServers:a,iceTransportPolicy:c,additionalSettings:l,getSendExtendedRtpCapabilities:d}){super();u(this,"_closed",!1);u(this,"_direction");u(this,"_remoteSdp");u(this,"_getSendExtendedRtpCapabilities");u(this,"_forcedLocalDtlsRole");u(this,"_pc");u(this,"_mapMidTransceiver",new Map);u(this,"_sendStream",new MediaStream);u(this,"_hasDataChannelMediaSection",!1);u(this,"_nextSendSctpStreamId",0);u(this,"_transportReady",!1);u(this,"onIceGatheringStateChange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)});u(this,"onIceCandidateError",e=>{this.emit("@icecandidateerror",e)});u(this,"onConnectionStateChange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)});u(this,"onIceConnectionStateChange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}});D.debug("constructor()"),this._direction=e,this._remoteSdp=new gd.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o}),this._getSendExtendedRtpCapabilities=d,n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:c??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...l}),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.addEventListener("icecandidateerror",p=>{this.emit("@icecandidateerror",p)}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(D.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}static createFactory(){return{name:Ti,factory:e=>new zt(e),getNativeRtpCapabilities:async()=>{D.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}e=void 0;const i=ye.parse(t.sdp);return zt.getLocalRtpCapabilities(i)}catch(t){try{e==null||e.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(D.debug("getNativeSctpCapabilities()"),{numStreams:ki})}}static getLocalRtpCapabilities(e){const t=is.extractRtpCapabilities({sdpObject:e});return Ot.validateAndNormalizeRtpCapabilities(t),_d.addNackSupportForOpus(t),t}get name(){return Ti}close(){if(D.debug("close()"),!this._closed){this._closed=!0;try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),D.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),D.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});D.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();D.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n,onRtpSender:o}){this.assertNotClosed(),this.assertSendDirection(),D.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const a=this._remoteSdp.getNextMediaSectionIdx(),c=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});o&&o(c.sender);let l=await this._pc.createOffer(),d=ye.parse(l.sdp);d.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const p=zt.getLocalRtpCapabilities(d),h=this._getSendExtendedRtpCapabilities(p),m=Ot.getSendingRtpParameters(e.kind,h);m.codecs=Ot.reduceCodecs(m.codecs,n);const C=Ot.getSendingRemoteRtpParameters(e.kind,h);C.codecs=Ot.reduceCodecs(C.codecs,n);let _;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:d});const S=(0,md.parse)((t??[{}])[0].scalabilityMode);t&&t.length>1&&(D.debug("send() | enabling legacy simulcast"),d=ye.parse(l.sdp),_=d.media[a.idx],Ei.addLegacySimulcast({offerMediaObject:_,numStreams:t.length}),l={type:"offer",sdp:ye.write(d)}),D.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);const b=c.mid;if(m.mid=b,d=ye.parse(this._pc.localDescription.sdp),_=d.media[a.idx],m.rtcp.cname=is.getCname({offerMediaObject:_}),m.encodings=Ei.getRtpEncodings({offerMediaObject:_}),t)for(let A=0;A<m.encodings.length;++A)t[A]&&Object.assign(m.encodings[A],t[A]);if(m.encodings.length>1&&(m.codecs[0].mimeType.toLowerCase()==="video/vp8"||m.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const A of m.encodings)A.scalabilityMode?A.scalabilityMode=`L1T${S.temporalLayers}`:A.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:_,reuseMid:a.reuseMid,offerRtpParameters:m,answerRtpParameters:C,codecOptions:i});const L={type:"answer",sdp:this._remoteSdp.getSdp()};return D.debug("send() | calling pc.setRemoteDescription() [answer:%o]",L),await this._pc.setRemoteDescription(L),this._mapMidTransceiver.set(b,c),{localId:b,rtpParameters:m,rtpSender:c.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;D.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const n=await this._pc.createOffer();D.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),D.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=await this._pc.createOffer();D.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),D.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const i=await this._pc.createOffer();D.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?D.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):D.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),D.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((c,l)=>{l<=t?c.active=!0:c.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const o=await this._pc.createOffer();D.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const a={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),D.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((c,l)=>{n.encodings[l]={...c,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const o=await this._pc.createOffer();D.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const a={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:o}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:o};D.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%ki.MIS,!this._hasDataChannelMediaSection){const d=await this._pc.createOffer(),p=ye.parse(d.sdp),h=p.media.find(C=>C.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:p}),D.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const m={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}const l={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:l}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],i=new Map;for(const c of e){const{trackId:l,kind:d,rtpParameters:p,streamId:h}=c;D.debug("receive() [trackId:%s, kind:%s]",l,d);const m=p.mid??String(this._mapMidTransceiver.size);i.set(l,m),this._remoteSdp.receive({mid:m,kind:d,offerRtpParameters:p,streamId:h??p.rtcp.cname,trackId:l})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(const c of e){const{trackId:l,onRtpReceiver:d}=c;if(d){const p=i.get(l),h=this._pc.getTransceivers().find(m=>m.mid===p);if(!h)throw new Error("transceiver not found");d(h.receiver)}}let o=await this._pc.createAnswer();const a=ye.parse(o.sdp);for(const c of e){const{trackId:l,rtpParameters:d}=c,p=i.get(l),h=a.media.find(m=>String(m.mid)===p);is.applyCodecParameters({offerRtpParameters:d,answerMediaObject:h})}o={type:"answer",sdp:ye.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),D.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);for(const c of e){const{trackId:l}=c,d=i.get(l),p=this._pc.getTransceivers().find(h=>h.mid===d);if(!p)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(d,p),t.push({localId:d,track:p.receiver.track,rtpReceiver:p.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const n of e){D.debug("stopReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(o.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();D.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){D.debug("pauseReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");o.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();D.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){D.debug("resumeReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");o.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();D.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:n,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,l={negotiated:!0,id:n,ordered:o,maxPacketLifeTime:a,maxRetransmits:c,protocol:i};D.debug("receiveDataChannel() [options:%o]",l);const d=this._pc.createDataChannel(t,l);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const p={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),await this._pc.setRemoteDescription(p);const h=await this._pc.createAnswer();if(!this._transportReady){const m=ye.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:m})}D.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ye.parse(this._pc.localDescription.sdp));const i=is.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,o)=>{this.safeEmit("@connect",{dtlsParameters:i},n,o)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new fd.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Ps.Safari12=zt;var Ls={};Object.defineProperty(Ls,"__esModule",{value:!0});Ls.ReactNative106=void 0;const we=X,vd=se,yd=Y,At=q,wd=te,bd=Ve,Sd=Ge,ns=Te,tr=qe,Cd=Tt,T=new yd.Logger("ReactNative106"),xi="ReactNative106",Di={OS:1024,MIS:1024};class Ut extends vd.EnhancedEventEmitter{constructor({direction:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o,iceServers:a,iceTransportPolicy:c,additionalSettings:l,getSendExtendedRtpCapabilities:d}){super();u(this,"_closed",!1);u(this,"_direction");u(this,"_remoteSdp");u(this,"_getSendExtendedRtpCapabilities");u(this,"_forcedLocalDtlsRole");u(this,"_pc");u(this,"_mapMidTransceiver",new Map);u(this,"_sendStream",new MediaStream);u(this,"_hasDataChannelMediaSection",!1);u(this,"_nextSendSctpStreamId",0);u(this,"_transportReady",!1);u(this,"onIceGatheringStateChange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)});u(this,"onIceCandidateError",e=>{this.emit("@icecandidateerror",e)});u(this,"onConnectionStateChange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)});u(this,"onIceConnectionStateChange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}});T.debug("constructor()"),this._direction=e,this._remoteSdp=new Sd.RemoteSdp({iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o}),this._getSendExtendedRtpCapabilities=d,n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a??[],iceTransportPolicy:c??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...l}),this._pc.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.addEventListener("icecandidateerror",this.onIceCandidateError),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",this.onConnectionStateChange):(T.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange))}static createFactory(){return{name:xi,factory:e=>new Ut(e),getNativeRtpCapabilities:async()=>{T.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}e=void 0;const i=we.parse(t.sdp);return Ut.getLocalRtpCapabilities(i)}catch(t){try{e==null||e.close()}catch{}throw e=void 0,t}},getNativeSctpCapabilities:async()=>(T.debug("getNativeSctpCapabilities()"),{numStreams:Di})}}static getLocalRtpCapabilities(e){const t=ns.extractRtpCapabilities({sdpObject:e});return At.validateAndNormalizeRtpCapabilities(t),Cd.addNackSupportForOpus(t),t}get name(){return xi}close(){if(T.debug("close()"),!this._closed){this._closed=!0,this._sendStream.release(!1);try{this._pc.close()}catch{}this._pc.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),this._pc.removeEventListener("icecandidateerror",this.onIceCandidateError),this._pc.removeEventListener("connectionstatechange",this.onConnectionStateChange),this._pc.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),this.emit("@close"),super.close()}}async updateIceServers(e){this.assertNotClosed(),T.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),T.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});T.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const i={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();T.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:i,codec:n,onRtpSender:o}){this.assertNotClosed(),this.assertSendDirection(),T.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((F,re)=>{F.rid=`r${re}`});const a=this._remoteSdp.getNextMediaSectionIdx(),c=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});o&&o(c.sender);let l=await this._pc.createOffer(),d=we.parse(l.sdp);d.extmapAllowMixed&&this._remoteSdp.setSessionExtmapAllowMixed();const p=Ut.getLocalRtpCapabilities(d),h=this._getSendExtendedRtpCapabilities(p),m=At.getSendingRtpParameters(e.kind,h);m.codecs=At.reduceCodecs(m.codecs,n);const C=At.getSendingRemoteRtpParameters(e.kind,h);C.codecs=At.reduceCodecs(C.codecs,n),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:d});let _=!1;const S=(0,bd.parse)((t??[{}])[0].scalabilityMode);let b;t&&t.length===1&&S.spatialLayers>1&&m.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(T.debug("send() | enabling legacy simulcast for VP9 SVC"),_=!0,d=we.parse(l.sdp),b=d.media[a.idx],tr.addLegacySimulcast({offerMediaObject:b,numStreams:S.spatialLayers}),l={type:"offer",sdp:we.write(d)}),T.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);let L=c.mid??void 0;if(L||T.warn("send() | missing transceiver.mid (bug in react-native-webrtc, using a workaround"),m.mid=L,d=we.parse(this._pc.localDescription.sdp),b=d.media[a.idx],m.rtcp.cname=ns.getCname({offerMediaObject:b}),!t)m.encodings=tr.getRtpEncodings({offerMediaObject:b});else if(t.length===1){let F=tr.getRtpEncodings({offerMediaObject:b});Object.assign(F[0],t[0]),_&&(F=[F[0]]),m.encodings=F}else m.encodings=t;if(m.encodings.length>1&&(m.codecs[0].mimeType.toLowerCase()==="video/vp8"||m.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const F of m.encodings)F.scalabilityMode?F.scalabilityMode=`L1T${S.temporalLayers}`:F.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:b,reuseMid:a.reuseMid,offerRtpParameters:m,answerRtpParameters:C,codecOptions:i});const A={type:"answer",sdp:this._remoteSdp.getSdp()};return T.debug("send() | calling pc.setRemoteDescription() [answer:%o]",A),await this._pc.setRemoteDescription(A),L||(L=c.mid,m.mid=L),this._mapMidTransceiver.set(L,c),{localId:L,rtpParameters:m,rtpSender:c.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;T.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const n=await this._pc.createOffer();T.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),T.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const i=await this._pc.createOffer();T.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),T.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const i=await this._pc.createOffer();T.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?T.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):T.debug("replaceTrack() [localId:%s, no track]",e);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");await i.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),T.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((c,l)=>{l<=t?c.active=!0:c.active=!1}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const o=await this._pc.createOffer();T.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const a={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),T.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const i=this._mapMidTransceiver.get(e);if(!i)throw new Error("associated RTCRtpTransceiver not found");const n=i.sender.getParameters();n.encodings.forEach((c,l)=>{n.encodings[l]={...c,...t}}),await i.sender.setParameters(n),this._remoteSdp.muxMediaSectionSimulcast(e,n.encodings);const o=await this._pc.createOffer();T.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",o),await this._pc.setLocalDescription(o);const a={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:o}){this.assertNotClosed(),this.assertSendDirection();const a={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,protocol:o};T.debug("sendDataChannel() [options:%o]",a);const c=this._pc.createDataChannel(n,a);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Di.MIS,!this._hasDataChannelMediaSection){const d=await this._pc.createOffer(),p=we.parse(d.sdp),h=p.media.find(C=>C.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:p}),T.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});const m={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._hasDataChannelMediaSection=!0}const l={streamId:a.id,ordered:a.ordered,maxPacketLifeTime:a.maxPacketLifeTime,maxRetransmits:a.maxRetransmits};return{dataChannel:c,sctpStreamParameters:l}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],i=new Map;for(const c of e){const{trackId:l,kind:d,rtpParameters:p,streamId:h}=c;T.debug("receive() [trackId:%s, kind:%s]",l,d);const m=p.mid??String(this._mapMidTransceiver.size);i.set(l,m),this._remoteSdp.receive({mid:m,kind:d,offerRtpParameters:p,streamId:h??p.rtcp.cname,trackId:l})}const n={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);for(const c of e){const{trackId:l,onRtpReceiver:d}=c;if(d){const p=i.get(l),h=this._pc.getTransceivers().find(m=>m.mid===p);if(!h)throw new Error("transceiver not found");d(h.receiver)}}let o=await this._pc.createAnswer();const a=we.parse(o.sdp);for(const c of e){const{trackId:l,rtpParameters:d}=c,p=i.get(l),h=a.media.find(m=>String(m.mid)===p);ns.applyCodecParameters({offerRtpParameters:d,answerMediaObject:h})}o={type:"answer",sdp:we.write(a)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),T.debug("receive() | calling pc.setLocalDescription() [answer:%o]",o),await this._pc.setLocalDescription(o);for(const c of e){const{trackId:l}=c,d=i.get(l),p=this._pc.getTransceivers().find(h=>h.mid===d);if(p)this._mapMidTransceiver.set(d,p),t.push({localId:d,track:p.receiver.track,rtpReceiver:p.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const n of e){T.debug("stopReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(o.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();T.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){T.debug("pauseReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");o.direction="inactive",this._remoteSdp.pauseMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();T.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const n of e){T.debug("resumeReceiving() [localId:%s]",n);const o=this._mapMidTransceiver.get(n);if(!o)throw new Error("associated RTCRtpTransceiver not found");o.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const i=await this._pc.createAnswer();T.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:n,ordered:o,maxPacketLifeTime:a,maxRetransmits:c}=e,l={negotiated:!0,id:n,ordered:o,maxPacketLifeTime:a,maxRetransmits:c,protocol:i};T.debug("receiveDataChannel() [options:%o]",l);const d=this._pc.createDataChannel(t,l);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const p={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),await this._pc.setRemoteDescription(p);const h=await this._pc.createAnswer();if(!this._transportReady){const m=we.parse(h.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:m})}T.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=we.parse(this._pc.localDescription.sdp));const i=ns.extractDtlsParameters({sdpObject:t});i.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,o)=>{this.safeEmit("@connect",{dtlsParameters:i},n,o)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new wd.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}Ls.ReactNative106=Ut;Object.defineProperty(Et,"__esModule",{value:!0});Et.Device=void 0;Et.detectDevice=pn;Et.detectDeviceAsync=un;const Rd=Y,Ed=se,Qe=te,sr=Ee,Ae=q,Td=ws,kd=ks,xd=xs,Dd=Ds,Pd=Ps,Ld=Ls,k=new Rd.Logger("Device");function pn(r,s){return k.debug("detectDevice()"),!r&&typeof navigator=="object"&&(r=navigator.userAgent),!s&&typeof navigator=="object"&&(s=navigator.userAgentData),hn(r,s)}async function un(r,s){return k.debug("detectDeviceAsync()"),!r&&typeof navigator=="object"&&(r=navigator.userAgent),!s&&typeof navigator=="object"&&(s=navigator.userAgentData),hn(r,s)}class kr{constructor({handlerName:s,handlerFactory:e}={}){u(this,"_handlerFactory");u(this,"_handlerName");u(this,"_loaded",!1);u(this,"_getSendExtendedRtpCapabilities");u(this,"_recvRtpCapabilities");u(this,"_canProduceByKind",{audio:!1,video:!1});u(this,"_sctpCapabilities");u(this,"_observer",new Ed.EnhancedEventEmitter);if(k.debug("constructor()"),s&&e)throw new TypeError("just one of handlerName or handlerInterface can be given");if(e)this._handlerFactory=e;else{if(s)k.debug("constructor() | handler given: %s",s);else if(s=pn(),s)k.debug("constructor() | detected handler: %s",s);else throw new Qe.UnsupportedError("device not supported");switch(s){case"Chrome111":{this._handlerFactory=kd.Chrome111.createFactory();break}case"Chrome74":{this._handlerFactory=xd.Chrome74.createFactory();break}case"Firefox120":{this._handlerFactory=Dd.Firefox120.createFactory();break}case"Safari12":{this._handlerFactory=Pd.Safari12.createFactory();break}case"ReactNative106":{this._handlerFactory=Ld.ReactNative106.createFactory();break}default:throw new TypeError(`unknown handlerName "${s}"`)}}this._handlerName=this._handlerFactory.name}static async factory({handlerName:s,handlerFactory:e}={}){if(k.debug("factory()"),s&&e)throw new TypeError("just one of handlerName or handlerInterface can be given");if(!s&&!e&&(s=await un(),!s))throw new Qe.UnsupportedError("device not supported");return new kr({handlerName:s,handlerFactory:e})}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new Qe.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new Qe.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:s,preferLocalCodecsOrder:e=!1}){if(k.debug("load() [routerRtpCapabilities:%o]",s),this._loaded)throw new Qe.InvalidStateError("already loaded");const t=sr.clone(s);Ae.validateAndNormalizeRtpCapabilities(t);const{getNativeRtpCapabilities:i,getNativeSctpCapabilities:n}=this._handlerFactory,o=sr.clone(await i());Ae.validateAndNormalizeRtpCapabilities(o),k.debug("load() | got native RTP capabilities:%o",o),this._getSendExtendedRtpCapabilities=c=>sr.clone(Ae.getExtendedRtpCapabilities(c,t,e));const a=Ae.getExtendedRtpCapabilities(o,t,!1);this._recvRtpCapabilities=Ae.getRecvRtpCapabilities(a),Ae.validateAndNormalizeRtpCapabilities(this._recvRtpCapabilities),k.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._canProduceByKind.audio=Ae.canSend("audio",this._recvRtpCapabilities),this._canProduceByKind.video=Ae.canSend("video",this._recvRtpCapabilities),this._sctpCapabilities=await n(),Ae.validateSctpCapabilities(this._sctpCapabilities),k.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),k.debug("load() succeeded"),this._loaded=!0}canProduce(s){if(this._loaded){if(s!=="audio"&&s!=="video")throw new TypeError(`invalid kind "${s}"`)}else throw new Qe.InvalidStateError("not loaded");return this._canProduceByKind[s]}createSendTransport({id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:a,additionalSettings:c,appData:l}){return k.debug("createSendTransport()"),this.createTransport({direction:"send",id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:a,additionalSettings:c,appData:l})}createRecvTransport({id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:a,additionalSettings:c,appData:l}){return k.debug("createRecvTransport()"),this.createTransport({direction:"recv",id:s,iceParameters:e,iceCandidates:t,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:a,additionalSettings:c,appData:l})}createTransport({direction:s,id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o,iceServers:a,iceTransportPolicy:c,additionalSettings:l,appData:d}){if(this._loaded){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="object")throw new TypeError("missing iceParameters");if(Array.isArray(i)){if(typeof n!="object")throw new TypeError("missing dtlsParameters");if(o&&typeof o!="object")throw new TypeError("wrong sctpParameters");if(d&&typeof d!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new Qe.InvalidStateError("not loaded");const p=new Td.Transport({direction:s,id:e,iceParameters:t,iceCandidates:i,dtlsParameters:n,sctpParameters:o,iceServers:a,iceTransportPolicy:c,additionalSettings:l,appData:d,handlerFactory:this._handlerFactory,getSendExtendedRtpCapabilities:this._getSendExtendedRtpCapabilities,recvRtpCapabilities:this._recvRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",p),p}}Et.Device=kr;function hn(r,s){k.debug('detectDeviceImpl() [userAgent:"%s", userAgentData:%o]',r,s);const e=Id(r,s);if(e){if(e>=111)return k.debug("detectDeviceImpl() | using Chrome111 handler"),"Chrome111";if(e>=74)return k.debug("detectDeviceImpl() | using Chrome74 handler"),"Chrome74";k.warn("detectDeviceImpl() | unsupported Chromium based browser/version");return}const t=Md(r);if(t){if(t>=120)return k.debug("detectDeviceImpl() | using Firefox120 handler"),"Firefox120";k.warn("detectDeviceImpl() | unsupported Firefox browser/version");return}const i=Od(r);if(i){if(i>=605)return k.debug("detectDeviceImpl() | using Safari12 handler"),"Safari12";k.warn("detectDeviceImpl() | unsupported desktop Safari browser/version");return}const n=Ad(r);if(n){if(n>=605)return k.debug("detectDeviceImpl() | using Safari12 handler"),"Safari12";k.warn("detectDeviceImpl() | unsupported iOS Safari based browser/version");return}if(Gt()){if(typeof RTCPeerConnection<"u"&&typeof RTCRtpTransceiver<"u")return k.debug("detectDeviceImpl() | using ReactNative106 handler"),"ReactNative106";k.warn("detectDeviceImpl() | unsupported react-native-webrtc version without RTCPeerConnection or RTCRtpTransceiver, forgot to call registerGlobals() on it?");return}k.warn('detectDeviceImpl() | device not supported [userAgent:"%s", userAgentData:%o]',r,s)}function Id(r,s){if(Is(r,s)){k.debug("getChromiumMajorVersion() | this is iOS => undefined");return}if(Gt()){k.debug("getChromiumMajorVersion() | this is React-Native => undefined");return}if(s){const t=(s.brands??[]).find(i=>i.brand==="Chromium");if(t){const i=Number(t.version);return k.debug(`getChromiumMajorVersion() | Chromium major version based on NavigatorUAData => ${i}`),i}}const e=r==null?void 0:r.match(/\b(?:Chrome|Chromium)\/(\w+)/i);if(e!=null&&e[1]){const t=Number(e[1]);return k.debug(`getChromiumMajorVersion() | Chromium major version based on User-Agent => ${t}`),t}k.debug("getChromiumMajorVersion() | this is not Chromium => undefined")}function Md(r){if(Is(r)){k.debug("getFirefoxMajorVersion() | this is iOS => undefined");return}if(Gt()){k.debug("getFirefoxMajorVersion() | this is React-Native => undefined");return}const s=r==null?void 0:r.match(/\bFirefox\/(\w+)/i);if(s!=null&&s[1]){const e=Number(s[1]);return k.debug(`getFirefoxMajorVersion() | Firefox major version based on User-Agent => ${e}`),e}k.debug("getFirefoxMajorVersion() | this is not Firefox => undefined")}function Od(r){if(Is(r)){k.debug("getMacOSWebKitMajorVersion() | this is iOS => undefined");return}if(Gt()){k.debug("getMacOSWebKitMajorVersion() | this is React-Native => undefined");return}if(!(r&&/\bSafari\b/i.test(r)&&!/\bChrome\b/i.test(r)&&!/\bChromium\b/i.test(r)&&!/\bFirefox\b/i.test(r))){k.debug("getMacOSWebKitMajorVersion() | this is not Safari => undefined");return}const e=r.match(/AppleWebKit\/(\w+)/i);if(e!=null&&e[1]){const t=Number(e[1]);return k.debug(`getMacOSWebKitMajorVersion() | WebKit major version based on User-Agent => ${t}`),t}k.debug("getMacOSWebKitMajorVersion() | this is not WebKit => undefined")}function Ad(r){if(!Is(r)){k.debug("getIOSWebKitMajorVersion() | this is not iOS => undefined");return}if(Gt()){k.debug("getIOSWebKitMajorVersion() | this is React-Native => undefined");return}const s=r==null?void 0:r.match(/AppleWebKit\/(\w+)/i);if(s!=null&&s[1]){const e=Number(s[1]);return k.debug(`getIOSWebKitMajorVersion() | WebKit major version based on User-Agent => ${e}`),e}k.debug("getIOSWebKitMajorVersion() | this is not WebKit => undefined")}function Is(r,s){return(s==null?void 0:s.platform)==="iOS"?(k.debug("isIOS() | this is iOS based on NavigatorUAData.platform => true"),!0):s!=null&&s.platform?(k.debug("isIOS() | this is not iOS based on NavigatorUAData.platform => false"),!1):r&&/iPad|iPhone|iPod/.test(r)?(k.debug("isIOS() | this is iOS based on User-Agent => true"),!0):typeof navigator=="object"&&navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1?(k.debug("isIOS() | this is iPadOS 13+ based on User-Agent => true"),!0):(k.debug("isIOS() | this is not iOS => false"),!1)}function Gt(){return typeof navigator=="object"&&navigator.product==="ReactNative"?(k.debug("isReactNative() | this is React-Native based on navigator.product"),!0):(k.debug("isReactNative() | this is not React-Native => false"),!1)}var Ms={},Os={},fn={},Je=256,hs=[],os;for(;Je--;)hs[Je]=(Je+256).toString(16).substring(1);function Nd(){var r=0,s,e="";if(!os||Je+16>256){for(os=Array(r=256);r--;)os[r]=256*Math.random()|0;r=Je=0}for(;r<16;r++)s=os[Je+r],r==6?e+=hs[s&15|64]:r==8?e+=hs[s&63|128]:e+=hs[s],r&1&&r>1&&r<11&&(e+="-");return Je++,e}fn.v4=Nd;var As={};Object.defineProperty(As,"__esModule",{value:!0});As.FakeEventTarget=void 0;let jd=class{constructor(){u(this,"listeners",{})}addEventListener(s,e,t){e&&(this.listeners[s]=this.listeners[s]??[],this.listeners[s].push({callback:typeof e=="function"?e:e.handleEvent,once:typeof t=="object"&&t.once===!0}))}removeEventListener(s,e,t){this.listeners[s]&&e&&(this.listeners[s]=this.listeners[s].filter(i=>i.callback!==(typeof e=="function"?e:e.handleEvent)))}dispatchEvent(s){if(!s||typeof s.type!="string")throw new Error("invalid event object");const e=this.listeners[s.type];if(!e)return!0;for(const t of[...e]){try{t.callback.call(this,s)}catch(i){setTimeout(()=>{throw i},0)}t.once&&this.removeEventListener(s.type,t.callback)}return!s.defaultPrevented}};As.FakeEventTarget=jd;var Ns={};Object.defineProperty(Ns,"__esModule",{value:!0});Ns.FakeEvent=void 0;class Fd{constructor(s,e={}){u(this,"NONE",0);u(this,"CAPTURING_PHASE",1);u(this,"AT_TARGET",2);u(this,"BUBBLING_PHASE",3);u(this,"type");u(this,"bubbles");u(this,"cancelable");u(this,"defaultPrevented",!1);u(this,"composed",!1);u(this,"currentTarget",null);u(this,"eventPhase",this.NONE);u(this,"isTrusted",!0);u(this,"target",null);u(this,"timeStamp",0);u(this,"cancelBubble",!1);u(this,"returnValue",!0);u(this,"srcElement",null);this.type=s,this.bubbles=e.bubbles??!1,this.cancelable=e.cancelable??!1}preventDefault(){this.cancelable&&(this.defaultPrevented=!0)}stopPropagation(){}stopImmediatePropagation(){}composedPath(){return[]}initEvent(s,e,t){}}Ns.FakeEvent=Fd;var xr={};Object.defineProperty(xr,"__esModule",{value:!0});xr.clone=$d;function $d(r){if(r!==void 0)return Number.isNaN(r)?NaN:typeof structuredClone=="function"?structuredClone(r):JSON.parse(JSON.stringify(r))}Object.defineProperty(Os,"__esModule",{value:!0});Os.FakeMediaStreamTrack=void 0;const Pi=fn,Bd=As,_t=Ns,as=xr;var qt,wt,bt,be,Be,Se,Ye,St,Xe,Ct,Ze,et,tt,st,rt,it;const Dr=class Dr extends Bd.FakeEventTarget{constructor({kind:e,id:t,label:i,contentHint:n,enabled:o,muted:a,readyState:c,capabilities:l,constraints:d,settings:p,data:h}){super();K(this,qt);K(this,wt);K(this,bt);K(this,be);K(this,Be);K(this,Se);K(this,Ye);K(this,St);K(this,Xe);K(this,Ct);K(this,Ze);K(this,et,null);K(this,tt,null);K(this,st,null);K(this,rt,null);K(this,it,null);V(this,qt,t??(0,Pi.v4)()),V(this,wt,e),V(this,bt,i??""),V(this,Ye,n??""),V(this,Be,o??!0),V(this,Se,a??!1),V(this,be,c??"live"),V(this,St,l??{}),V(this,Xe,d??{}),V(this,Ct,p??{}),V(this,Ze,h??{})}get id(){return M(this,qt)}get kind(){return M(this,wt)}get label(){return M(this,bt)}get contentHint(){return M(this,Ye)}set contentHint(e){V(this,Ye,e)}get enabled(){return M(this,Be)}set enabled(e){const t=M(this,Be)!==e;V(this,Be,e),t&&this.dispatchEvent(new _t.FakeEvent("enabledchange"))}get muted(){return M(this,Se)}get readyState(){return M(this,be)}get data(){return M(this,Ze)}set data(e){V(this,Ze,e)}get onmute(){return M(this,et)}set onmute(e){M(this,et)&&this.removeEventListener("mute",M(this,et)),V(this,et,e),e&&this.addEventListener("mute",e)}get onunmute(){return M(this,tt)}set onunmute(e){M(this,tt)&&this.removeEventListener("unmute",M(this,tt)),V(this,tt,e),e&&this.addEventListener("unmute",e)}get onended(){return M(this,st)}set onended(e){M(this,st)&&this.removeEventListener("ended",M(this,st)),V(this,st,e),e&&this.addEventListener("ended",e)}get onenabledchange(){return M(this,rt)}set onenabledchange(e){M(this,rt)&&this.removeEventListener("enabledchange",M(this,rt)),V(this,rt,e),e&&this.addEventListener("enabledchange",e)}get onstopped(){return M(this,it)}set onstopped(e){M(this,it)&&this.removeEventListener("stopped",M(this,it)),V(this,it,e),e&&this.addEventListener("stopped",e)}addEventListener(e,t,i){super.addEventListener(e,t,i)}removeEventListener(e,t,i){super.removeEventListener(e,t,i)}stop(){M(this,be)!=="ended"&&(V(this,be,"ended"),this.dispatchEvent(new _t.FakeEvent("stopped")))}clone({id:e,data:t}={}){return new Dr({id:e??(0,Pi.v4)(),kind:M(this,wt),label:M(this,bt),contentHint:M(this,Ye),enabled:M(this,Be),muted:M(this,Se),readyState:M(this,be),capabilities:(0,as.clone)(M(this,St)),constraints:(0,as.clone)(M(this,Xe)),settings:(0,as.clone)(M(this,Ct)),data:t??(0,as.clone)(M(this,Ze))})}getCapabilities(){return M(this,St)}getConstraints(){return M(this,Xe)}async applyConstraints(e={}){return V(this,Xe,e),Promise.resolve()}getSettings(){return M(this,Ct)}remoteStop(){M(this,be)!=="ended"&&(V(this,be,"ended"),this.dispatchEvent(new _t.FakeEvent("stopped")),this.dispatchEvent(new _t.FakeEvent("ended")))}remoteMute(){M(this,Se)||(V(this,Se,!0),this.dispatchEvent(new _t.FakeEvent("mute")))}remoteUnmute(){M(this,Se)&&(V(this,Se,!1),this.dispatchEvent(new _t.FakeEvent("unmute")))}};qt=new WeakMap,wt=new WeakMap,bt=new WeakMap,be=new WeakMap,Be=new WeakMap,Se=new WeakMap,Ye=new WeakMap,St=new WeakMap,Xe=new WeakMap,Ct=new WeakMap,Ze=new WeakMap,et=new WeakMap,tt=new WeakMap,st=new WeakMap,rt=new WeakMap,it=new WeakMap;let ur=Dr;Os.FakeMediaStreamTrack=ur;var js={};Object.defineProperty(js,"__esModule",{value:!0});js.FakeEventTarget=void 0;class zd{constructor(){u(this,"listeners",{})}addEventListener(s,e,t){e&&(this.listeners[s]=this.listeners[s]??[],this.listeners[s].push({callback:typeof e=="function"?e:e.handleEvent,once:typeof t=="object"&&t.once===!0}))}removeEventListener(s,e,t){this.listeners[s]&&e&&(this.listeners[s]=this.listeners[s].filter(i=>i.callback!==(typeof e=="function"?e:e.handleEvent)))}dispatchEvent(s){if(!s||typeof s.type!="string")throw new Error("invalid event object");const e=this.listeners[s.type];if(!e)return!0;for(const t of[...e]){try{t.callback.call(this,s)}catch(i){setTimeout(()=>{throw i},0)}t.once&&this.removeEventListener(s.type,t.callback)}return!s.defaultPrevented}}js.FakeEventTarget=zd;Object.defineProperty(Ms,"__esModule",{value:!0});Ms.FakeHandler=void 0;const Ud=Os,Vd=se,qd=Y,Nt=Ee,rr=q,mn=te,Gd=js,Q=new qd.Logger("FakeHandler"),Li="FakeHandler";class Vt extends Vd.EnhancedEventEmitter{constructor({getSendExtendedRtpCapabilities:e},t){super();u(this,"_closed",!1);u(this,"_fakeParameters");u(this,"_getSendExtendedRtpCapabilities");u(this,"_cname",`CNAME-${Nt.generateRandomNumber()}`);u(this,"_transportReady",!1);u(this,"_nextLocalId",1);u(this,"_tracks",new Map);u(this,"_nextSctpStreamId",0);Q.debug("constructor()"),this._getSendExtendedRtpCapabilities=e,this._fakeParameters=t}static createFactory(e){return{name:Li,factory:t=>new Vt(t,e),getNativeRtpCapabilities:async()=>(Q.debug("getNativeRtpCapabilities()"),Vt.getLocalRtpCapabilities(e)),getNativeSctpCapabilities:async()=>(Q.debug("getNativeSctpCapabilities()"),e.generateNativeSctpCapabilities())}}static getLocalRtpCapabilities(e){const t=e.generateNativeRtpCapabilities();return rr.validateAndNormalizeRtpCapabilities(t),t}get name(){return Li}close(){Q.debug("close()"),!this._closed&&(this._closed=!0,super.close())}setIceGatheringState(e){this.emit("@icegatheringstatechange",e)}setConnectionState(e){this.emit("@connectionstatechange",e)}async updateIceServers(e){this.assertNotClosed(),Q.debug("updateIceServers()")}async restartIce(e){this.assertNotClosed(),Q.debug("restartIce()")}async getTransportStats(){return this.assertNotClosed(),new Map}async send({track:e,encodings:t,codecOptions:i,codec:n}){this.assertNotClosed(),Q.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||await this.setupTransport({localDtlsRole:"server"});const o=Vt.getLocalRtpCapabilities(this._fakeParameters),a=this._getSendExtendedRtpCapabilities(o),c=rr.getSendingRtpParameters(e.kind,a);c.codecs=rr.reduceCodecs(c.codecs,n);const l=c.codecs.some(p=>/.+\/rtx$/i.test(p.mimeType));c.mid=`mid-${Nt.generateRandomNumber()}`,t||(t=[{}]);for(const p of t)p.ssrc=Nt.generateRandomNumber(),l&&(p.rtx={ssrc:Nt.generateRandomNumber()});c.encodings=t,c.rtcp={cname:this._cname,reducedSize:!0,mux:!0};const d=this._nextLocalId++;return this._tracks.set(d,e),{localId:String(d),rtpParameters:c}}async stopSending(e){if(Q.debug("stopSending() [localId:%s]",e),!this._closed){if(!this._tracks.has(Number(e)))throw new Error("local track not found");this._tracks.delete(Number(e))}}async pauseSending(e){this.assertNotClosed()}async resumeSending(e){this.assertNotClosed()}async replaceTrack(e,t){this.assertNotClosed(),t?Q.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):Q.debug("replaceTrack() [localId:%s, no track]",e),this._tracks.delete(Number(e)),this._tracks.set(Number(e),t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),Q.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),Q.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t)}async getSenderStats(e){return this.assertNotClosed(),new Map}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:o}){this.assertNotClosed(),this._transportReady||await this.setupTransport({localDtlsRole:"server"}),Q.debug("sendDataChannel()");const a=new Ii({id:this._nextSctpStreamId++,ordered:e,maxPacketLifeTime:t,maxRetransmits:i,label:n,protocol:o}),c={streamId:this._nextSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:i};return{dataChannel:a,sctpStreamParameters:c}}async receive(e){this.assertNotClosed();const t=[];for(const i of e){const{trackId:n,kind:o}=i;this._transportReady||await this.setupTransport({localDtlsRole:"client"}),Q.debug("receive() [trackId:%s, kind:%s]",n,o);const a=this._nextLocalId++,c=new Ud.FakeMediaStreamTrack({kind:o});this._tracks.set(a,c),t.push({localId:String(a),track:c})}return t}async stopReceiving(e){if(!this._closed)for(const t of e)Q.debug("stopReceiving() [localId:%s]",t),this._tracks.delete(Number(t))}async pauseReceiving(e){this.assertNotClosed()}async resumeReceiving(e){this.assertNotClosed()}async getReceiverStats(e){return this.assertNotClosed(),new Map}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:i}){return this.assertNotClosed(),this._transportReady||await this.setupTransport({localDtlsRole:"client"}),Q.debug("receiveDataChannel()"),{dataChannel:new Ii({id:e.streamId,ordered:e.ordered,maxPacketLifeTime:e.maxPacketLifeTime,maxRetransmits:e.maxRetransmits,label:t,protocol:i})}}async setupTransport({localDtlsRole:e,localSdpObject:t}){const i=Nt.clone(this._fakeParameters.generateLocalDtlsParameters());e&&(i.role=e),this.emit("@connectionstatechange","connecting"),await new Promise((n,o)=>this.emit("@connect",{dtlsParameters:i},n,o)),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new mn.InvalidStateError("method called in a closed handler")}}Ms.FakeHandler=Vt;class Ii extends Gd.FakeEventTarget{constructor({id:e,ordered:t=!0,maxPacketLifeTime:i=null,maxRetransmits:n=null,label:o="",protocol:a=""}){super();u(this,"_id");u(this,"_negotiated",!0);u(this,"_ordered");u(this,"_maxPacketLifeTime");u(this,"_maxRetransmits");u(this,"_label");u(this,"_protocol");u(this,"_readyState","connecting");u(this,"_bufferedAmount",0);u(this,"_bufferedAmountLowThreshold",0);u(this,"_binaryType","arraybuffer");u(this,"_onopen",null);u(this,"_onclosing",null);u(this,"_onclose",null);u(this,"_onmessage",null);u(this,"_onbufferedamountlow",null);u(this,"_onerror",null);Q.debug(`constructor() [id:${e}, ordered:${t}, maxPacketLifeTime:${i}, maxRetransmits:${n}, label:${o}, protocol:${a}`),this._id=e,this._ordered=t,this._maxPacketLifeTime=i,this._maxRetransmits=n,this._label=o,this._protocol=a}get id(){return this._id}get negotiated(){return this._negotiated}get ordered(){return this._ordered}get maxPacketLifeTime(){return this._maxPacketLifeTime}get maxRetransmits(){return this._maxRetransmits}get label(){return this._label}get protocol(){return this._protocol}get readyState(){return this._readyState}get bufferedAmount(){return this._bufferedAmount}get bufferedAmountLowThreshold(){return this._bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._bufferedAmountLowThreshold=e}get binaryType(){return this._binaryType}set binaryType(e){this._binaryType=e}get onopen(){return this._onopen}set onopen(e){this._onopen&&this.removeEventListener("open",this._onopen),this._onopen=e,e&&this.addEventListener("open",e)}get onclosing(){return this._onclosing}set onclosing(e){this._onclosing&&this.removeEventListener("closing",this._onclosing),this._onclosing=e,e&&this.addEventListener("closing",e)}get onclose(){return this._onclose}set onclose(e){this._onclose&&this.removeEventListener("close",this._onclose),this._onclose=e,e&&this.addEventListener("close",e)}get onmessage(){return this._onmessage}set onmessage(e){this._onmessage&&this.removeEventListener("message",this._onmessage),this._onmessage=e,e&&this.addEventListener("message",e)}get onbufferedamountlow(){return this._onbufferedamountlow}set onbufferedamountlow(e){this._onbufferedamountlow&&this.removeEventListener("bufferedamountlow",this._onbufferedamountlow),this._onbufferedamountlow=e,e&&this.addEventListener("bufferedamountlow",e)}get onerror(){return this._onerror}set onerror(e){this._onerror&&this.removeEventListener("error",this._onerror),this._onerror=e,e&&this.addEventListener("error",e)}addEventListener(e,t,i){super.addEventListener(e,t,i)}removeEventListener(e,t,i){super.removeEventListener(e,t,i)}close(){["closing","closed"].includes(this._readyState)||(this._readyState="closed")}send(e){if(this._readyState!=="open")throw new mn.InvalidStateError("not open")}}var me={};Object.defineProperty(me,"__esModule",{value:!0});me.generateRouterRtpCapabilities=Hd;me.generateNativeRtpCapabilities=Wd;me.generateNativeSctpCapabilities=Kd;me.generateLocalDtlsParameters=Qd;me.generateTransportRemoteParameters=Jd;me.generateProducerRemoteParameters=Yd;me.generateConsumerRemoteParameters=Xd;me.generateDataProducerRemoteParameters=Zd;me.generateDataConsumerRemoteParameters=el;const oe=Ee;function ae(){return String(oe.generateRandomNumber())}function Hd(){return oe.deepFreeze({codecs:[{mimeType:"audio/opus",kind:"audio",preferredPayloadType:100,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{useinbandfec:1,foo:"bar"}},{mimeType:"video/VP8",kind:"video",preferredPayloadType:101,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"x-google-start-bitrate":1500}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:102,clockRate:9e4,rtcpFeedback:[],parameters:{apt:101}},{mimeType:"video/H264",kind:"video",preferredPayloadType:103,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"level-asymmetry-allowed":1,"packetization-mode":1,"profile-level-id":"42e01f"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:104,clockRate:9e4,rtcpFeedback:[],parameters:{apt:103}},{mimeType:"video/VP9",kind:"video",preferredPayloadType:105,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"profile-id":0,"x-google-start-bitrate":1500}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:106,clockRate:9e4,rtcpFeedback:[],parameters:{apt:105}}],headerExtensions:[{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id",preferredId:2,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id",preferredId:3,preferredEncrypt:!1,direction:"recvonly"},{kind:"audio",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:4,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"recvonly"},{kind:"video",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5,preferredEncrypt:!1,direction:"sendrecv"},{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",preferredId:10,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:3gpp:video-orientation",preferredId:11,preferredEncrypt:!1,direction:"sendrecv"},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:toffset",preferredId:12,preferredEncrypt:!1,direction:"sendrecv"}]})}function Wd(){return{codecs:[{mimeType:"audio/opus",kind:"audio",preferredPayloadType:111,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{minptime:10,useinbandfec:1}},{mimeType:"audio/ISAC",kind:"audio",preferredPayloadType:103,clockRate:16e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}},{mimeType:"audio/CN",kind:"audio",preferredPayloadType:106,clockRate:32e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}},{mimeType:"audio/foo",kind:"audio",preferredPayloadType:107,clockRate:9e4,channels:4,rtcpFeedback:[{type:"foo-qwe-qwe"}],parameters:{foo:"lalala"}},{mimeType:"video/BAZCODEC",kind:"video",preferredPayloadType:100,clockRate:9e4,rtcpFeedback:[{type:"foo"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{baz:"1234abcd"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:101,clockRate:9e4,rtcpFeedback:[],parameters:{apt:100}},{mimeType:"video/VP8",kind:"video",preferredPayloadType:96,clockRate:9e4,rtcpFeedback:[{type:"goog-remb"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{baz:"1234abcd"}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:97,clockRate:9e4,rtcpFeedback:[],parameters:{apt:96}},{mimeType:"video/VP9",kind:"video",preferredPayloadType:98,clockRate:9e4,rtcpFeedback:[{type:"goog-remb"},{type:"transport-cc"},{type:"ccm",parameter:"fir"},{type:"nack"},{type:"nack",parameter:"pli"}],parameters:{"profile-id":0}},{mimeType:"video/rtx",kind:"video",preferredPayloadType:99,clockRate:9e4,rtcpFeedback:[],parameters:{apt:98}}],headerExtensions:[{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:sdes:mid",preferredId:1},{kind:"video",uri:"urn:ietf:params:rtp-hdrext:toffset",preferredId:2},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",preferredId:3},{kind:"video",uri:"urn:3gpp:video-orientation",preferredId:4},{kind:"video",uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",preferredId:5},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay",preferredId:6},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type",preferredId:7},{kind:"video",uri:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing",preferredId:8},{kind:"audio",uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",preferredId:10}]}}function Kd(){return oe.deepFreeze({numStreams:{OS:2048,MIS:2048}})}function Qd(){return oe.deepFreeze({fingerprints:[{algorithm:"sha-256",value:"82:5A:68:3D:36:C3:0A:DE:AF:E7:32:43:D2:88:83:57:AC:2D:65:E5:80:C4:B6:FB:AF:1A:A0:21:9F:6D:0C:AD"}],role:"auto"})}function Jd(){return{id:ae(),iceParameters:oe.deepFreeze({iceLite:!0,password:"yku5ej8nvfaor28lvtrabcx0wkrpkztz",usernameFragment:"h3hk1iz6qqlnqlne"}),iceCandidates:oe.deepFreeze([{foundation:"udpcandidate",address:"9.9.9.9",ip:"9.9.9.9",port:40533,priority:1078862079,protocol:"udp",type:"host",tcpType:"passive"},{foundation:"udpcandidate",address:"9.9.9.9",ip:"9:9:9:9:9:9",port:41333,priority:1078862089,protocol:"udp",type:"host",tcpType:"passive"}]),dtlsParameters:oe.deepFreeze({fingerprints:[{algorithm:"sha-256",value:"A9:F4:E0:D2:74:D3:0F:D9:CA:A5:2F:9F:7F:47:FA:F0:C4:72:DD:73:49:D0:3B:14:90:20:51:30:1B:90:8E:71"},{algorithm:"sha-384",value:"03:D9:0B:87:13:98:F6:6D:BC:FC:92:2E:39:D4:E1:97:32:61:30:56:84:70:81:6E:D1:82:97:EA:D9:C1:21:0F:6B:C5:E7:7F:E1:97:0C:17:97:6E:CF:B3:EF:2E:74:B0"},{algorithm:"sha-512",value:"84:27:A4:28:A4:73:AF:43:02:2A:44:68:FF:2F:29:5C:3B:11:9A:60:F4:A8:F0:F5:AC:A0:E3:49:3E:B1:34:53:A9:85:CE:51:9B:ED:87:5E:B8:F4:8E:3D:FA:20:51:B8:96:EE:DA:56:DC:2F:5C:62:79:15:23:E0:21:82:2B:2C"}],role:"auto"}),sctpParameters:oe.deepFreeze({port:5e3,OS:2048,MIS:2048,maxMessageSize:2e6})}}function Yd(){return oe.deepFreeze({id:ae()})}function Xd({id:r,codecMimeType:s}={}){switch(s){case"audio/opus":return{id:r??ae(),producerId:ae(),kind:"audio",rtpParameters:oe.deepFreeze({codecs:[{mimeType:"audio/opus",payloadType:100,clockRate:48e3,channels:2,rtcpFeedback:[{type:"transport-cc"}],parameters:{useinbandfec:1,foo:"bar"}}],encodings:[{ssrc:46687003}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:ietf:params:rtp-hdrext:ssrc-audio-level",id:10}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"audio/ISAC":return{id:r??ae(),producerId:ae(),kind:"audio",rtpParameters:oe.deepFreeze({codecs:[{mimeType:"audio/ISAC",payloadType:111,clockRate:16e3,channels:1,rtcpFeedback:[{type:"transport-cc"}],parameters:{}}],encodings:[{ssrc:46687004}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"video/VP8":return{id:r??ae(),producerId:ae(),kind:"video",rtpParameters:oe.deepFreeze({codecs:[{mimeType:"video/VP8",payloadType:101,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"x-google-start-bitrate":1500}},{mimeType:"video/rtx",payloadType:102,clockRate:9e4,rtcpFeedback:[],parameters:{apt:101}}],encodings:[{ssrc:99991111,rtx:{ssrc:99991112}}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",id:4},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:3gpp:video-orientation",id:11},{uri:"urn:ietf:params:rtp-hdrext:toffset",id:12}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};case"video/H264":return{id:r??ae(),producerId:ae(),kind:"video",rtpParameters:oe.deepFreeze({codecs:[{mimeType:"video/H264",payloadType:103,clockRate:9e4,rtcpFeedback:[{type:"nack"},{type:"nack",parameter:"pli"},{type:"ccm",parameter:"fir"},{type:"goog-remb"},{type:"transport-cc"}],parameters:{"level-asymmetry-allowed":1,"packetization-mode":1,"profile-level-id":"42e01f"}},{mimeType:"video/rtx",payloadType:104,clockRate:9e4,rtcpFeedback:[],parameters:{apt:103}}],encodings:[{ssrc:99991113,rtx:{ssrc:99991114}}],headerExtensions:[{uri:"urn:ietf:params:rtp-hdrext:sdes:mid",id:1},{uri:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",id:4},{uri:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",id:5},{uri:"urn:3gpp:video-orientation",id:11},{uri:"urn:ietf:params:rtp-hdrext:toffset",id:12}],rtcp:{cname:"wB4Ql4lrsxYLjzuN",reducedSize:!0,mux:!0}})};default:throw new TypeError(`unknown codecMimeType '${s}'`)}}function Zd(){return oe.deepFreeze({id:ae()})}function el({id:r}={}){return{id:r??ae(),dataProducerId:ae(),sctpStreamParameters:oe.deepFreeze({streamId:666,maxPacketLifeTime:5e3,maxRetransmits:void 0})}}(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.debug=r.testFakeParameters=r.FakeHandler=r.enhancedEvents=r.ortc=r.parseScalabilityMode=r.detectDeviceAsync=r.detectDevice=r.Device=r.version=r.types=void 0;const s=gs;r.debug=s.default,r.types=Hi,r.version="3.16.7";var e=Et;Object.defineProperty(r,"Device",{enumerable:!0,get:function(){return e.Device}}),Object.defineProperty(r,"detectDevice",{enumerable:!0,get:function(){return e.detectDevice}}),Object.defineProperty(r,"detectDeviceAsync",{enumerable:!0,get:function(){return e.detectDeviceAsync}});var t=Ve;Object.defineProperty(r,"parseScalabilityMode",{enumerable:!0,get:function(){return t.parse}}),r.ortc=q,r.enhancedEvents=se;var i=Ms;Object.defineProperty(r,"FakeHandler",{enumerable:!0,get:function(){return i.FakeHandler}}),r.testFakeParameters=me})(aa);const Ll=()=>{const{sessionId:r}=Hn(),s=Wn(),{user:e}=Kn(),[t,i]=O.useState(!1),[n,o]=O.useState(!1),[a,c]=O.useState(!0),[l,d]=O.useState(null),[p,h]=O.useState(!0),[m,C]=O.useState(""),[_,S]=O.useState([]),[b,L]=O.useState(null),[A,F]=O.useState(!1),[re,ke]=O.useState(!1),[xe,le]=O.useState(null),[ce,De]=O.useState(0),[tl,sl]=O.useState(1),[ct,gn]=O.useState(1),[Pr,_n]=O.useState(!1),[Ne,Fs]=O.useState(!1),[Lr,Ir]=O.useState(null),[vn,Mr]=O.useState(!1),$s=O.useRef(null),[yn,wn]=O.useState(.5),[rl,il]=O.useState(!1),[nl,Bs]=O.useState({currentTrack:null,isPlaying:!1,position:0,duration:0,volume:.5}),[bn,Ht]=O.useState(!1),[Or,ol]=O.useState(!1),[je,Ar]=O.useState(null),[al,cl]=O.useState(!1),[Nr,He]=O.useState(!1),[Sn,dt]=O.useState(!1),[dl,Cn]=O.useState({inputs:[],outputs:[]}),[Rn,En]=O.useState(""),[Tn,kn]=O.useState(""),xn=O.useRef(null),Z=O.useRef(null),We=O.useRef(null),pe=O.useRef(null);O.useEffect(()=>{var y;let f=!0;return(async()=>{try{if(console.log("AudioSession component mounting with sessionId:",r),!r){console.warn("AudioSession mounted without sessionId in route params"),f&&(C("Missing session ID in URL"),h(!1));return}console.log("Session ID validated, proceeding with initialization"),console.log("🎤 Setting up auto-init timeout..."),setTimeout(()=>{console.log("🎤 Auto-init timeout triggered, calling initializeMicrophone..."),zs().then(()=>{console.log("🎤 Auto-init succeeded")}).catch(w=>{console.log("🎤 Auto-init failed:",w.message,w.name),le(`Microphone access failed: ${w.message}. Please check your browser permissions and refresh the page.`)})},1e3)}catch(w){console.error("Error in component initialization:",w),f&&C("Initialization failed: "+w.message)}try{console.log("Calling fetchSessionDetails..."),await Mn()}catch(w){console.error("Error in fetchSessionDetails:",w),f&&(C("Failed to fetch session details: "+w.message),h(!1))}})().catch(w=>{console.error("Unhandled error in initializeComponent:",w),f&&(C("Initialization failed: "+w.message),h(!1))}),(y=navigator.mediaDevices)==null||y.enumerateDevices().then(w=>{if(!f)return;const j=w.filter(E=>E.kind==="audioinput"),$=w.filter(E=>E.kind==="audiooutput");Cn({inputs:j,outputs:$}),j.length>0&&!Rn&&En(j[0].deviceId),$.length>0&&!Tn&&kn($[0].deviceId)}).catch(w=>{console.error("Error enumerating devices:",w)}),()=>{console.log("AudioSession component unmounting"),f=!1,b&&b.getTracks().forEach(w=>w.stop()),console.log("Session unmount occurred, leaving session."),Un()}},[]),O.useEffect(()=>{b&&$r(b)},[b]),O.useEffect(()=>{if(je)return je.on("music_play",f=>{Bs(v=>({...v,currentTrack:f.trackData,isPlaying:!0,position:f.position,serverTimestamp:f.timestamp})),We.current&&(We.current.currentTime=f.position/1e3,We.current.play().catch(v=>console.error("Error playing audio:",v)))}),je.on("music_pause",f=>{Bs(v=>({...v,isPlaying:!1,position:f.position})),We.current&&We.current.pause()}),je.on("music_seek",f=>{Bs(v=>({...v,position:f.position})),We.current&&(We.current.currentTime=f.position/1e3)}),()=>{je.off("music_play"),je.off("music_pause"),je.off("music_seek")}},[je]),O.useEffect(()=>{const f=document.getElementById("remote-audios");f&&f.querySelectorAll("audio").forEach(y=>{y.volume=ct,console.log("🔊 Updated remote audio volume to:",ct)})},[ct]);const zs=async()=>{var f;console.log("🎤 Initializing microphone from user gesture..."),o(!0),le(null);try{console.log("🎤 navigator.mediaDevices available:",!!navigator.mediaDevices),console.log("🎤 getUserMedia available:",!!((f=navigator.mediaDevices)!=null&&f.getUserMedia)),console.log("🎤 webkitGetUserMedia available:",!!navigator.webkitGetUserMedia),console.log("🎤 mozGetUserMedia available:",!!navigator.mozGetUserMedia),console.log("🎤 Is secure context (HTTPS):",window.isSecureContext),console.log("🎤 Protocol:",window.location.protocol),console.log("🎤 Full navigator object keys:",Object.keys(navigator).filter($=>$.toLowerCase().includes("media")||$.toLowerCase().includes("webkit")||$.toLowerCase().includes("getuser"))),console.log("🎤 User agent:",navigator.userAgent),console.log("🎤 Is mobile device:",/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)),console.log("🎤 Is iOS Safari:",/iPhone|iPad|iPod/.test(navigator.userAgent)&&/Safari/.test(navigator.userAgent)&&!/Chrome|CriOS|FxiOS|Opera/.test(navigator.userAgent));const v=navigator.userAgent.match(/OS (\d+)_?(\d+)?/);console.log("🎤 iOS version:",v?`${v[1]}.${v[2]||"0"}`:"Not iOS");let y=null;if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?(y=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices),console.log("🎤 Using modern navigator.mediaDevices.getUserMedia")):navigator.webkitGetUserMedia?(y=navigator.webkitGetUserMedia.bind(navigator),console.log("🎤 Using legacy navigator.webkitGetUserMedia")):navigator.mozGetUserMedia?(y=navigator.mozGetUserMedia.bind(navigator),console.log("🎤 Using legacy navigator.mozGetUserMedia")):navigator.getUserMedia&&(y=navigator.getUserMedia.bind(navigator),console.log("🎤 Using fallback navigator.getUserMedia")),!y)throw console.error("🎤 No getUserMedia API found!"),console.error("🎤 navigator object:",navigator),new Error("getUserMedia is not supported in this browser");const w=$=>new Promise((E,z)=>{try{y===navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices)?y($).then(ie=>{E(ie)}).catch(ie=>{z(ie)}):y($,ie=>{E(ie)},ie=>{z(ie)})}catch(ie){console.error("🎤 Error in getUserMediaPromise wrapper:",ie),z(ie)}});console.log("🎤 Starting getUserMedia call...");const j=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1});console.log("🎤 getUserMediaPromise resolved successfully"),console.log("✅ Microphone access granted!"),console.log("✅ Stream tracks:",j.getTracks().map($=>({kind:$.kind,enabled:$.enabled,readyState:$.readyState}))),console.log("✅ Audio tracks count:",j.getAudioTracks().length),console.log("✅ Video tracks count:",j.getVideoTracks().length),L(j),xn.current=j,i(!0),c(!1),F(!0),console.log("🎵 Microphone initialized successfully"),$r(j)}catch(v){console.error("❌ Error accessing microphone:",v),console.error("❌ Error name:",v.name),console.error("❌ Error message:",v.message),console.error("❌ Error stack:",v.stack);const y=v.name==="NotAllowedError"?"Microphone access denied. Please allow microphone permissions and try again.":v.name==="NotFoundError"?"No microphone found. Please connect a microphone and try again.":v.name==="NotSupportedError"?"Microphone access not supported in this browser. Please use a modern browser.":v.message==="getUserMedia is not supported in this browser"?`Your browser does not support microphone access. Current protocol: ${window.location.protocol}. For iPhone testing, you need HTTPS. Use ngrok: 'ngrok http 5173' then access via the HTTPS ngrok URL.`:v.message==="Microphone access timed out. Please check your browser settings and try again."?"Microphone access timed out. This often happens on mobile devices. Please ensure you are using HTTPS and try again.":`Could not access microphone: ${v.message}`;throw le(y),i(!1),F(!1),v}finally{o(!1)}},jr=()=>{b&&(b.getTracks().forEach(f=>f.stop()),L(null)),F(!1),ke(!1),Fs(!1),i(!1),le(null),s(-1)},Dn=()=>{if(b){const f=!re;console.log("🔇 Toggle mute:",{currentMuted:re,newMuteState:f}),b.getAudioTracks().forEach(v=>{console.log("🔇 Setting track enabled:",v.kind,"from",v.enabled,"to",!f),v.enabled=!f}),ke(f),console.log("🔇 Mute state updated to:",f)}else console.warn("🔇 Cannot toggle mute: no local stream available")},Fr=()=>{const f=Date.now();Ir(f),$s.current=setTimeout(()=>{re&&(Mr(!0),Ln())},1e3)},Us=()=>{$s.current&&clearTimeout($s.current);const f=Date.now()-(Lr||Date.now());vn&&Ne?(In(),Mr(!1)):f<1e3&&Dn(),Ir(null)},Pn=()=>{Lr!==null&&Us()},Ln=()=>{re&&b&&(Fs(!0),b.getAudioTracks().forEach(f=>{f.enabled=!0}))},In=()=>{Ne&&b&&(Fs(!1),re&&b.getAudioTracks().forEach(f=>{f.enabled=!1}))},$r=f=>{const v=new(window.AudioContext||window.webkitAudioContext),y=v.createAnalyser(),w=v.createMediaStreamSource(f);y.fftSize=256,w.connect(y);const j=y.frequencyBinCount,$=new Uint8Array(j);let E=0;const z=100,ie=Br=>{if(Br-E>=z){y.getByteFrequencyData($);let zr=0;for(let qs=0;qs<j;qs++)zr+=$[qs];const Vn=zr/j;De(Vn/255),E=Br}requestAnimationFrame(ie)};return requestAnimationFrame(ie),()=>{w.disconnect(),v.close()}},Mn=async()=>{var y,w,j,$;if(console.log("🚀 fetchSessionDetails start",{sessionId:r,user:e,sessionIdType:typeof r,userType:typeof e}),h(!0),!r||!e){console.error("Missing required parameters:",{sessionId:r,user:e}),C("Missing session ID or user information"),h(!1);return}let f=null;const v=(E,z)=>{try{console.error(E,z&&z.message?z.message:z),z&&z.response&&(console.error(E+" - response status:",z.response.status),console.error(E+" - response data:",z.response.data))}catch(ie){console.error("Failed to log axios error",ie)}};try{console.log("Checking for existing audio session for group:",r);const E=await Wt.get(`/audio/sessions/group/${r}`,{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}});console.log("GET session response status:",E.status),console.log("GET session response data:",E.data),E.status===200&&E.data&&E.data.session?(f=E.data.session,console.log("Found existing session:",f.id)):console.log("No existing session found (status:",E.status,", data:",E.data,"), will create new one")}catch(E){v("GET /audio/sessions/group failed",E),console.log("GET failed, will attempt to create new session. Error details:",(y=E.response)==null?void 0:y.status,(w=E.response)==null?void 0:w.data)}if(!f)try{console.log("Creating new audio session for group:",r);const E=await Wt.post("/audio/sessions",{group_id:r,session_type:"voice_only",device_type:"web"});E&&E.data&&E.data.session?(f=E.data.session,console.log("Session created successfully:",f.id)):(console.error("Create session returned unexpected body",E&&E.data),f={id:`fallback-${r}-${Date.now()}`,group_id:r,session_type:"voice_only",participants:[]},console.warn("⚠️ FALLBACK: Using fallback session data due to unexpected response:",{id:f.id,group_id:f.group_id,session_type:f.session_type,participants:f.participants}))}catch(E){v("POST /audio/sessions failed",E),f={id:`fallback-${r}-${Date.now()}`,group_id:r,session_type:"voice_only",participants:[]},console.warn("⚠️ FALLBACK: Using fallback session due to creation failure:",{id:f.id,group_id:f.group_id,session_type:f.session_type,participants:f.participants,error:E.message})}if(console.log("🔍 DEBUG: About to check sessionData validity."),console.log("🔍 DEBUG: sessionData type:",typeof f),console.log("🔍 DEBUG: sessionData value:",JSON.stringify(f,null,2)),console.log("🔍 DEBUG: sessionData.id exists:",!!(f!=null&&f.id)),console.log("🔍 DEBUG: sessionData.id value:",f==null?void 0:f.id),console.log("🔍 DEBUG: sessionData._id exists:",!!(f!=null&&f._id)),console.log("🔍 DEBUG: sessionData._id value:",f==null?void 0:f._id),console.log("🔍 DEBUG: Boolean check result:",!f||!f.id&&!f._id),!f||!f.id&&!f._id){console.error("❌ ERROR: No valid session data available after all attempts."),console.error("❌ ERROR: sessionData details:",{exists:!!f,type:typeof f,value:f,hasId:!!(f&&f.id),idValue:f==null?void 0:f.id,hasUnderscoreId:!!(f&&f._id),underscoreIdValue:f==null?void 0:f._id}),console.error("Session creation failed completely. This should not happen with fallback logic."),C("Unable to create or retrieve audio session. Please try refreshing the page."),h(!1);return}if(f._id&&!f.id&&(f.id=f._id,console.log("🔄 Mapped _id to id for session:",f.id)),console.log("Successfully obtained session data:",f.id),f&&f.id)try{console.log("Joining audio session:",f.id);const E=await Wt.post(`/audio/sessions/${f.id}/join`,{display_name:e.first_name||e.username||"User",device_type:"web"});E&&E.data&&E.data.success?console.log("Successfully joined audio session"):console.warn("Join response incomplete or false",E&&E.data)}catch(E){v("POST join session failed",E),console.warn("Failed to join session, but continuing:",(($=(j=E.response)==null?void 0:j.data)==null?void 0:$.message)||E.message)}else{console.error("No valid session data to join"),C("No valid session data available"),h(!1);return}try{if(d(f),f.participants&&Array.isArray(f.participants)){const E=f.participants.filter(z=>z&&!z.left_at).map(z=>({id:z.id||null,socketId:z.socketId||null,display_name:z.display_name||z.name||"Unknown",isMuted:z.isMuted||!1}));S(E)}else S([])}catch(E){console.error("Error applying session state:",E),C("Failed to initialize session state")}finally{h(!1)}},On=async f=>{console.log("🎥 Initializing WebRTC for session:",f);const v=pe.current;if(!v){console.warn("🎥 Signaling not connected yet, skipping WebRTC init");return}console.log("🎥 Setting up peer connection..."),await Nn(v),console.log("🎥 WebRTC initialization complete")},An=f=>{const v=window.location.origin;console.log("🔌 Setting up Socket.IO signaling connection..."),console.log("🔌 Using Vite proxy via origin:",v),console.log("🔌 Vite will proxy /socket.io to backend"),console.log("🔌 Environment variables:",{VITE_WS_URL:void 0,VITE_BACKEND_URL:void 0,window_location:window.location.origin,computed_socketUrl:v});const y=ps(v,{transports:["polling"],timeout:1e4,forceNew:!0,reconnection:!0,reconnectionAttempts:3,reconnectionDelay:2e3,path:"/socket.io"});return y.on("connect",()=>{console.log("✅ Socket.IO connection established successfully (using polling transport)"),console.log("✅ Socket transport used:",y.io.engine.transport.name),console.log("✅ Socket ID:",y.id),He(!1),dt(!0),y.emit("join-audio-session",{sessionId:f}),console.log("📡 Joined audio session room:",f),y.emit("webrtc-ready",{sessionId:f}),console.log("🚀 Sent webrtc-ready signal")}),y.on("connect_error",w=>{console.error("❌ Socket.IO connection failed:",w),console.error("❌ Error details:",{message:w.message,description:w.description,context:w.context,type:w.type,code:w.code}),He(!1),dt(!1),C(`Failed to connect to signaling server: ${w.message}`)}),y.on("connect_timeout",()=>{console.error("⏰ Socket.IO connection timeout"),He(!1),dt(!1),C("Connection to signaling server timed out. Is the backend server running?")}),y.on("disconnect",w=>{console.log("🔌 Socket.IO connection closed:",w),dt(!1),He(!1),w==="io server disconnect"&&C("Disconnected by server. Please try reconnecting.")}),y.on("webrtc-offer",async w=>{console.log("📨 Received webrtc-offer:",w),await $n(w,y)}),y.on("webrtc-answer",async w=>{console.log("📨 Received webrtc-answer:",w),await Bn(w)}),y.on("webrtc-candidate",async w=>{console.log("📨 Received webrtc-candidate:",w),await zn(w)}),y.on("webrtc-ready",w=>{console.log("📨 Received webrtc-ready from another participant:",w),Z.current&&Z.current.connectionState==="new"&&(console.log("🚀 Creating and sending offer..."),Fn(y))}),y.on("participant-joined",w=>{if(console.log("Participant joined via socket:",w),w){const j={id:w.userId||w.id||null,socketId:w.socketId||null,display_name:w.display_name||w.name||"Unknown",isMuted:w.isMuted||!1};S($=>$.some(z=>z&&(z.socketId===j.socketId||z.id===j.id))?$:[...$,j])}}),y.on("participant-left",w=>{console.log("Participant left via socket:",w),w&&S(j=>j.filter($=>$&&$.socketId!==w.socketId&&$.id!==w.userId))}),Ar(y),pe.current=y,y},Nn=async f=>{console.log("🔗 Setting up peer connection...");const v={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]},y=new RTCPeerConnection(v);return Z.current=y,console.log("🔗 RTCPeerConnection created"),b&&(console.log("🔗 Adding local stream to peer connection"),b.getTracks().forEach(w=>{console.log("🔗 Adding track:",w.kind,w.id),y.addTrack(w,b)})),y.onicecandidate=w=>{w.candidate&&(console.log("🧊 Sending ICE candidate"),f.emit("webrtc-candidate",{candidate:w.candidate,sessionId:r}))},y.onconnectionstatechange=()=>{console.log("🔗 Connection state changed:",y.connectionState),console.log("🔗 Full connection state details:",{connectionState:y.connectionState,iceConnectionState:y.iceConnectionState,iceGatheringState:y.iceGatheringState,signalingState:y.signalingState}),dt(y.connectionState==="connected"),He(y.connectionState==="connecting")},y.oniceconnectionstatechange=()=>{console.log("🧊 ICE connection state:",y.iceConnectionState),console.log("🧊 Full ICE state details:",{iceConnectionState:y.iceConnectionState,iceGatheringState:y.iceGatheringState,signalingState:y.signalingState})},y.ontrack=w=>{console.log("🎵 Received remote track:",w.track.kind,w.track.id),w.track.kind==="audio"&&(console.log("🎵 Setting up remote audio stream"),jn(w.streams[0]))},pe.current=f,y},jn=f=>{console.log("🎵 Handling remote audio stream"),console.log("🎵 Remote stream tracks:",f.getTracks().map(w=>({kind:w.kind,id:w.id,enabled:w.enabled,readyState:w.readyState})));const v=new Audio;v.srcObject=f,v.volume=ct,v.autoplay=!0,v.muted=!1,console.log("🎵 Created audio element with volume:",ct,"autoplay:",v.autoplay,"muted:",v.muted),v.onloadedmetadata=()=>console.log("🎵 Audio element loaded metadata"),v.oncanplay=()=>console.log("🎵 Audio element can play"),v.onplay=()=>console.log("🎵 Audio element started playing"),v.onpause=()=>console.log("🎵 Audio element paused"),v.onerror=w=>console.error("🎵 Audio element error:",w),v.onended=()=>console.log("🎵 Audio element ended"),v.play().then(()=>{console.log("🎵 Audio element play() succeeded")}).catch(w=>{console.error("🎵 Audio element play() failed:",w);const j=()=>{v.play().then(()=>{console.log("🎵 Audio element play() succeeded on user interaction")}).catch($=>{console.error("🎵 Audio element play() failed even on interaction:",$)}),document.removeEventListener("click",j),document.removeEventListener("touchstart",j)};document.addEventListener("click",j),document.addEventListener("touchstart",j)});const y=document.getElementById("remote-audios");y?(y.querySelectorAll("audio").forEach(j=>{j.srcObject===f&&(console.log("🎵 Removing existing audio element"),j.remove())}),console.log("🎵 Appending new audio element to DOM"),y.appendChild(v),console.log("🎵 Total audio elements in container:",y.children.length)):console.warn("🎵 Remote audios container not found")},Fn=async f=>{try{const v=Z.current;if(!v){console.error("❌ No peer connection available");return}console.log("📤 Creating offer...");const y=await v.createOffer();console.log("📤 Created offer, setting local description..."),await v.setLocalDescription(y),console.log("📤 Sending offer via signaling..."),f.emit("webrtc-offer",{offer:v.localDescription,sessionId:r}),console.log("📤 Offer sent")}catch(v){console.error("❌ Error creating/sending offer:",v)}},$n=async(f,v)=>{try{const y=Z.current;if(!y){console.error("❌ No peer connection available for offer");return}console.log("📥 Handling offer..."),await y.setRemoteDescription(new RTCSessionDescription(f.offer)),console.log("📥 Creating answer...");const w=await y.createAnswer();console.log("📥 Setting local description..."),await y.setLocalDescription(w),console.log("📥 Sending answer..."),v.emit("webrtc-answer",{answer:y.localDescription,sessionId:r}),console.log("📥 Answer sent")}catch(y){console.error("❌ Error handling offer:",y)}},Bn=async(f,v)=>{try{const y=Z.current;if(!y){console.error("❌ No peer connection available for answer");return}console.log("📥 Handling answer..."),await y.setRemoteDescription(new RTCSessionDescription(f.answer)),console.log("📥 Remote description set")}catch(y){console.error("❌ Error handling answer:",y)}},zn=async(f,v)=>{try{const y=Z.current;if(!y){console.error("❌ No peer connection available for candidate");return}console.log("📥 Adding ICE candidate..."),await y.addIceCandidate(new RTCIceCandidate(f.candidate)),console.log("📥 ICE candidate added")}catch(y){console.error("❌ Error handling ICE candidate:",y)}},Un=async()=>{try{l&&await Wt.post(`/audio/sessions/${l.id}/leave`,{user_id:e.id}),Z.current&&Z.current.close(),pe.current&&(pe.current.emit("leave-audio-session",{sessionId:(l==null?void 0:l.id)||r}),pe.current.disconnect())}catch(f){console.error("Error leaving session:",f)}};if(typeof qr>"u"||typeof ne>"u")return g.jsxs("div",{style:{padding:"20px",color:"red"},children:[g.jsx("h4",{children:"Render Error"}),g.jsx("p",{children:"Material-UI components not available"}),g.jsx("button",{onClick:()=>window.location.reload(),children:"Reload Page"})]});const Vs=Array.isArray(_)?_:[],ue=l||{};return g.jsxs(qr,{maxWidth:"md",children:[g.jsx(Jn,{position:"static",color:"primary",sx:{mb:2},children:g.jsxs(Yn,{children:[g.jsx(Gs,{edge:"start",color:"inherit",onClick:()=>s(-1),children:g.jsx(eo,{})}),g.jsx(ne,{variant:"h6",sx:{flexGrow:1},children:"Traffic Jam - Audio Session"}),g.jsx(Gs,{color:"inherit",onClick:()=>Ht(!0),children:g.jsx(to,{})})]})}),g.jsxs(kt,{elevation:3,sx:{p:3,mb:4},children:[m&&g.jsx(Hs,{severity:"error",sx:{mb:2},children:m}),xe&&g.jsx(Hs,{severity:"error",sx:{mb:2},children:xe}),g.jsxs(ee,{sx:{display:"flex",justifyContent:"flex-end",mb:3},children:[g.jsx(Pe,{variant:"outlined",color:"secondary",onClick:jr,disabled:!A,sx:{mr:2},children:"Leave Audio"}),g.jsx(Pe,{variant:"outlined",color:"info",onClick:()=>{console.log("🔍 DEBUG: Current WebRTC state"),console.log("🔍 Peer connection:",Z.current),Z.current&&(console.log("🔍 Connection state:",Z.current.connectionState),console.log("🔍 ICE connection state:",Z.current.iceConnectionState),console.log("🔍 Signaling state:",Z.current.signalingState),console.log("🔍 Local description:",Z.current.localDescription),console.log("🔍 Remote description:",Z.current.remoteDescription)),console.log("🔍 Local stream:",b),b&&console.log("🔍 Local tracks:",b.getTracks().map(v=>({kind:v.kind,enabled:v.enabled,readyState:v.readyState})));const f=document.getElementById("remote-audios");f&&(console.log("🔍 Remote audio elements:",f.children.length),Array.from(f.children).forEach((v,y)=>{console.log(`🔍 Audio element ${y}:`,{srcObject:!!v.srcObject,volume:v.volume,muted:v.muted,paused:v.paused,readyState:v.readyState,networkState:v.networkState})})),console.log("🔍 Signaling connected:",!!pe.current),console.log("🔍 Participants:",_)},sx:{mr:2},children:"Debug State"}),Sn?g.jsx(Pe,{variant:"contained",color:"error",onClick:()=>{pe.current&&(pe.current.emit("leave-audio-session",{sessionId:(ue==null?void 0:ue.id)||r}),pe.current.disconnect(),Ar(null),pe.current=null,dt(!1))},children:"Disconnect Signaling"}):g.jsx(Pe,{variant:"contained",color:"primary",onClick:()=>{try{console.log("🔘 Connect Signaling button clicked"),He(!0),C(null);const f=An((ue==null?void 0:ue.id)||r);console.log("📡 Signaling setup initiated, socket object:",f),f.on("connect",()=>{console.log("🎯 Socket connected, initializing WebRTC..."),On((ue==null?void 0:ue.id)||r)})}catch(f){console.error("❌ Error setting up signaling:",f),He(!1),C(`Failed to setup signaling: ${f.message}`)}},disabled:!ue||!ue.id||Nr,children:Nr?"Connecting...":"Connect Signaling"})]}),t?g.jsxs(ee,{children:[g.jsxs(kt,{variant:"outlined",sx:{p:2,mb:2},children:[g.jsx(ne,{variant:"subtitle1",gutterBottom:!0,children:"Mic Controls"}),g.jsxs(Jt,{container:!0,spacing:2,alignItems:"center",children:[g.jsx(Jt,{item:!0,children:g.jsx(so,{title:Ne?"Push-to-Talk Active":re?"Unmute Microphone (tap) or Push-to-Talk (hold)":"Mute Microphone",children:g.jsx(Gs,{color:Ne?"secondary":re?"default":"primary",onMouseDown:Fr,onMouseUp:Us,onMouseLeave:Pn,onTouchStart:Fr,onTouchEnd:Us,"aria-label":re?"Unmute":"Mute",sx:{width:56,height:56,transition:"all 0.2s ease-in-out",transform:Ne?"scale(1.2)":"scale(1)",boxShadow:Ne?"0 0 10px rgba(255,0,0,0.5)":"none"},children:Ne?g.jsx(Qt,{}):re?g.jsx(ho,{}):g.jsx(Qt,{})})})}),g.jsx(Jt,{item:!0,xs:!0,children:g.jsx(ee,{sx:{width:"100%"},children:g.jsx(ee,{sx:{height:8,bgcolor:"grey.200",borderRadius:1,overflow:"hidden"},children:g.jsx(ee,{sx:{width:`${ce*100}%`,height:"100%",bgcolor:ce>.5?"success.main":"primary.main",transition:"width 0.1s ease-in-out"}})})})}),g.jsx(Jt,{item:!0,children:g.jsx(ne,{variant:"caption",color:"textSecondary",children:Ne?"Speaking (Push-to-Talk)":re?"Muted (Tap to unmute, hold for Push-to-Talk)":"Unmuted (Tap to mute)"})})]})]}),g.jsxs(kt,{variant:"outlined",sx:{p:2},children:[g.jsx(ne,{variant:"subtitle1",gutterBottom:!0,children:"Speaker Settings"}),g.jsxs(ee,{sx:{mb:3},children:[g.jsx(ro,{control:g.jsx(io,{checked:Pr,onChange:f=>_n(f.target.checked),color:"primary"}),label:"Monitor Local Audio (hear yourself)"}),g.jsx(ne,{variant:"caption",color:"textSecondary",children:"Enable to test microphone input (low volume to avoid feedback)"})]}),g.jsxs(ee,{sx:{mb:3,width:"100%"},children:[g.jsx(ne,{id:"voice-volume-slider",gutterBottom:!0,children:"Voice Volume"}),g.jsxs(ee,{sx:{display:"flex",alignItems:"center",gap:2},children:[g.jsx(Kr,{}),g.jsx(ee,{sx:{flexGrow:1},children:g.jsx(Wr,{value:ct,onChange:(f,v)=>gn(v),"aria-labelledby":"voice-volume-slider",min:0,max:1,step:.01,valueLabelDisplay:"auto",valueLabelFormat:f=>`${Math.round(f*100)}%`,sx:{width:"100%","& .MuiSlider-rail":{height:4},"& .MuiSlider-track":{height:4}}})}),g.jsx(Qr,{})]})]}),g.jsxs(ee,{sx:{width:"100%"},children:[g.jsx(ne,{id:"music-volume-slider",gutterBottom:!0,children:"Music Volume"}),g.jsxs(ee,{sx:{display:"flex",alignItems:"center",gap:2},children:[g.jsx(Kr,{}),g.jsx(ee,{sx:{flexGrow:1},children:g.jsx(Wr,{value:yn,onChange:(f,v)=>wn(v),"aria-labelledby":"music-volume-slider",min:0,max:1,step:.01,valueLabelDisplay:"auto",valueLabelFormat:f=>`${Math.round(f*100)}%`,sx:{width:"100%","& .MuiSlider-rail":{height:4},"& .MuiSlider-track":{height:4}}})}),g.jsx(Qr,{})]})]})]}),g.jsx("div",{id:"remote-audios",style:{display:"none"}}),b&&Pr&&g.jsx("audio",{ref:f=>{f&&b&&(f.srcObject=b,f.volume=.5,f.muted=!1)},style:{display:"none"},autoPlay:!0,muted:!1}),g.jsxs(kt,{variant:"outlined",sx:{mt:2,p:2},children:[g.jsx(ne,{variant:"subtitle1",gutterBottom:!0,children:"Audio Test"}),g.jsx(ne,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Test your microphone by speaking. The level meter above should move when you talk."}),g.jsxs(ee,{sx:{display:"flex",gap:2,alignItems:"center"},children:[g.jsx(Pe,{variant:"outlined",onClick:()=>{b?(console.log("🎤 Current audio tracks:",b.getAudioTracks().map(f=>({enabled:f.enabled,muted:f.muted,readyState:f.readyState,label:f.label}))),alert(`Microphone working! Tracks: ${b.getAudioTracks().length}`)):alert("No microphone stream available")},children:"Test Mic Status"}),g.jsxs(ne,{variant:"caption",color:"text.secondary",children:["Input Level: ",Math.round(ce*100),"%"]})]})]}),g.jsxs(kt,{variant:"outlined",sx:{mt:2,p:2},children:[g.jsx(ne,{variant:"subtitle1",children:"Participants"}),g.jsx(Zn,{dense:!0,children:Vs&&Vs.length>0?Vs.filter(f=>f).map((f,v)=>g.jsxs(Qn.Fragment,{children:[g.jsxs(Gr,{children:[g.jsx(no,{children:g.jsx(oo,{children:g.jsx(ao,{})})}),g.jsx(Hr,{primary:f.display_name||f.name||f.id||f.socketId||"Unknown",secondary:f.socketId?`socket:${f.socketId}`:f.id?`id:${f.id}`:""})]}),g.jsx(Xn,{variant:"inset",component:"li"})]},f.socketId||f.id||`participant-${v}`)):g.jsx(Gr,{children:g.jsx(Hr,{primary:"No participants yet"})})})]})]}):g.jsxs(ee,{sx:{p:3,display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",bgcolor:"background.paper",borderRadius:1,minHeight:200},children:[console.log("🎤 Rendering mic init UI:",{micInitialized:t,requiresUserGesture:a,micInitializing:n}),g.jsx(Qt,{sx:{fontSize:48,color:"primary.main",mb:2}}),g.jsx(ne,{variant:"h6",gutterBottom:!0,children:"Initialize Microphone"}),g.jsx(ne,{variant:"body2",color:"text.secondary",align:"center",sx:{mb:3,maxWidth:400},children:a?"Click the button below to grant microphone access. This is required for some browsers.":"Initializing microphone access..."}),a?g.jsx(Pe,{variant:"contained",color:"primary",size:"large",startIcon:g.jsx(Qt,{}),onClick:zs,disabled:n,sx:{minWidth:200},children:n?g.jsxs(g.Fragment,{children:[g.jsx(Kt,{size:20,sx:{mr:1}}),"Initializing..."]}):"Grant Microphone Access"}):g.jsxs(ee,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[g.jsx(Kt,{size:40}),xe&&g.jsxs(ee,{sx:{textAlign:"center"},children:[g.jsx(Hs,{severity:"error",sx:{mb:2,maxWidth:400},children:xe}),g.jsx(Pe,{variant:"outlined",color:"primary",onClick:()=>{le(null),zs()},disabled:n,children:n?g.jsxs(g.Fragment,{children:[g.jsx(Kt,{size:16,sx:{mr:1}}),"Retrying..."]}):"Retry Microphone Access"})]})]})]})]}),g.jsxs(co,{open:bn,onClose:()=>Ht(!1),children:[g.jsx(lo,{children:"Leave Traffic Jam Session?"}),g.jsx(po,{children:g.jsx(ne,{children:"Are you sure you want to leave this audio session? You will need to rejoin to continue communicating."})}),g.jsxs(uo,{children:[g.jsx(Pe,{onClick:()=>Ht(!1),children:"Cancel"}),g.jsx(Pe,{onClick:()=>{Ht(!1),jr()},color:"secondary",disabled:Or,children:Or?g.jsx(Kt,{size:24}):"Leave"})]})]})]})};export{Ll as default};
