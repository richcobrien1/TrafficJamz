import{r as a,c as Qe,m as Yt,j as e,d as Te,k as Xt,h as Qt,a as Zt,u as er,n as te,M as tr,R as rr,i as ce}from"./index-C_3tyMlA.js";import{g as Et,a as _t,u as or,s as Se,c as Ze,m as et,T as f,r as nr,B as x,P as sr}from"./Box-B7n4D01-.js";import{f as ar,e as Dt,d as gt,a as ir,c as X,C as xt,I as T,L as ft,B as Ye}from"./List-K2ODHGaJ.js";import{g as cr,b as je,A as lr,T as dr,D as yt,L as K,a as Y}from"./Toolbar-C16-zNA2.js";import{A as ur}from"./ArrowBack-CbxRKbGl.js";import{T as re,F as ve,S as $e}from"./Tooltip-Awt_KCTI.js";import{L as bt}from"./LocationOn-CXBPx9JF.js";import{T as pr,g as jt,A as Ae}from"./Grow-5OE428Pa.js";import{C as vt}from"./Close-85iuI7l9.js";import{D as mr,B as hr}from"./Drawer-CLSZ2vVr.js";import{L as gr}from"./ListItemAvatar-mpGPWVKz.js";import{A as wt}from"./Avatar-CTdIBAVi.js";import{C as xr}from"./Chip-0VM-YCcI.js";import{D as St,a as Lt,b as Ct,c as Mt}from"./DialogTitle-CyEuKmcp.js";import{S as we}from"./Switch-CUqeLwf6.js";import"./mergeSlotProps-COfFLBTA.js";function fr(s){return Et("MuiCollapse",s)}_t("MuiCollapse",["root","horizontal","vertical","entered","hidden","wrapper","wrapperInner"]);const yr=s=>{const{orientation:m,classes:h}=s,S={root:["root",`${m}`],entered:["entered"],hidden:["hidden"],wrapper:["wrapper",`${m}`],wrapperInner:["wrapperInner",`${m}`]};return Ze(S,fr,h)},br=Se("div",{name:"MuiCollapse",slot:"Root",overridesResolver:(s,m)=>{const{ownerState:h}=s;return[m.root,m[h.orientation],h.state==="entered"&&m.entered,h.state==="exited"&&!h.in&&h.collapsedSize==="0px"&&m.hidden]}})(et(({theme:s})=>({height:0,overflow:"hidden",transition:s.transitions.create("height"),variants:[{props:{orientation:"horizontal"},style:{height:"auto",width:0,transition:s.transitions.create("width")}},{props:{state:"entered"},style:{height:"auto",overflow:"visible"}},{props:{state:"entered",orientation:"horizontal"},style:{width:"auto"}},{props:({ownerState:m})=>m.state==="exited"&&!m.in&&m.collapsedSize==="0px",style:{visibility:"hidden"}}]}))),jr=Se("div",{name:"MuiCollapse",slot:"Wrapper"})({display:"flex",width:"100%",variants:[{props:{orientation:"horizontal"},style:{width:"auto",height:"100%"}}]}),vr=Se("div",{name:"MuiCollapse",slot:"WrapperInner"})({width:"100%",variants:[{props:{orientation:"horizontal"},style:{width:"auto",height:"100%"}}]}),Xe=a.forwardRef(function(m,h){const S=Qe({props:m,name:"MuiCollapse"}),{addEndListener:M,children:U,className:D,collapsedSize:P="0px",component:W,easing:z,in:Q,onEnter:ge,onEntered:k,onEntering:F,onExit:I,onExited:le,onExiting:i,orientation:H="vertical",style:O,timeout:E=Yt.standard,TransitionComponent:L=pr,...Ue}=S,de={...S,orientation:H,collapsedSize:P},Z=yr(de),xe=or(),Le=ar(),V=a.useRef(null),oe=a.useRef(),ne=typeof P=="number"?`${P}px`:P,C=H==="horizontal",ee=C?"width":"height",R=a.useRef(null),ze=Dt(h,R),B=c=>_=>{if(c){const w=R.current;_===void 0?c(w):c(w,_)}},se=()=>V.current?V.current[C?"clientWidth":"clientHeight"]:0,Fe=B((c,_)=>{V.current&&C&&(V.current.style.position="absolute"),c.style[ee]=ne,ge&&ge(c,_)}),ue=B((c,_)=>{const w=se();V.current&&C&&(V.current.style.position="");const{duration:ae,easing:ie}=jt({style:O,timeout:E,easing:z},{mode:"enter"});if(E==="auto"){const Ce=xe.transitions.getAutoHeightDuration(w);c.style.transitionDuration=`${Ce}ms`,oe.current=Ce}else c.style.transitionDuration=typeof ae=="string"?ae:`${ae}ms`;c.style[ee]=`${w}px`,c.style.transitionTimingFunction=ie,F&&F(c,_)}),Oe=B((c,_)=>{c.style[ee]="auto",k&&k(c,_)}),pe=B(c=>{c.style[ee]=`${se()}px`,I&&I(c)}),Be=B(le),$=B(c=>{const _=se(),{duration:w,easing:ae}=jt({style:O,timeout:E,easing:z},{mode:"exit"});if(E==="auto"){const ie=xe.transitions.getAutoHeightDuration(_);c.style.transitionDuration=`${ie}ms`,oe.current=ie}else c.style.transitionDuration=typeof w=="string"?w:`${w}ms`;c.style[ee]=ne,c.style.transitionTimingFunction=ae,i&&i(c)}),Ge=c=>{E==="auto"&&Le.start(oe.current||0,c),M&&M(R.current,c)};return e.jsx(L,{in:Q,onEnter:Fe,onEntered:Oe,onEntering:ue,onExit:pe,onExited:Be,onExiting:$,addEndListener:Ge,nodeRef:R,timeout:E==="auto"?null:E,...Ue,children:(c,{ownerState:_,...w})=>e.jsx(br,{as:W,className:Te(Z.root,D,{entered:Z.entered,exited:!Q&&ne==="0px"&&Z.hidden}[c]),style:{[C?"minWidth":"minHeight"]:ne,...O},ref:ze,ownerState:{...de,state:c},...w,children:e.jsx(jr,{ownerState:{...de,state:c},className:Z.wrapper,ref:V,children:e.jsx(vr,{ownerState:{...de,state:c},className:Z.wrapperInner,children:U})})})})});Xe&&(Xe.muiSupportAuto=!0);function wr(s){return Et("MuiAlertTitle",s)}_t("MuiAlertTitle",["root"]);const Sr=s=>{const{classes:m}=s;return Ze({root:["root"]},wr,m)},Lr=Se(f,{name:"MuiAlertTitle",slot:"Root"})(et(({theme:s})=>({fontWeight:s.typography.fontWeightMedium,marginTop:-2}))),kt=a.forwardRef(function(m,h){const S=Qe({props:m,name:"MuiAlertTitle"}),{className:M,...U}=S,D=S,P=Sr(D);return e.jsx(Lr,{gutterBottom:!0,component:"div",ownerState:D,ref:h,className:Te(P.root,M),...U})}),Cr=(s,m)=>{const{ownerState:h}=s;return[m.root,h.dense&&m.dense,h.alignItems==="flex-start"&&m.alignItemsFlexStart,h.divider&&m.divider,!h.disableGutters&&m.gutters]},Mr=s=>{const{alignItems:m,classes:h,dense:S,disabled:M,disableGutters:U,divider:D,selected:P}=s,z=Ze({root:["root",S&&"dense",!U&&"gutters",D&&"divider",M&&"disabled",m==="flex-start"&&"alignItemsFlexStart",P&&"selected"]},cr,h);return{...h,...z}},kr=Se(ir,{shouldForwardProp:s=>nr(s)||s==="classes",name:"MuiListItemButton",slot:"Root",overridesResolver:Cr})(et(({theme:s})=>({display:"flex",flexGrow:1,justifyContent:"flex-start",alignItems:"center",position:"relative",textDecoration:"none",minWidth:0,boxSizing:"border-box",textAlign:"left",paddingTop:8,paddingBottom:8,transition:s.transitions.create("background-color",{duration:s.transitions.duration.shortest}),"&:hover":{textDecoration:"none",backgroundColor:(s.vars||s).palette.action.hover,"@media (hover: none)":{backgroundColor:"transparent"}},[`&.${je.selected}`]:{backgroundColor:s.alpha((s.vars||s).palette.primary.main,(s.vars||s).palette.action.selectedOpacity),[`&.${je.focusVisible}`]:{backgroundColor:s.alpha((s.vars||s).palette.primary.main,`${(s.vars||s).palette.action.selectedOpacity} + ${(s.vars||s).palette.action.focusOpacity}`)}},[`&.${je.selected}:hover`]:{backgroundColor:s.alpha((s.vars||s).palette.primary.main,`${(s.vars||s).palette.action.selectedOpacity} + ${(s.vars||s).palette.action.hoverOpacity}`),"@media (hover: none)":{backgroundColor:s.alpha((s.vars||s).palette.primary.main,(s.vars||s).palette.action.selectedOpacity)}},[`&.${je.focusVisible}`]:{backgroundColor:(s.vars||s).palette.action.focus},[`&.${je.disabled}`]:{opacity:(s.vars||s).palette.action.disabledOpacity},variants:[{props:({ownerState:m})=>m.divider,style:{borderBottom:`1px solid ${(s.vars||s).palette.divider}`,backgroundClip:"padding-box"}},{props:{alignItems:"flex-start"},style:{alignItems:"flex-start"}},{props:({ownerState:m})=>!m.disableGutters,style:{paddingLeft:16,paddingRight:16}},{props:({ownerState:m})=>m.dense,style:{paddingTop:4,paddingBottom:4}}]}))),Ir=a.forwardRef(function(m,h){const S=Qe({props:m,name:"MuiListItemButton"}),{alignItems:M="center",autoFocus:U=!1,component:D="div",children:P,dense:W=!1,disableGutters:z=!1,divider:Q=!1,focusVisibleClassName:ge,selected:k=!1,className:F,...I}=S,le=a.useContext(gt),i=a.useMemo(()=>({dense:W||le.dense||!1,alignItems:M,disableGutters:z}),[M,le.dense,W,z]),H=a.useRef(null);Xt(()=>{U&&H.current&&H.current.focus()},[U]);const O={...S,alignItems:M,dense:i.dense,disableGutters:z,divider:Q,selected:k},E=Mr(O),L=Dt(H,h);return e.jsx(gt.Provider,{value:i,children:e.jsx(kr,{ref:L,href:I.href||I.to,component:(I.href||I.to)&&D==="div"?"button":D,focusVisibleClassName:Te(E.focusVisible,ge),ownerState:O,className:Te(E.root,F),...I,classes:E,children:P})})}),Er=X(e.jsx("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"})),_r=X(e.jsx("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"})),Dr=X(e.jsx("path",{d:"M12 6.5c1.38 0 2.5 1.12 2.5 2.5 0 .74-.33 1.39-.83 1.85l3.63 3.63c.98-1.86 1.7-3.8 1.7-5.48 0-3.87-3.13-7-7-7-1.98 0-3.76.83-5.04 2.15l3.19 3.19c.46-.52 1.11-.84 1.85-.84m4.37 9.6-4.63-4.63-.11-.11L3.27 3 2 4.27l3.18 3.18C5.07 7.95 5 8.47 5 9c0 5.25 7 13 7 13s1.67-1.85 3.38-4.35L18.73 21 20 19.73z"})),Pr=X(e.jsx("path",{d:"M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4m8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7"})),Rr=X(e.jsx("path",{d:"M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3m-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3m0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5m8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5"})),It=X(e.jsx("path",{d:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7m0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5"})),$r=X(e.jsx("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4z"})),Ar=X(e.jsx("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2M5 4.99h3C8 6.65 6.66 8 5 8zM5 12v-2c2.76 0 5-2.25 5-5.01h2C12 8.86 8.87 12 5 12m0 6 3.5-4.5 2.5 3.01L14.5 12l4.5 6z"})),Tr=X(e.jsx("path",{d:"M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6"})),eo=()=>{const s=()=>{try{const t=localStorage.getItem("lastUserLocation");if(t){const r=JSON.parse(t);return[r.longitude,r.latitude]}}catch{}return[-104.882029,39.57364]},[m]=a.useState(s),[h,S]=a.useState(!1),[M,U]=a.useState(0),[D,P]=a.useState(0),[W,z]=a.useState(15),[Q,ge]=a.useState(!1),[k,F]=a.useState([]),[I,le]=a.useState(!0),[i,H]=a.useState(null),[O,E]=a.useState(null),[L,Ue]=a.useState([]),[de,Z]=a.useState(!0),[xe,Le]=a.useState(""),[V,oe]=a.useState(!1),[ne,C]=a.useState(!1),[ee,R]=a.useState(null),[ze,B]=a.useState(0),[se,Fe]=a.useState(!0),[ue,Oe]=a.useState(30),[pe,Be]=a.useState(100),[$,Ge]=a.useState(.9),[c,_]=a.useState(!0),[w,ae]=a.useState(!1),[ie,Ce]=a.useState(!1),[Pt,Ne]=a.useState(!1),[p,tt]=a.useState(null),[Rt,fe]=a.useState(!1),[Me,$t]=a.useState(!1),[me,We]=a.useState(!1),[v,At]=a.useState(!1),[ke]=a.useState(100),[rt]=a.useState(!1),[Ur,ot]=a.useState([]),He=a.useRef(null),b=a.useRef(null),Ie=a.useRef({}),Ee=a.useRef(null),_e=a.useRef(null);a.useRef(null);const A=a.useRef(null),{groupId:G}=Qt(),Tt=Zt(),{user:o}=er(),Ve=async()=>{if(!L||L.length===0){console.log("Skipping location fetch - member data not loaded yet");return}const t=Date.now();if(!(t-M<5e3)){U(t);try{const d=(await ce.get(`/location/group/${G}`)).data.locations;D>0&&(P(0),z(15));const u=d.map(y=>{const j=L.find(q=>q.user_id===y.user_id);return y.user_id===(o==null?void 0:o.id)?{...y,username:(o==null?void 0:o.username)||"CurrentUser",first_name:(o==null?void 0:o.first_name)||null}:j?{...y,username:j.username,first_name:j.first_name}:null}).filter(y=>y!==null);F(u);let g=u;if(i){const y={user_id:(o==null?void 0:o.id)||"current-user",username:(o==null?void 0:o.username)||"CurrentUser",first_name:(o==null?void 0:o.first_name)||null,coordinates:i,timestamp:new Date().toISOString(),battery_level:85},j=u.filter(q=>q.user_id!==((o==null?void 0:o.id)||"current-user"));g=[y,...j]}N(g),I&&i&&mt(u)}catch(l){console.error("Error in fetchMemberLocations (rate limited):",l)}}};a.useEffect(()=>{h&&Ve();const t=setInterval(()=>{h&&Ve()},Q?W*1e4:Math.max(ue*1e3,15e3));return()=>clearInterval(t)},[h,ue,Q,W,G,i,I,D,M]);const Ut=async()=>{try{Z(!0);const r=(await ce.get(`/groups/${G}`)).data.group;console.log("Group data received:",r),console.log("Members in group:",r.members),E(r),Ue(r.members),De(r.members),h&&setTimeout(()=>{Ve()},100);try{((await ce.get(`/groups/${G}/places`)).data.places||[]).length>0&&We(!0)}catch(n){console.warn("Could not fetch places for group:",n)}Le("")}catch(t){console.error("Error fetching group details:",t),Le("Failed to load group details. Please try again later.")}finally{Z(!1)}},De=async(t=null)=>{try{const l=(await ce.get(`/location/group/${G}`)).data.locations.map(u=>{const g=(t||L).find(y=>y.user_id===u.user_id);return u.user_id===(o==null?void 0:o.id)?{...u,username:(o==null?void 0:o.username)||"CurrentUser",first_name:(o==null?void 0:o.first_name)||null}:g?{...u,username:g.username,first_name:g.first_name}:null}).filter(u=>u!==null);F(l);let d=l;if(i){const u={user_id:(o==null?void 0:o.id)||"current-user",username:(o==null?void 0:o.username)||"CurrentUser",first_name:(o==null?void 0:o.first_name)||null,coordinates:i,timestamp:new Date().toISOString(),battery_level:85},g=l.filter(y=>y.user_id!==((o==null?void 0:o.id)||"current-user"));d=[u,...g]}return v||N(d),I&&i&&mt(l),l}catch(r){return console.error("Error fetching member locations:",r),[]}},zt=async()=>{if(!L||L.length===0){console.log("Skipping manual location fetch - member data not loaded yet");return}const t=await De();F(t)};a.useEffect(()=>{st()},[]),a.useEffect(()=>{Ut()},[]),a.useEffect(()=>{(async()=>{if(me&&b.current)try{const r=await Ft();console.log("Fetched places:",r);const n=await De(),d=[...i?[{user_id:(o==null?void 0:o.id)||"current-user",username:(o==null?void 0:o.username)||"CurrentUser",first_name:(o==null?void 0:o.first_name)||null,coordinates:i,timestamp:new Date().toISOString(),battery_level:85}]:[],...n,...r];N(v?r:d)}catch(r){console.error("Error fetching places:",r)}else if(!me&&b.current&&!v){const n=[...i?[{user_id:(o==null?void 0:o.id)||"current-user",username:(o==null?void 0:o.username)||"CurrentUser",first_name:(o==null?void 0:o.first_name)||null,coordinates:i,timestamp:new Date().toISOString(),battery_level:85}]:[],...k];N(n)}})()},[me,G,L,i]),a.useEffect(()=>(v&&b.current?dt():Pe(),()=>{Pe()}),[v]);const Ft=async()=>{if(!G)return[];try{return((await ce.get(`/groups/${G}/places`)).data.places||[]).map(n=>({user_id:`place_${n._id}`,username:n.name,coordinates:{latitude:n.coordinates.latitude,longitude:n.coordinates.longitude},timestamp:n.createdAt,battery_level:null,place:!0,raw:n}))}catch(t){return console.warn("Failed to fetch places for group",t),[]}},Ot=(t,r,n)=>{if(r)return r.trim();if(t){const l=t.trim().split(" ");if(l.length>=2)return`${l[0]} ${l[1].charAt(0).toUpperCase()}.`;const d=t.split("_");if(d.length>=2)return`${d[0]} ${d[1].charAt(0).toUpperCase()}.`;const u=t.split(".");return u.length>=2?`${u[0]} ${u[1].charAt(0).toUpperCase()}.`:(t.startsWith("Member "),t)}return t||"Unknown"},nt=async t=>{if(!L||L.length===0){console.log("Skipping runtime data generation - member data not loaded yet");return}try{const r=await De(),n=[],l=new Set;if((r||[]).forEach(d=>{l.add(String(d.user_id)),n.push(d)}),i){const d={user_id:(o==null?void 0:o.id)||"current-user",username:(o==null?void 0:o.username)||"CurrentUser",first_name:(o==null?void 0:o.first_name)||null,coordinates:i,timestamp:new Date().toISOString(),battery_level:85};l.has(String(d.user_id))||(n.push(d),l.add(String(d.user_id)))}F(n),v||N(n)}catch(r){console.error("Error generating runtime data:",r)}},st=()=>{if(!te){console.error("Mapbox GL JS is not available"),oe(!0);return}Pe();try{if(!He.current){setTimeout(()=>{st()},100);return}te.accessToken=tr;const t=new te.Map({container:He.current,style:"mapbox://styles/mapbox/streets-v12",center:m,zoom:13});t.on("load",()=>{oe(!0),b.current=t;try{window.__TJ_MAP__=t}catch{}t.on("error",n=>{console.error("Map error:",n)}),i&&ye(i),Ee.current?(v||N(Ee.current),Ee.current=null):k.length>0&&(v||N(k)),t.addControl(new te.NavigationControl,"bottom-right"),t.addControl(new te.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0}),"bottom-right");const r=()=>{try{const n=t.getCenter();nt({lng:n.lng,lat:n.lat})}catch(n){console.error("Error during map moveend runtime data generation",n)}};t.on("click",n=>{try{const{lngLat:l}=n;window.dispatchEvent(new CustomEvent("tj:open-place-dialog",{detail:{lat:l.lat,lng:l.lng}}))}catch(l){console.error("Failed to dispatch open-place-dialog",l)}}),t.on("moveend",r);try{const n=t.getCenter();nt({lng:n.lng,lat:n.lat})}catch(n){console.error("Initial runtime data generation failed",n)}})}catch(t){console.error("Error initializing map:",t),oe(!0)}},Bt=()=>{if(!navigator.geolocation){R("Geolocation is not supported by your browser");return}if(ne)return;C(!0);const t={enableHighAccuracy:se,timeout:3e4,maximumAge:1e4};try{navigator.geolocation.getCurrentPosition(r=>{qe(r),Gt()},r=>{console.log("Error getting initial position:",r),R("Failed to get initial location. "+it(r)),C(!1)},t)}catch(r){console.error("Error starting location tracking:",r),R("Failed to start location tracking. Please try again."),C(!1)}},Gt=()=>{const t={enableHighAccuracy:se,timeout:25e3,maximumAge:15e3};try{_e.current=navigator.geolocation.watchPosition(qe,at,t)}catch(r){console.error("Error setting up position watching:",r),R("Failed to set up continuous location tracking."),C(!1)}},qe=t=>{const{latitude:r,longitude:n,accuracy:l,altitude:d,heading:u,speed:g}=t.coords;if(l>ke){console.log("Position too inaccurate, skipping:",l,"meters (threshold:",ke,"meters)");return}const y={latitude:r,longitude:n,accuracy:l,altitude:d||0,heading:u||0,speed:g||0,timestamp:Date.now()};if(rt)ot(j=>{const he=[...j,y].filter(J=>Date.now()-J.timestamp<1e4);if(he.length>=3){const J=he.reduce((be,Re)=>Re.accuracy<be.accuracy?Re:be);H(J),R(null),C(!1),B(0);try{localStorage.setItem("lastUserLocation",JSON.stringify(J))}catch{}return ct(J),!i&&b.current&&ye(J),pt(J),[]}return he});else{H(y),R(null),C(!1),B(0);try{localStorage.setItem("lastUserLocation",JSON.stringify(y))}catch{}ct(y),!i&&b.current&&ye(y),pt(y)}},at=t=>{console.error("Error getting location:",t);const r=ze+1;B(r);const n=it(t);if(r>=3){R(`${n} Please check your location permissions and try again.`),C(!1);return}else setTimeout(()=>{navigator.geolocation.getCurrentPosition(qe,at,{enableHighAccuracy:!0,timeout:45e3,maximumAge:2e4})},2e3)},it=t=>{let r="Error getting your location.";switch(t.code){case t.PERMISSION_DENIED:r="Location permission denied. Please enable location services for this site.";break;case t.POSITION_UNAVAILABLE:r="Location information is unavailable. Please try again later.";break;case t.TIMEOUT:r="Location request timed out. Please try again.";break;default:r=`Location error: ${t.message}`}return r},Nt=()=>{_e.current&&(navigator.geolocation.clearWatch(_e.current),_e.current=null),C(!1),ot([])},Wt=()=>{const t=!h;S(t),t?Bt():Nt()},ct=async t=>{try{const r={coordinates:{latitude:t.latitude,longitude:t.longitude,altitude:t.altitude||0,accuracy:t.accuracy||0,heading:t.heading||0,speed:t.speed||0},battery_level:85,connection_type:navigator.connection?navigator.connection.type:"unknown"};await ce.post("/location/update",r)}catch(r){console.error("Error updating location on server:",r)}},ye=t=>{console.log("Centering map on location:",t),console.log("Map ref exists:",!!b.current),b.current&&t&&t.latitude&&t.longitude?(console.log("Flying to:",[t.longitude,t.latitude]),b.current.flyTo({center:[t.longitude,t.latitude],zoom:15,essential:!0})):console.log("Cannot center map - missing map ref or location data")},lt=t=>{if(b.current){const r=t?"mapbox://styles/mapbox/satellite-streets-v12":"mapbox://styles/mapbox/streets-v12";b.current.setStyle(r),$t(t)}},Ht=a.useCallback(t=>{tt(t),fe(!0)},[]),Vt=a.useCallback(t=>{const r=k.find(n=>n.user_id===t.user_id);r&&(tt(r),fe(!0))},[k]),dt=()=>{if(!b.current||A.current)return;const t=document.createElement("div");t.style.width="24px",t.style.height="24px",t.style.borderRadius="50%",t.style.backgroundColor="#2196f3",t.style.border="3px solid white",t.style.boxShadow="0 2px 8px rgba(0,0,0,0.3)",t.style.position="relative",t.innerHTML='<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: bold;">+</div>';const r=b.current.getCenter();A.current=new te.Marker(t,{anchor:"center"}).setLngLat([r.lng,r.lat]).addTo(b.current);const n=()=>{if(A.current&&b.current){const l=b.current.getCenter();A.current.setLngLat([l.lng,l.lat])}};b.current.on("move",n),A.current.updateFunction=n},Pe=()=>{A.current&&(A.current.updateFunction&&b.current&&b.current.off("move",A.current.updateFunction),A.current.remove(),A.current=null)},ut=()=>{const t=!v;if(At(t),t)dt();else{if(b.current&&A.current){const r=b.current.getCenter();qt(r.lat,r.lng)}Pe()}},qt=async(t,r)=>{try{const n=prompt("Enter a name for this place:","New Place");if(!n||n.trim()==="")return;const l={name:n.trim(),latitude:t,longitude:r},d=await ce.post(`/groups/${G}/places`,l);if(d.data.success){console.log("Place created successfully:",d.data.place);const u={user_id:`place_${d.data.place._id}`,username:d.data.place.name,coordinates:{latitude:d.data.place.coordinates.latitude,longitude:d.data.place.coordinates.longitude},timestamp:d.data.place.createdAt,battery_level:null,place:!0,raw:d.data.place};F(g=>[...g,u]),N([...k,u]),We(!0),alert(`Place "${n}" created successfully!`)}else throw new Error(d.data.message||"Failed to create place")}catch(n){console.error("Error creating place:",n),alert("Failed to create place. Please try again.")}},N=t=>{if(!b.current||!te){Ee.current=t;return}console.log("Removing",Object.keys(Ie.current).length,"existing markers"),Object.values(Ie.current).forEach(r=>{r&&typeof r.remove=="function"&&r.remove()}),Ie.current={},t.forEach((r,n)=>{if(!r.coordinates)return;const{latitude:l,longitude:d}=r.coordinates,u=document.createElement("div");u.style.position="relative",u.style.cursor="pointer",u.style.width="32px",u.style.height="40px",u.style.display="flex",u.style.flexDirection="column",u.style.alignItems="center";const g=document.createElement("div");g.style.width="24px",g.style.height="24px",g.style.borderRadius="50%",g.style.backgroundColor=r.place?"green":"orange",g.style.border="2px solid white",g.style.boxShadow="0 2px 4px rgba(0,0,0,0.3)",g.style.display="flex",g.style.alignItems="center",g.style.justifyContent="center",g.style.color="white",g.style.fontSize="12px",g.style.fontWeight="bold",g.style.textTransform="uppercase";const y=r.place?"📍":r.username?r.username.charAt(0).toUpperCase():"?";g.textContent=y;const j=document.createElement("div");j.style.width="0",j.style.height="0",j.style.borderLeft="6px solid transparent",j.style.borderRight="6px solid transparent",j.style.borderTop=`8px solid ${r.place?"green":"orange"}`,j.style.marginTop="-2px",u.appendChild(g),u.appendChild(j);const q=r.place?r.username:Ot(r.username,r.first_name),he=new Date(r.timestamp).toLocaleString();u.title=`${q}
Last updated: ${he}`;const J=new te.Marker(u,{anchor:"bottom"}).setLngLat([d,l]).addTo(b.current);u.addEventListener("click",Re=>{Re.stopPropagation(),Ht(r)});const be=`${r.user_id}__${n}`;Ie.current[be]=J})},pt=t=>{const r={user_id:(o==null?void 0:o.id)||"current-user",username:(o==null?void 0:o.username)||"CurrentUser",first_name:(o==null?void 0:o.first_name)||null,coordinates:t,timestamp:new Date().toISOString(),battery_level:85},n=k.filter(d=>d.user_id!==((o==null?void 0:o.id)||"current-user")),l=[r,...n];v||N(l)},mt=t=>{i&&t.forEach(r=>{if(r.user_id===((o==null?void 0:o.id)||"current-user")||!r.coordinates)return;const n=Je(i.latitude,i.longitude,r.coordinates.latitude,r.coordinates.longitude);n<=pe&&console.log(`${r.username} is within ${Math.round(n)}m of you!`)})},Je=(t,r,n,l)=>{const u=t*Math.PI/180,g=n*Math.PI/180,y=(n-t)*Math.PI/180,j=(l-r)*Math.PI/180,q=Math.sin(y/2)*Math.sin(y/2)+Math.cos(u)*Math.cos(g)*Math.sin(j/2)*Math.sin(j/2);return 6371e3*(2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q)))},ht=t=>t<1e3?`${Math.round(t)}m`:`${(t/1e3).toFixed(1)}km`,Jt=()=>{_(!c)},Ke=()=>{ae(!w)},Kt=()=>{Ce(!ie)};return de?e.jsxs(x,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh",flexDirection:"column",gap:2},children:[e.jsx(xt,{size:60}),e.jsx(f,{variant:"h6",children:"Loading location tracking..."})]}):e.jsxs(x,{sx:{height:"100vh",width:"100vw",position:"relative",overflow:"hidden"},children:[e.jsxs(x,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,zIndex:0},children:[e.jsx(x,{ref:He,id:"mapbox-container",sx:{position:"absolute",top:0,left:0,right:0,bottom:0}}),!V&&e.jsxs(x,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"action.hover",zIndex:1},children:[e.jsx(xt,{size:60}),e.jsx(f,{sx:{position:"absolute",top:"60%",color:"text.secondary",fontSize:"12px"},children:"Loading map..."})]})]}),e.jsx(lr,{position:"absolute",color:"default",elevation:0,sx:{opacity:$,backdropFilter:"blur(2px)",bgcolor:"rgba(0,0,0,0.7)",color:"text.primary",transition:"all 0.3s ease",top:c?0:-64,zIndex:10},children:e.jsxs(dr,{children:[e.jsx(T,{edge:"start",color:"inherit",onClick:()=>Tt(`/groups/${G}`),sx:{mr:2},children:e.jsx(ur,{})}),e.jsx(f,{variant:"h6",component:"div",sx:{flexGrow:1},children:(O==null?void 0:O.name)||"Location Tracking"}),e.jsx(re,{title:h?"Stop Sharing Location":"Start Sharing Location",children:e.jsx(T,{color:h?"primary":"default",onClick:Wt,children:h?e.jsx(bt,{}):e.jsx(Dr,{})})}),e.jsx(re,{title:"Refresh Locations",children:e.jsx(T,{color:"inherit",onClick:zt,children:e.jsx($r,{})})}),e.jsx(re,{title:"Settings",children:e.jsx(T,{color:"inherit",onClick:()=>Ne(!0),children:e.jsx(Tr,{})})}),e.jsx(re,{title:Me?"Switch to Streets View":"Switch to Satellite View",children:e.jsx(T,{color:Me?"primary":"inherit",onClick:()=>lt(!Me),children:e.jsx(Ar,{})})}),e.jsx(re,{title:me?"Hide Places":"Show Places",children:e.jsx(T,{color:me?"secondary":"inherit",onClick:()=>We(!me),children:e.jsx(It,{})})})]})}),e.jsx(re,{title:c?"Hide Controls":"Show Controls",children:e.jsx(T,{sx:{position:"absolute",top:c?72:16,right:16,zIndex:10,bgcolor:"background.paper",color:"text.primary",boxShadow:2,"&:hover":{bgcolor:"background.paper"}},onClick:Jt,children:c?e.jsx(Er,{}):e.jsx(_r,{})})}),e.jsx(re,{title:w?"Hide Members":"Show Members",children:e.jsx(T,{sx:{position:"absolute",top:c?72:16,right:76,zIndex:10,bgcolor:"background.paper",color:"text.primary",boxShadow:2,"&:hover":{bgcolor:"background.paper"}},onClick:Ke,children:e.jsx(Rr,{})})}),e.jsx(re,{title:v?"Record Location as Place":i?"Center on My Location":"Select Location for Place",children:e.jsx("span",{children:e.jsx(T,{sx:{position:"absolute",top:c?72:16,right:136,zIndex:10,bgcolor:v?"primary.main":"background.paper",color:v?"primary.contrastText":"text.primary",boxShadow:2,opacity:i||v?1:.7,"&:hover":{bgcolor:v?"primary.dark":"background.paper",opacity:1}},onClick:v?ut:()=>{i?ye(i):ut()},children:v?e.jsx(It,{}):e.jsx(Pr,{})})})}),e.jsxs(x,{sx:{position:"absolute",top:c?72:16,left:16,right:196,zIndex:10,display:"flex",flexDirection:"column",gap:1},children:[ne&&e.jsxs(Ae,{severity:"info",sx:{opacity:$},children:[e.jsx(kt,{children:"Getting Your Location"}),"Please wait while we determine your position..."]}),Q&&e.jsxs(Ae,{severity:"warning",sx:{opacity:$},children:[e.jsx(kt,{children:"Rate Limit Detected"}),"Too many location requests. Retrying in ",W," seconds."]}),ee&&e.jsx(Ae,{severity:"error",sx:{opacity:$},children:ee}),xe&&e.jsx(Ae,{severity:"error",sx:{opacity:$},children:xe})]}),e.jsx(Xe,{in:ie&&c&&h,children:e.jsxs(sr,{elevation:3,sx:{position:"absolute",bottom:16,left:16,right:16,zIndex:10,p:2,opacity:$,backdropFilter:"blur(2px)",bgcolor:"rgba(0,0,0,0.8)",color:"text.primary",borderRadius:2,maxWidth:600,mx:"auto"},children:[e.jsxs(x,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:1},children:[e.jsx(f,{variant:"subtitle1",children:"Current Location"}),e.jsx(T,{size:"small",onClick:Kt,children:e.jsx(vt,{fontSize:"small"})})]}),e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(bt,{color:"primary"}),e.jsxs(x,{sx:{flexGrow:1},children:[e.jsx(f,{variant:"body2",children:i?`Latitude: ${i.latitude.toFixed(6)}, Longitude: ${i.longitude.toFixed(6)}`:"Acquiring location..."}),i&&e.jsxs(f,{variant:"caption",color:"text.secondary",children:["Accuracy: ±",i.accuracy.toFixed(1)," meters"]})]})]})]})}),e.jsxs(mr,{anchor:"right",open:w,onClose:Ke,variant:"persistent",sx:{width:320,flexShrink:0,"& .MuiDrawer-paper":{width:320,boxSizing:"border-box",opacity:$,backdropFilter:"blur(2px)",bgcolor:"rgba(0,0,0,0.8)",color:"text.primary",border:"none",boxShadow:3,height:"calc(100% - 64px)",top:64,zIndex:5}},children:[e.jsxs(x,{sx:{p:2,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(f,{variant:"h6",children:"Group Members"}),e.jsx(T,{onClick:Ke,children:e.jsx(vt,{})})]}),e.jsx(yt,{}),e.jsx(ft,{sx:{overflow:"auto"},children:L.map((t,r)=>{const n=k.find(u=>u.user_id===t.user_id),l=!!n,d=i&&n&&n.coordinates?Je(i.latitude,i.longitude,n.coordinates.latitude,n.coordinates.longitude):null;return e.jsxs(rr.Fragment,{children:[r>0&&e.jsx(yt,{component:"li"}),e.jsx(K,{component:"li",secondaryAction:e.jsx(xr,{label:d?ht(d):"Unknown",color:d&&d<=pe?"success":"default",size:"small"}),children:e.jsxs(Ir,{onClick:()=>Vt(t),children:[e.jsx(gr,{children:e.jsx(hr,{overlap:"circular",anchorOrigin:{vertical:"bottom",horizontal:"right"},variant:"dot",color:l?"success":"error",children:e.jsx(wt,{src:t.profile_image_url,alt:t.username,children:t.username.charAt(0).toUpperCase()})})}),e.jsx(Y,{primary:t.username,secondary:n?`Last updated: ${new Date(n.timestamp).toLocaleTimeString()}`:"Location not shared"})]})})]},t.user_id)})})]}),e.jsxs(St,{open:Pt,onClose:()=>Ne(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Lt,{children:"Location Settings"}),e.jsxs(Ct,{children:[e.jsxs(x,{sx:{mb:3},children:[e.jsx(ve,{control:e.jsx(we,{checked:Me,onChange:t=>lt(t.target.checked),color:"primary"}),label:"Satellite View"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{display:"block",ml:3},children:"Show satellite imagery with street overlays"})]}),e.jsxs(x,{sx:{mb:3},children:[e.jsx(ve,{control:e.jsx(we,{checked:!1,onChange:t=>{},color:"primary"}),label:"Dark Mode"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{display:"block",ml:3},children:"Toggle between light and dark theme"})]}),e.jsxs(x,{sx:{mb:3},children:[e.jsx(ve,{control:e.jsx(we,{checked:se,onChange:t=>Fe(t.target.checked),color:"primary"}),label:"High Accuracy Mode"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{display:"block",ml:3},children:"Uses GPS for more precise location but consumes more battery"})]}),e.jsxs(x,{sx:{mb:3},children:[e.jsx(ve,{control:e.jsx(we,{checked:rt,onChange:t=>setUseBestReading(t.target.checked),color:"primary"}),label:"Use Best GPS Reading"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{display:"block",ml:3},children:"Collect multiple GPS readings and use the most accurate one. Improves accuracy but adds slight delay."})]}),e.jsxs(x,{sx:{mb:3},children:[e.jsx(f,{gutterBottom:!0,children:"Minimum Accuracy Threshold (meters)"}),e.jsxs(x,{sx:{display:"flex",alignItems:"center"},children:[e.jsx($e,{value:ke,min:50,max:1e3,step:25,onChange:(t,r)=>setAccuracyThreshold(r),valueLabelDisplay:"auto",valueLabelFormat:t=>`${t}m`,sx:{mr:2,flexGrow:1}}),e.jsxs(f,{children:[ke,"m"]})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:"Positions worse than this accuracy will be rejected. Lower values = better accuracy but fewer location updates."})]}),e.jsxs(x,{sx:{mb:3},children:[e.jsx(f,{gutterBottom:!0,children:"Update Interval (seconds)"}),e.jsxs(x,{sx:{display:"flex",alignItems:"center"},children:[e.jsx($e,{value:ue,min:15,max:120,step:15,onChange:(t,r)=>Oe(r),valueLabelDisplay:"auto",valueLabelFormat:t=>`${t}s`,sx:{mr:2,flexGrow:1}}),e.jsxs(f,{children:[ue,"s"]})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:"Higher values reduce API calls and help prevent rate limiting"})]}),e.jsxs(x,{sx:{mb:3},children:[e.jsx(f,{gutterBottom:!0,children:"Proximity Alert Distance"}),e.jsxs(x,{sx:{display:"flex",alignItems:"center"},children:[e.jsx($e,{value:pe,min:50,max:1e3,step:50,onChange:(t,r)=>Be(r),valueLabelDisplay:"auto",valueLabelFormat:t=>`${t}m`,sx:{mr:2,flexGrow:1}}),e.jsxs(f,{children:[pe,"m"]})]})]}),e.jsx(x,{sx:{mb:3},children:e.jsx(ve,{control:e.jsx(we,{checked:I,onChange:t=>le(t.target.checked),color:"primary"}),label:"Show Proximity Alerts"})}),e.jsxs(x,{sx:{mb:3},children:[e.jsx(f,{gutterBottom:!0,children:"UI Overlay Opacity"}),e.jsxs(x,{sx:{display:"flex",alignItems:"center"},children:[e.jsx($e,{value:$,min:.5,max:1,step:.05,onChange:(t,r)=>Ge(r),valueLabelDisplay:"auto",valueLabelFormat:t=>`${Math.round(t*100)}%`,sx:{mr:2,flexGrow:1}}),e.jsxs(f,{children:[Math.round($*100),"%"]})]})]})]}),e.jsx(Mt,{children:e.jsx(Ye,{onClick:()=>Ne(!1),children:"Close"})})]}),e.jsx(St,{open:Rt,onClose:()=>fe(!1),maxWidth:"sm",fullWidth:!0,children:p&&e.jsxs(e.Fragment,{children:[e.jsx(Lt,{children:p.place?`📍 ${p.username||"Place"}`:`${p.username||"Unknown"}`}),e.jsxs(Ct,{children:[e.jsxs(x,{sx:{display:"flex",flexDirection:"column",alignItems:"center",mb:2},children:[e.jsx(wt,{sx:{width:80,height:80,mb:1,bgcolor:p.place?"success.main":p.user_id===((o==null?void 0:o.id)||"current-user")?"primary.main":"secondary.main"},children:p.place?"📍":p.username?p.username.charAt(0).toUpperCase():"?"}),e.jsx(f,{variant:"h6",children:p.place?p.username||"Unknown Place":p.username||"Unknown"}),e.jsx(f,{variant:"body2",color:"text.secondary",children:p.place?"Saved Location":p.user_id===((o==null?void 0:o.id)||"current-user")?"Your Location":"Group Member"})]}),e.jsxs(x,{children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Location Details"}),e.jsxs(ft,{dense:!0,children:[e.jsx(K,{children:e.jsx(Y,{primary:"Last Updated",secondary:new Date(p.timestamp).toLocaleString()})}),p.coordinates&&e.jsxs(e.Fragment,{children:[e.jsx(K,{children:e.jsx(Y,{primary:"Coordinates",secondary:`${p.coordinates.latitude.toFixed(6)}, ${p.coordinates.longitude.toFixed(6)}`})}),!p.place&&p.coordinates.accuracy&&e.jsx(K,{children:e.jsx(Y,{primary:"Accuracy",secondary:`±${Math.round(p.coordinates.accuracy)} meters`})}),!p.place&&p.coordinates.altitude&&e.jsx(K,{children:e.jsx(Y,{primary:"Altitude",secondary:`${Math.round(p.coordinates.altitude)} meters`})}),!p.place&&p.coordinates.speed>0&&e.jsx(K,{children:e.jsx(Y,{primary:"Speed",secondary:`${Math.round(p.coordinates.speed*3.6)} km/h`})}),!p.place&&i&&e.jsx(K,{children:e.jsx(Y,{primary:"Distance from you",secondary:ht(Je(i.latitude,i.longitude,p.coordinates.latitude,p.coordinates.longitude))})})]}),p.place&&p.raw&&p.raw.address&&e.jsx(K,{children:e.jsx(Y,{primary:"Address",secondary:p.raw.address})}),!p.place&&e.jsx(K,{children:e.jsx(Y,{primary:"Battery Level",secondary:`${p.battery_level||"N/A"}%`})})]})]})]}),e.jsxs(Mt,{children:[e.jsx(Ye,{onClick:()=>fe(!1),children:"Close"}),p.coordinates&&e.jsx(Ye,{color:"primary",onClick:()=>{ye(p.coordinates),fe(!1)},children:"Center on Map"})]})]})})]})};export{eo as default};
