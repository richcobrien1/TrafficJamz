# docker/frontend/Dockerfile.prod
# Dockerfile for building and serving the React/Vite frontend application

# â”€â”€â”€ Stage 1: Build the React/Vite frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FROM node:18-alpine AS builder

WORKDIR /app

# ğŸ“¦ Copy and install frontend dependencies
COPY jamz-client-vite/package*.json ./jamz-client-vite/
WORKDIR /app/jamz-client-vite
RUN npm ci

# ğŸ“ Copy source code and shared modules
COPY jamz-client-vite/src ./src
COPY jamz-client-vite/public ./public
COPY shared ./shared

# ğŸŒ Set build-time environment variables
ENV NODE_ENV=production
ENV REACT_APP_API_URL=/api
ENV REACT_APP_WEBRTC_URL=/webrtc

# ğŸ—ï¸ Build the Vite application
RUN npm run build

# â”€â”€â”€ Stage 2: Serve with NGINX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FROM nginx:stable-alpine

# ğŸ“ Set working directory to NGINXâ€™s default static folder
WORKDIR /usr/share/nginx/html

# ğŸšš Copy compiled frontend build from builder stage
COPY --from=builder /app/jamz-client-vite/build .

# âš™ï¸ Inject custom NGINX configs
COPY docker/frontend/nginx.conf /etc/nginx/nginx.conf
COPY docker/frontend/nginx.dev.conf /etc/nginx/nginx.dev.conf

# ğŸ” TLS-aware entrypoint script
COPY docker/frontend/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# ğŸš€ Start NGINX via wrapper
CMD ["/entrypoint.sh"]

# ğŸ”‰ Expose ports
EXPOSE 443
EXPOSE 80
