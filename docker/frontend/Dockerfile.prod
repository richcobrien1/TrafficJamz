# docker/frontend/Dockerfile.prod
# Dockerfile for building and serving the React/Vite frontend application

# â”€â”€â”€ Stage 1: Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FROM node:18-alpine AS builder

WORKDIR /app

# ğŸ“¦ Install dependencies using package.json and lockfile
COPY docker/frontend/package*.json ./
RUN npm ci

# ğŸ“ Copy source code and static assets
COPY docker/frontend/src ./src
COPY docker/frontend/public ./public

# ğŸŒ Define build-time environment variables for backend integration
ENV NODE_ENV=production
ENV REACT_APP_API_URL=/api
ENV REACT_APP_WEBRTC_URL=/webrtc

# ğŸ—ï¸ Run build process using Vite to produce production artifacts
RUN npm run build

# â”€â”€â”€ Stage 2: Serve with NGINX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FROM nginx:stable-alpine

WORKDIR /usr/share/nginx/html

# ğŸšš Copy compiled frontend assets from build stage
COPY --from=builder /app/dist .

# âš™ï¸ Include both production and dev NGINX configuration files
COPY docker/frontend/nginx.conf /etc/nginx/nginx.conf
COPY docker/frontend/nginx.dev.conf /etc/nginx/nginx.dev.conf

# ğŸ” Inject the TLS-aware entrypoint script from frontend directory
COPY docker/frontend/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# ğŸš€ Launch container using custom entrypoint script
CMD ["/entrypoint.sh"]

# ğŸŒ Expose HTTP and HTTPS ports for container traffic
EXPOSE 80
EXPOSE 443
