# docker/frontend/Dockerfile.prod
# Dockerfile for building and serving the React/Vite frontend application

# ─── Stage 1: Build ─────────────────────────────────────────────────────

FROM node:18-alpine AS builder

WORKDIR /app

# 📦 Install dependencies from root-level manifest
COPY frontend/package*.json ./
RUN npm ci

# 📁 Copy app source from root-level paths
COPY src ./src
COPY public ./public

# 🌐 Set build-time environment variables
ENV NODE_ENV=production
ENV REACT_APP_API_URL=/api
ENV REACT_APP_WEBRTC_URL=/webrtc

# 🏗️ Build the Vite application
RUN npm run build


# ─── Stage 2: Serve with NGINX ───────────────────────────────────────────

FROM nginx:stable-alpine

WORKDIR /usr/share/nginx/html

# 🚚 Transfer compiled assets from builder stage
COPY --from=builder /app/dist .

# ⚙️ Apply config from root-level files
COPY nginx.dev.conf /etc/nginx/nginx.dev.conf

# 🔐 Drop in entrypoint from shared scripts
COPY scripts/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# 🚀 Launch container via TLS-aware entrypoint
CMD ["/entrypoint.sh"]

EXPOSE 80
EXPOSE 443
